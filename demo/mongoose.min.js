!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){exports.Error=require("./error"),exports.Schema=require("./schema"),exports.Types=require("./types"),exports.VirtualType=require("./virtualtype"),exports.SchemaType=require("./schematype.js"),exports.utils=require("./utils.js"),exports.Document=require("./document_provider.js")(),require("./drivers/node-mongodb-native/binary"),"undefined"!=typeof window&&(window.mongoose=module.exports)},{"./document_provider.js":14,"./drivers/node-mongodb-native/binary":15,"./error":17,"./schema":28,"./schematype.js":39,"./types":45,"./utils.js":47,"./virtualtype":48}],2:[function(require,module,exports){function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var length,type=typeof subject;if("number"===type)length=subject>0?subject>>>0:0;else if("string"===type)"base64"===encoding&&(subject=base64clean(subject)),length=Buffer.byteLength(subject,encoding);else{if("object"!==type||null===subject)throw new TypeError("must start with number, buffer, array or string");"Buffer"===subject.type&&isArray(subject.data)&&(subject=subject.data),length=+subject.length>0?Math.floor(+subject.length):0}if(this.length>kMaxLength)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength.toString(16)+" bytes");var buf;Buffer.TYPED_ARRAY_SUPPORT?buf=Buffer._augment(new Uint8Array(length)):(buf=this,buf.length=length,buf._isBuffer=!0);var i;if(Buffer.TYPED_ARRAY_SUPPORT&&"number"==typeof subject.byteLength)buf._set(subject);else if(isArrayish(subject))if(Buffer.isBuffer(subject))for(i=0;length>i;i++)buf[i]=subject.readUInt8(i);else for(i=0;length>i;i++)buf[i]=(subject[i]%256+256)%256;else if("string"===type)buf.write(subject,0,encoding);else if("number"===type&&!Buffer.TYPED_ARRAY_SUPPORT&&!noZero)for(i=0;length>i;i++)buf[i]=0;return buf}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;if(strLen%2!==0)throw new Error("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;length>i;i++){var byte=parseInt(string.substr(2*i,2),16);if(isNaN(byte))throw new Error("Invalid hex string");buf[offset+i]=byte}return i}function utf8Write(buf,string,offset,length){var charsWritten=blitBuffer(utf8ToBytes(string),buf,offset,length);return charsWritten}function asciiWrite(buf,string,offset,length){var charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length);return charsWritten}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){var charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length);return charsWritten}function utf16leWrite(buf,string,offset,length){var charsWritten=blitBuffer(utf16leToBytes(string),buf,offset,length);return charsWritten}function base64Slice(buf,start,end){return base64.fromByteArray(0===start&&end===buf.length?buf:buf.slice(start,end))}function utf8Slice(buf,start,end){var res="",tmp="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)buf[i]<=127?(res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]),tmp=""):tmp+="%"+buf[i].toString(16);return res+decodeUtf8Char(tmp)}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(buf[i]);return ret}function binarySlice(buf,start,end){return asciiSlice(buf,start,end)}function hexSlice(buf,start,end){var len=buf.length;(!start||0>start)&&(start=0),(!end||0>end||end>len)&&(end=len);for(var out="",i=start;end>i;i++)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||0>offset)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError("buffer must be a Buffer instance");if(value>max||min>value)throw new TypeError("value is out of bounds");if(offset+ext>buf.length)throw new TypeError("index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){0>value&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);j>i;i++)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){0>value&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);j>i;i++)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(value>max||min>value)throw new TypeError("value is out of bounds");if(offset+ext>buf.length)throw new TypeError("index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){for(str=stringtrim(str).replace(INVALID_BASE64_RE,"");str.length%4!==0;)str+="=";return str}function stringtrim(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&"object"==typeof subject&&"number"==typeof subject.length}function toHex(n){return 16>n?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(str){for(var byteArray=[],i=0;i<str.length;i++){var b=str.charCodeAt(i);if(127>=b)byteArray.push(b);else{var start=i;b>=55296&&57343>=b&&i++;for(var h=encodeURIComponent(str.slice(start,i+1)).substr(1).split("%"),j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}}return byteArray}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;i++)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str){for(var c,hi,lo,byteArray=[],i=0;i<str.length;i++)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(str)}function blitBuffer(src,dst,offset,length){for(var i=0;length>i&&!(i+offset>=dst.length||i>=src.length);i++)dst[i+offset]=src[i];return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("is-array");exports.Buffer=Buffer,exports.SlowBuffer=Buffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var kMaxLength=1073741823;Buffer.TYPED_ARRAY_SUPPORT=function(){try{var buf=new ArrayBuffer(0),arr=new Uint8Array(buf);return arr.foo=function(){return 42},42===arr.foo()&&"function"==typeof arr.subarray&&0===new Uint8Array(1).subarray(1,1).byteLength}catch(e){return!1}}(),Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);len>i&&a[i]===b[i];i++);return i!==len&&(x=a[i],y=b[i]),y>x?-1:x>y?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,totalLength){if(!isArray(list))throw new TypeError("Usage: Buffer.concat(list[, length])");if(0===list.length)return new Buffer(0);if(1===list.length)return list[0];var i;if(void 0===totalLength)for(totalLength=0,i=0;i<list.length;i++)totalLength+=list[i].length;var buf=new Buffer(totalLength),pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos),pos+=item.length}return buf},Buffer.byteLength=function(str,encoding){var ret;switch(str+="",encoding||"utf8"){case"ascii":case"binary":case"raw":ret=str.length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=2*str.length;break;case"hex":ret=str.length>>>1;break;case"utf8":case"utf-8":ret=utf8ToBytes(str).length;break;case"base64":ret=base64ToBytes(str).length;break;default:ret=str.length}return ret},Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0,Buffer.prototype.toString=function(encoding,start,end){var loweredCase=!1;if(start>>>=0,end=void 0===end||1/0===end?this.length:end>>>0,encoding||(encoding="utf8"),0>start&&(start=0),end>this.length&&(end=this.length),start>=end)return"";for(;;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"binary":return binarySlice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return 0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return Buffer.compare(this,b)},Buffer.prototype.get=function(offset){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(offset)},Buffer.prototype.set=function(v,offset){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(v,offset)},Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset))isFinite(length)||(encoding=length,length=void 0);else{var swap=encoding;encoding=offset,offset=length,length=swap}offset=Number(offset)||0;var remaining=this.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining,encoding=String(encoding||"utf8").toLowerCase();var ret;switch(encoding){case"hex":ret=hexWrite(this,string,offset,length);break;case"utf8":case"utf-8":ret=utf8Write(this,string,offset,length);break;case"ascii":ret=asciiWrite(this,string,offset,length);break;case"binary":ret=binaryWrite(this,string,offset,length);break;case"base64":ret=base64Write(this,string,offset,length);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=utf16leWrite(this,string,offset,length);break;default:throw new TypeError("Unknown encoding: "+encoding)}return ret},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},Buffer.prototype.slice=function(start,end){var len=this.length;if(start=~~start,end=void 0===end?len:~~end,0>start?(start+=len,0>start&&(start=0)):start>len&&(start=len),0>end?(end+=len,0>end&&(end=0)):end>len&&(end=len),start>end&&(end=start),Buffer.TYPED_ARRAY_SUPPORT)return Buffer._augment(this.subarray(start,end));for(var sliceLen=end-start,newBuf=new Buffer(sliceLen,void 0,!0),i=0;sliceLen>i;i++)newBuf[i]=this[i+start];return newBuf},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),0>value&&(value=255+value+1),this[offset]=value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset>>>=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),0>value&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,target_start,start,end){var source=this;if(start||(start=0),end||0===end||(end=this.length),target_start||(target_start=0),end!==start&&0!==target.length&&0!==source.length){if(start>end)throw new TypeError("sourceEnd < sourceStart");if(0>target_start||target_start>=target.length)throw new TypeError("targetStart out of bounds");if(0>start||start>=source.length)throw new TypeError("sourceStart out of bounds");if(0>end||end>source.length)throw new TypeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-target_start<end-start&&(end=target.length-target_start+start);var len=end-start;if(100>len||!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;len>i;i++)target[i+target_start]=this[i+start];else target._set(this.subarray(start,start+len),target_start)}},Buffer.prototype.fill=function(value,start,end){if(value||(value=0),start||(start=0),end||(end=this.length),start>end)throw new TypeError("end < start");if(end!==start&&0!==this.length){if(0>start||start>=this.length)throw new TypeError("start out of bounds");if(0>end||end>this.length)throw new TypeError("end out of bounds");var i;if("number"==typeof value)for(i=start;end>i;i++)this[i]=value;else{var bytes=utf8ToBytes(value.toString()),len=bytes.length;for(i=start;end>i;i++)this[i]=bytes[i%len]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var buf=new Uint8Array(this.length),i=0,len=buf.length;len>i;i+=1)buf[i]=this[i];return buf.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(arr){return arr._isBuffer=!0,arr._get=arr.get,arr._set=arr.set,arr.get=BP.get,arr.set=BP.set,arr.write=BP.write,arr.toString=BP.toString,arr.toLocaleString=BP.toString,arr.toJSON=BP.toJSON,arr.equals=BP.equals,arr.compare=BP.compare,arr.copy=BP.copy,arr.slice=BP.slice,arr.readUInt8=BP.readUInt8,arr.readUInt16LE=BP.readUInt16LE,arr.readUInt16BE=BP.readUInt16BE,arr.readUInt32LE=BP.readUInt32LE,arr.readUInt32BE=BP.readUInt32BE,arr.readInt8=BP.readInt8,arr.readInt16LE=BP.readInt16LE,arr.readInt16BE=BP.readInt16BE,arr.readInt32LE=BP.readInt32LE,arr.readInt32BE=BP.readInt32BE,arr.readFloatLE=BP.readFloatLE,arr.readFloatBE=BP.readFloatBE,arr.readDoubleLE=BP.readDoubleLE,arr.readDoubleBE=BP.readDoubleBE,arr.writeUInt8=BP.writeUInt8,arr.writeUInt16LE=BP.writeUInt16LE,arr.writeUInt16BE=BP.writeUInt16BE,arr.writeUInt32LE=BP.writeUInt32LE,arr.writeUInt32BE=BP.writeUInt32BE,arr.writeInt8=BP.writeInt8,arr.writeInt16LE=BP.writeInt16LE,arr.writeInt16BE=BP.writeInt16BE,arr.writeInt32LE=BP.writeInt32LE,arr.writeInt32BE=BP.writeInt32BE,arr.writeFloatLE=BP.writeFloatLE,arr.writeFloatBE=BP.writeFloatBE,arr.writeDoubleLE=BP.writeDoubleLE,arr.writeDoubleBE=BP.writeDoubleBE,arr.fill=BP.fill,arr.inspect=BP.inspect,arr.toArrayBuffer=BP.toArrayBuffer,arr};var INVALID_BASE64_RE=/[^+\/0-9A-z]/g},{"base64-js":3,ieee754:4,"is-array":5}],3:[function(require,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(exports){"use strict";function decode(elt){var code=elt.charCodeAt(0);return code===PLUS?62:code===SLASH?63:NUMBER>code?-1:NUMBER+10>code?code-NUMBER+26+26:UPPER+26>code?code-UPPER:LOWER+26>code?code-LOWER+26:void 0}function b64ToByteArray(b64){function push(v){arr[L++]=v}var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0,arr=new Arr(3*b64.length/4-placeHolders),l=placeHolders>0?b64.length-4:b64.length;var L=0;for(i=0,j=0;l>i;i+=4,j+=3)tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3)),push((16711680&tmp)>>16),push((65280&tmp)>>8),push(255&tmp);return 2===placeHolders?(tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4,push(255&tmp)):1===placeHolders&&(tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2,push(tmp>>8&255),push(255&tmp)),arr}function uint8ToBase64(uint8){function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(63&num)}var i,temp,length,extraBytes=uint8.length%3,output="";for(i=0,length=uint8.length-extraBytes;length>i;i+=3)temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2],output+=tripletToBase64(temp);switch(extraBytes){case 1:temp=uint8[uint8.length-1],output+=encode(temp>>2),output+=encode(temp<<4&63),output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1],output+=encode(temp>>10),output+=encode(temp>>4&63),output+=encode(temp<<2&63),output+="="}return output}var Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,PLUS="+".charCodeAt(0),SLASH="/".charCodeAt(0),NUMBER="0".charCodeAt(0),LOWER="a".charCodeAt(0),UPPER="A".charCodeAt(0);exports.toByteArray=b64ToByteArray,exports.fromByteArray=uint8ToBase64}("undefined"==typeof exports?this.base64js={}:exports)},{}],4:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?0/0:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=0>value||0===value&&0>1/value?1:0;for(value=Math.abs(value),isNaN(value)||1/0===value?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],5:[function(require,module){var isArray=Array.isArray,str=Object.prototype.toString;module.exports=isArray||function(val){return!!val&&"[object Array]"==str.call(val)}},{}],6:[function(require,module){function EventEmitter(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function isFunction(arg){return"function"==typeof arg}function isNumber(arg){return"number"==typeof arg}function isObject(arg){return"object"==typeof arg&&null!==arg}function isUndefined(arg){return void 0===arg}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||0>n||isNaN(n))throw TypeError("n must be a positive number");return this._maxListeners=n,this},EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(this._events||(this._events={}),"error"===type&&(!this._events.error||isObject(this._events.error)&&!this._events.error.length)){if(er=arguments[1],er instanceof Error)throw er;throw TypeError('Uncaught, unspecified "error" event.')}if(handler=this._events[type],isUndefined(handler))return!1;if(isFunction(handler))switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];handler.apply(this,args)}else if(isObject(handler)){for(len=arguments.length,args=new Array(len-1),i=1;len>i;i++)args[i-1]=arguments[i];for(listeners=handler.slice(),len=listeners.length,i=0;len>i;i++)listeners[i].apply(this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener),this._events[type]?isObject(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener,isObject(this._events[type])&&!this._events[type].warned){var m;m=isUndefined(this._maxListeners)?EventEmitter.defaultMaxListeners:this._maxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),"function"==typeof console.trace&&console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){this.removeListener(type,g),fired||(fired=!0,listener.apply(this,arguments))}if(!isFunction(listener))throw TypeError("listener must be a function");var fired=!1;return g.listener=listener,this.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;if(list=this._events[type],length=list.length,position=-1,list===listener||isFunction(list.listener)&&list.listener===listener)delete this._events[type],this._events.removeListener&&this.emit("removeListener",type,listener);else if(isObject(list)){for(i=length;i-->0;)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(0>position)return this;1===list.length?(list.length=0,delete this._events[type]):list.splice(position,1),this._events.removeListener&&this.emit("removeListener",type,listener)}return this},EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[type]&&delete this._events[type],this;if(0===arguments.length){for(key in this._events)"removeListener"!==key&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events={},this}if(listeners=this._events[type],isFunction(listeners))this.removeListener(type,listeners);else for(;listeners.length;)this.removeListener(type,listeners[listeners.length-1]);return delete this._events[type],this},EventEmitter.prototype.listeners=function(type){var ret;return ret=this._events&&this._events[type]?isFunction(this._events[type])?[this._events[type]]:this._events[type].slice():[]},EventEmitter.listenerCount=function(emitter,type){var ret;return ret=emitter._events&&emitter._events[type]?isFunction(emitter._events[type])?1:emitter._events[type].length:0}},{}],7:[function(require,module){module.exports="function"==typeof Object.create?function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],8:[function(require,module){function noop(){}var process=module.exports={};process.nextTick=function(){var canSetImmediate="undefined"!=typeof window&&window.setImmediate,canPost="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(canSetImmediate)return function(f){return window.setImmediate(f)};if(canPost){var queue=[];return window.addEventListener("message",function(ev){var source=ev.source;if((source===window||null===source)&&"process-tick"===ev.data&&(ev.stopPropagation(),queue.length>0)){var fn=queue.shift();fn()}},!0),function(fn){queue.push(fn),window.postMessage("process-tick","*")}}return function(fn){setTimeout(fn,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(){throw new Error("process.chdir is not supported")}},{}],9:[function(require,module){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],10:[function(require,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str){return str}function arrayToHash(array){var hash={};return array.forEach(function(val){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");
if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(0>recurseTimes)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;l>i;++i)output.push(hasOwnProperty(value,String(i))?formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0):"");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return 10>n?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];len>i;x=args[++i])str+=isNull(x)||!isObject(x)?" "+x:" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)};if(process.noDeprecation===!0)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":9,_process:8,inherits:7}],11:[function(require,module,exports){function Document(obj,schema,fields,skipId,skipInit){if(!(this instanceof Document))return new Document(obj,schema,fields,skipId,skipInit);if(!utils.isObject(schema)||schema instanceof Schema||(schema=new Schema(schema)),schema=this.schema||schema,!this.schema&&schema.options._id&&(obj=obj||{},void 0===obj._id&&(obj._id=new ObjectId)),!schema)throw new MongooseError.MissingSchemaError;this.$__setSchema(schema),this.$__=new InternalCache,this.isNew=!0,this.errors=void 0,"boolean"==typeof fields?(this.$__.strictMode=fields,fields=void 0):(this.$__.strictMode=this.schema.options&&this.schema.options.strict,this.$__.selected=fields);for(var required=this.schema.requiredPaths(),i=0;i<required.length;++i)this.$__.activePaths.require(required[i]);setMaxListeners.call(this,0),this._doc=this.$__buildDoc(obj,fields,skipId),!skipInit&&obj&&this.init(obj),this.$__registerHooksFromSchema();for(var m in schema.methods)this[m]=schema.methods[m];for(var s in schema.statics)this[s]=schema.statics[s]}{var NodeJSDocument=require("./document"),EventEmitter=require("events").EventEmitter,setMaxListeners=EventEmitter.prototype.setMaxListeners,MongooseError=require("./error"),Schema=(require("./schema/mixed"),require("./schema")),ObjectId=require("./types/objectid"),utils=(require("./schematype").ValidatorError,require("./utils")),ValidationError=(utils.clone,utils.isMongooseObject,require("util").inspect,MongooseError.ValidationError),InternalCache=require("./internal");utils.deepEqual,require("hooks"),require("./promise")}Document.prototype=Object.create(NodeJSDocument.prototype),Document.prototype.constructor=Document,Document.ValidationError=ValidationError,module.exports=exports=Document},{"./document":13,"./error":17,"./internal":26,"./promise":27,"./schema":28,"./schema/mixed":35,"./schematype":39,"./types/objectid":46,"./utils":47,events:6,hooks:49,util:10}],12:[function(require,module){var utils=require("./utils"),Types=require("./schema/index"),cast=module.exports=function(schema,obj){for(var any$conditionals,schematype,nested,path,type,val,paths=Object.keys(obj),i=paths.length;i--;)if(path=paths[i],val=obj[path],"$or"===path||"$nor"===path||"$and"===path)for(var k=val.length;k--;)val[k]=cast(schema,val[k]);else{if("$where"===path){if(type=typeof val,"string"!==type&&"function"!==type)throw new Error("Must have a string or function for $where");"function"===type&&(obj[path]=val.toString());continue}if(!schema)continue;if(schematype=schema.path(path)){if(null===val||void 0===val)continue;if("Object"===val.constructor.name)if(any$conditionals=Object.keys(val).some(function(k){return"$"===k.charAt(0)&&"$id"!==k&&"$ref"!==k})){for(var $cond,ks=Object.keys(val),k=ks.length;k--;)if($cond=ks[k],nested=val[$cond],"$exists"!==$cond){if("$type"!==$cond)"$not"===$cond?cast(schema,nested):val[$cond]=schematype.castForQuery($cond,nested);else if("number"!=typeof nested)throw new Error("$type parameter must be Number")}else if("boolean"!=typeof nested)throw new Error("$exists parameter must be Boolean")}else obj[path]=schematype.castForQuery(val);else obj[path]=schematype.castForQuery(val)}else{for(var pathFirstHalf,pathLastHalf,remainingConds,split=path.split("."),j=split.length;j--&&(pathFirstHalf=split.slice(0,j).join("."),!(schematype=schema.path(pathFirstHalf))););if(schematype){schematype.caster&&schematype.caster.schema?(remainingConds={},pathLastHalf=split.slice(j).join("."),remainingConds[pathLastHalf]=val,obj[path]=cast(schematype.caster.schema,remainingConds)[pathLastHalf]):obj[path]=val;continue}if(utils.isObject(val)){var geo=val.$near?"$near":val.$nearSphere?"$nearSphere":val.$within?"$within":val.$geoIntersects?"$geoIntersects":"";if(!geo)continue;var numbertype=new Types.Number("__QueryCasting__"),value=val[geo];if(val.$maxDistance&&(val.$maxDistance=numbertype.castForQuery(val.$maxDistance)),"$within"==geo){var withinType=value.$center||value.$centerSphere||value.$box||value.$polygon;if(!withinType)throw new Error("Bad $within paramater: "+JSON.stringify(val));value=withinType}else"$near"==geo&&"string"==typeof value.type&&Array.isArray(value.coordinates)?value=value.coordinates:("$near"==geo||"$nearSphere"==geo||"$geoIntersects"==geo)&&value.$geometry&&"string"==typeof value.$geometry.type&&Array.isArray(value.$geometry.coordinates)&&(value=value.$geometry.coordinates);!function _cast(val){if(Array.isArray(val))val.forEach(function(item,i){return Array.isArray(item)||utils.isObject(item)?_cast(item):void(val[i]=numbertype.castForQuery(item))});else for(var nearKeys=Object.keys(val),nearLen=nearKeys.length;nearLen--;){var nkey=nearKeys[nearLen],item=val[nkey];Array.isArray(item)||utils.isObject(item)?(_cast(item),val[nkey]=item):val[nkey]=numbertype.castForQuery(item)}}(value)}}}return obj}},{"./schema/index":34,"./utils":47}],13:[function(require,module,exports){(function(process){function Document(obj,fields,skipId){this.$__=new InternalCache,this.isNew=!0,this.errors=void 0;var schema=this.schema;"boolean"==typeof fields?(this.$__.strictMode=fields,fields=void 0):(this.$__.strictMode=schema.options&&schema.options.strict,this.$__.selected=fields);for(var required=schema.requiredPaths(),i=0;i<required.length;++i)this.$__.activePaths.require(required[i]);setMaxListeners.call(this,0),this._doc=this.$__buildDoc(obj,fields,skipId),obj&&this.set(obj,void 0,!0),this.$__registerHooksFromSchema()}function init(self,obj,doc,prefix){prefix=prefix||"";for(var schema,path,i,keys=Object.keys(obj),len=keys.length;len--;)i=keys[len],path=prefix+i,schema=self.schema.path(path),schema||!utils.isObject(obj[i])||obj[i].constructor&&"Object"!=utils.getFunctionName(obj[i].constructor)?(null===obj[i]?doc[i]=null:void 0!==obj[i]&&(schema?self.$__try(function(){doc[i]=schema.cast(obj[i],self,!0)}):doc[i]=obj[i]),self.$__.activePaths.init(path)):(doc[i]||(doc[i]={}),init(self,obj[i],doc[i],path+"."))}function compile(tree,proto,prefix){for(var limb,key,keys=Object.keys(tree),i=keys.length;i--;)key=keys[i],limb=tree[key],define(key,"Object"!==utils.getFunctionName(limb.constructor)||!Object.keys(limb).length||limb.type&&!limb.type.type?null:limb,proto,prefix,keys)}function getOwnPropertyDescriptors(object){var result={};return Object.getOwnPropertyNames(object).forEach(function(key){result[key]=Object.getOwnPropertyDescriptor(object,key),result[key].enumerable=!1}),result}function define(prop,subprops,prototype,prefix,keys){var prefix=prefix||"",path=(prefix?prefix+".":"")+prop;subprops?Object.defineProperty(prototype,prop,{enumerable:!0,configurable:!0,get:function(){if(this.$__.getters||(this.$__.getters={}),!this.$__.getters[path]){var nested=Object.create(Object.getPrototypeOf(this),getOwnPropertyDescriptors(this));prefix||(nested.$__.scope=this);for(var i=0,len=keys.length;len>i;++i)Object.defineProperty(nested,keys[i],{enumerable:!1,writable:!0,configurable:!0,value:void 0});nested.toObject=function(){return this.get(path)},compile(subprops,nested,path),this.$__.getters[path]=nested}return this.$__.getters[path]},set:function(v){return v instanceof Document&&(v=v.toObject()),(this.$__.scope||this).set(path,v)}}):Object.defineProperty(prototype,prop,{enumerable:!0,configurable:!0,get:function(){return this.get.call(this.$__.scope||this,path)},set:function(v){return this.set.call(this.$__.scope||this,path,v)}})}function minimize(obj){for(var hasKeys,key,val,keys=Object.keys(obj),i=keys.length;i--;)key=keys[i],val=obj[key],utils.isObject(val)&&(obj[key]=minimize(val)),void 0!==obj[key]?hasKeys=!0:delete obj[key];return hasKeys?obj:void 0}function applyGetters(self,json,type,options){for(var path,schema=self.schema,paths=Object.keys(schema[type]),i=paths.length;i--;){path=paths[i];for(var part,parts=path.split("."),plen=parts.length,last=plen-1,branch=json,ii=0;plen>ii;++ii)part=parts[ii],ii===last?branch[part]=clone(self.get(path),options):branch=branch[part]||(branch[part]={})}return json}var DocumentArray,MongooseArray,Embedded,EventEmitter=require("events").EventEmitter,setMaxListeners=EventEmitter.prototype.setMaxListeners,MongooseError=require("./error"),MixedSchema=require("./schema/mixed"),Schema=require("./schema"),ValidatorError=(require("./types/objectid"),require("./schematype").ValidatorError),utils=require("./utils"),clone=utils.clone,isMongooseObject=utils.isMongooseObject,inspect=require("util").inspect,ValidationError=MongooseError.ValidationError,InternalCache=require("./internal"),deepEqual=utils.deepEqual,hooks=require("hooks"),Promise=require("./promise");Document.prototype=Object.create(EventEmitter.prototype),Document.prototype.constructor=Document,Document.prototype.schema,Document.prototype.isNew,Document.prototype.id,Document.prototype.errors,Document.prototype.$__buildDoc=function(obj,fields,skipId){var exclude,keys,ki,doc={},self=this;if(fields&&"Object"===utils.getFunctionName(fields.constructor))for(keys=Object.keys(fields),ki=keys.length;ki--;)if("_id"!==keys[ki]){exclude=0===fields[keys[ki]];break}for(var paths=Object.keys(this.schema.paths),plen=paths.length,ii=0;plen>ii;++ii){var p=paths[ii];if("_id"==p){if(skipId)continue;if(obj&&"_id"in obj)continue}for(var type=this.schema.paths[p],path=p.split("."),len=path.length,last=len-1,curPath="",doc_=doc,i=0;len>i;++i){var def,piece=path[i];if(exclude){if(curPath+=piece,curPath in fields)break;curPath+="."}if(i===last)if(fields)if(exclude){if(p in fields)continue;def=type.getDefault(self,!0),"undefined"!=typeof def&&(doc_[piece]=def,self.$__.activePaths.default(p))}else p in fields&&(def=type.getDefault(self,!0),"undefined"!=typeof def&&(doc_[piece]=def,self.$__.activePaths.default(p)));else def=type.getDefault(self,!0),"undefined"!=typeof def&&(doc_[piece]=def,self.$__.activePaths.default(p));else doc_=doc_[piece]||(doc_[piece]={})}}return doc},Document.prototype.init=function(doc,opts,fn){if("function"==typeof opts&&(fn=opts,opts=null),this.isNew=!1,doc._id&&opts&&opts.populated&&opts.populated.length)for(var id=String(doc._id),i=0;i<opts.populated.length;++i){var item=opts.populated[i];this.populated(item.path,item._docs[id],item)}return init(this,doc,this._doc),this.$__storeShard(),this.emit("init",this),fn&&fn(null),this},Document.prototype.$__storeShard=function(){var key=this.schema.options.shardKey||this.schema.options.shardkey;if(key&&"Object"==utils.getFunctionName(key.constructor))for(var val,orig=this.$__.shardval={},paths=Object.keys(key),len=paths.length,i=0;len>i;++i)val=this.getValue(paths[i]),orig[paths[i]]=isMongooseObject(val)?val.toObject({depopulate:!0}):null==val||!val.valueOf||val.constructor&&"Date"===utils.getFunctionName(val.constructor)?val:val.valueOf()};for(var k in hooks)Document.prototype[k]=Document[k]=hooks[k];Document.prototype.update=function(){var args=utils.args(arguments);return args.unshift({_id:this._id}),this.constructor.update.apply(this.constructor,args)},Document.prototype.set=function(path,val,type,options){type&&"Object"==utils.getFunctionName(type.constructor)&&(options=type,type=void 0);var adhocs,merge=options&&options.merge,adhoc=type&&!0!==type,constructing=!0===type,strict=options&&"strict"in options?options.strict:this.$__.strictMode;if(adhoc&&(adhocs=this.$__.adhocPaths||(this.$__.adhocPaths={}),adhocs[path]=Schema.interpretAsType(path,type)),"string"!=typeof path){if(null!==path&&void 0!==path){var prefix=val?val+".":"";path instanceof Document&&(path=path._doc);for(var pathtype,key,keys=Object.keys(path),i=keys.length;i--;)if(key=keys[i],pathtype=this.schema.pathType(prefix+key),null==path[key]||!utils.isObject(path[key])||path[key].constructor&&"Object"!=utils.getFunctionName(path[key].constructor)||"virtual"==pathtype||this.$__path(prefix+key)instanceof MixedSchema||this.schema.paths[key]&&this.schema.paths[key].options.ref)if(strict){if("real"===pathtype||"virtual"===pathtype)this.set(prefix+key,path[key],constructing);else if("throw"==strict)throw new Error("Field `"+key+"` is not in schema.")}else void 0!==path[key]&&this.set(prefix+key,path[key],constructing);else this.set(path[key],prefix+key,constructing);return this}var _=path;path=val,val=_}var pathType=this.schema.pathType(path);if("nested"==pathType&&val&&utils.isObject(val)&&(!val.constructor||"Object"==utils.getFunctionName(val.constructor)))return merge||this.setValue(path,null),this.set(val,path,constructing),this;var schema,parts=path.split(".");if("adhocOrUndefined"==pathType&&strict){for(var mixed,i=0;i<parts.length;++i){var subpath=parts.slice(0,i+1).join(".");if(schema=this.schema.path(subpath),schema instanceof MixedSchema){mixed=!0;break}}if(!mixed){if("throw"==strict)throw new Error("Field `"+path+"` is not in schema.");return this}}else{if("virtual"==pathType)return schema=this.schema.virtualpath(path),schema.applySetters(val,this),this;schema=this.$__path(path)}var pathToMark;if(parts.length<=1)pathToMark=path;else{for(var i=0;i<parts.length;++i){var subpath=parts.slice(0,i+1).join(".");if(this.isDirectModified(subpath)||null===this.get(subpath)){pathToMark=subpath;break}}pathToMark||(pathToMark=path)}var priorVal=constructing?void 0:this.getValue(path);if(!schema||void 0===val)return this.$__set(pathToMark,path,constructing,parts,schema,val,priorVal),this;var self=this,shouldSet=this.$__try(function(){val=schema.applySetters(val,self,!1,priorVal)});return shouldSet&&this.$__set(pathToMark,path,constructing,parts,schema,val,priorVal),this},Document.prototype.$__shouldModify=function(pathToMark,path,constructing,parts,schema,val,priorVal){return this.isNew?!0:void 0!==val||this.isSelected(path)?void 0===val&&path in this.$__.activePaths.states.default?!1:deepEqual(val,priorVal||this.get(path))?!constructing&&null!=val&&path in this.$__.activePaths.states.default&&deepEqual(val,schema.getDefault(this,constructing))?!0:!1:!0:!0},Document.prototype.$__set=function(pathToMark,path,constructing,parts,schema,val){Embedded=Embedded||require("./types/embedded");var shouldModify=this.$__shouldModify.apply(this,arguments),_this=this;shouldModify&&(this.markModified(pathToMark,val),MongooseArray||(MongooseArray=require("./types/array")),val&&val.isMongooseArray&&(val._registerAtomic("$set",val),this.$__.activePaths.forEach(function(modifiedPath){0===modifiedPath.indexOf(path)&&modifiedPath!==path&&_this.$__.activePaths.ignore(modifiedPath)})));for(var obj=this._doc,i=0,l=parts.length;l>i;i++){var next=i+1,last=next===l;last?obj[parts[i]]=val:obj=obj[parts[i]]&&"Object"===utils.getFunctionName(obj[parts[i]].constructor)?obj[parts[i]]:obj[parts[i]]&&obj[parts[i]]instanceof Embedded?obj[parts[i]]:obj[parts[i]]&&Array.isArray(obj[parts[i]])?obj[parts[i]]:obj[parts[i]]={}}},Document.prototype.getValue=function(path){return utils.getValue(path,this._doc)},Document.prototype.setValue=function(path,val){return utils.setValue(path,val,this._doc),this},Document.prototype.get=function(path,type){var adhocs;type&&(adhocs=this.$__.adhocPaths||(this.$__.adhocPaths={}),adhocs[path]=Schema.interpretAsType(path,type));for(var schema=this.$__path(path)||this.schema.virtualpath(path),pieces=path.split("."),obj=this._doc,i=0,l=pieces.length;l>i;i++)obj=void 0===obj||null===obj?void 0:obj[pieces[i]];return schema&&(obj=schema.applyGetters(obj,this)),obj},Document.prototype.$__path=function(path){var adhocs=this.$__.adhocPaths,adhocType=adhocs&&adhocs[path];return adhocType?adhocType:this.schema.path(path)},Document.prototype.markModified=function(path){this.$__.activePaths.modify(path)},Document.prototype.$__try=function(fn,scope){var res;try{fn.call(scope),res=!0}catch(e){this.$__error(e),res=!1}return res},Document.prototype.modifiedPaths=function(){var directModifiedPaths=Object.keys(this.$__.activePaths.states.modify);return directModifiedPaths.reduce(function(list,path){var parts=path.split(".");return list.concat(parts.reduce(function(chains,part,i){return chains.concat(parts.slice(0,i).concat(part).join("."))},[]))},[])},Document.prototype.isModified=function(path){return path?!!~this.modifiedPaths().indexOf(path):this.$__.activePaths.some("modify")},Document.prototype.isDirectModified=function(path){return path in this.$__.activePaths.states.modify},Document.prototype.isInit=function(path){return path in this.$__.activePaths.states.init},Document.prototype.isSelected=function(path){if(this.$__.selected){if("_id"===path)return 0!==this.$__.selected._id;var cur,paths=Object.keys(this.$__.selected),i=paths.length,inclusive=!1;if(1===i&&"_id"===paths[0])return 0===this.$__.selected._id;for(;i--;)if(cur=paths[i],"_id"!=cur){inclusive=!!this.$__.selected[cur];break}if(path in this.$__.selected)return inclusive;i=paths.length;for(var pathDot=path+".";i--;)if(cur=paths[i],"_id"!=cur){if(0===cur.indexOf(pathDot))return inclusive;if(0===pathDot.indexOf(cur+"."))return inclusive}return!inclusive}return!0},Document.prototype.validate=function(cb){function validatePath(path){validating[path]||(validating[path]=!0,total++,process.nextTick(function(){var p=self.schema.path(path);if(!p)return--total||complete();var val=self.getValue(path);p.doValidate(val,function(err){err&&self.invalidate(path,err,void 0,!0),--total||complete()},self)}))}function complete(){var err=self.$__.validationError;self.$__.validationError=void 0,self.emit("validate",self),err?promise.reject(err):promise.fulfill()}var self=this,promise=new Promise(cb),paths=Object.keys(this.$__.activePaths.states.require).filter(function(path){return self.isSelected(path)||self.isModified(path)?!0:!1});if(paths=paths.concat(Object.keys(this.$__.activePaths.states.init)),paths=paths.concat(Object.keys(this.$__.activePaths.states.modify)),paths=paths.concat(Object.keys(this.$__.activePaths.states.default)),0===paths.length)return process.nextTick(function(){complete()}),promise;var validating={},total=0;return paths.forEach(validatePath),promise},Document.prototype.invalidate=function(path,err,val){this.$__.validationError||(this.$__.validationError=new ValidationError(this)),err&&"string"!=typeof err||(err=new ValidatorError({path:path,message:err,type:"user defined",value:val})),this.$__.validationError!=err&&(this.$__.validationError.errors[path]=err)},Document.prototype.$__reset=function(){var self=this;DocumentArray||(DocumentArray=require("./types/documentarray")),this.$__.activePaths.map("init","modify",function(i){return self.getValue(i)}).filter(function(val){return val&&val instanceof Array&&val.isMongooseDocumentArray&&val.length}).forEach(function(array){for(var i=array.length;i--;){var doc=array[i];doc&&doc.$__reset()}}),this.$__dirty().forEach(function(dirt){var type=dirt.value;type&&type._atomics&&(type._atomics={})}),this.$__.activePaths.clear("modify"),this.$__.validationError=void 0,this.errors=void 0;var self=this;return this.schema.requiredPaths().forEach(function(path){self.$__.activePaths.require(path)}),this},Document.prototype.$__dirty=function(){var self=this,all=this.$__.activePaths.map("modify",function(path){return{path:path,value:self.getValue(path),schema:self.$__path(path)}});all.sort(function(a,b){return a.path<b.path?-1:a.path>b.path?1:0});var lastPath,top,minimal=[];return all.forEach(function(item){0!==item.path.indexOf(lastPath)?(lastPath=item.path+".",minimal.push(item),top=item):top.value&&top.value._atomics&&top.value.hasAtomics()&&(top.value._atomics={},top.value._atomics.$set=top.value)}),top=lastPath=null,minimal},Document.prototype.$__setSchema=function(schema){compile(schema.tree,this),this.schema=schema},Document.prototype.$__getArrayPathsToValidate=function(){return DocumentArray||(DocumentArray=require("./types/documentarray")),this.$__.activePaths.map("init","modify",function(i){return this.getValue(i)}.bind(this)).filter(function(val){return val&&val instanceof Array&&val.isMongooseDocumentArray&&val.length}).reduce(function(seed,array){return seed.concat(array)},[]).filter(function(doc){return doc})},Document.prototype.$__getAllSubdocs=function(){function docReducer(seed,path){var val=this[path];return val instanceof Embedded&&seed.push(val),val&&val.isMongooseDocumentArray&&val.forEach(function(doc){doc&&doc._doc&&(doc instanceof Embedded&&seed.push(doc),seed=Object.keys(doc._doc).reduce(docReducer.bind(doc._doc),seed))}),seed}DocumentArray||(DocumentArray=require("./types/documentarray")),Embedded=Embedded||require("./types/embedded");var subDocs=Object.keys(this._doc).reduce(docReducer.bind(this),[]);return subDocs},Document.prototype.$__presaveValidate=function(){var docs=this.$__getArrayPathsToValidate(),e2=docs.map(function(doc){return doc.$__presaveValidate()}),e1=[this.$__.saveError].concat(e2),err=e1.filter(function(x){return x})[0];return this.$__.saveError=null,err},Document.prototype.$__error=function(err){return this.$__.saveError=err,this},Document.prototype.$__registerHooksFromSchema=function(){Embedded=Embedded||require("./types/embedded");var self=this,q=self.schema&&self.schema.callQueue;if(!q.length)return self;var toWrap=q.reduce(function(seed,pair){var args=[].slice.call(pair[1]),pointCut="on"===pair[0]?"post":args[0];return pointCut in seed||(seed[pointCut]=[]),seed[pointCut].push(args),seed},{post:[]});return toWrap.post.forEach(function(args){self.on.apply(self,args)}),delete toWrap.post,Object.keys(toWrap).forEach(function(pointCut){if(~"set ".indexOf(pointCut))return void toWrap[pointCut].forEach(function(args){self.pre.apply(self,args)});var newName="$__original_"+pointCut;self[newName]=self[pointCut],self[pointCut]=function(){var args=[].slice.call(arguments),lastArg=args.pop(),wrapingPromise=new Promise;return wrapingPromise.end(),"function"==typeof lastArg&&wrapingPromise.onResolve(lastArg),this instanceof Embedded||wrapingPromise.hasRejectListeners()||wrapingPromise.onReject(self.$__handleReject.bind(self)),args.push(function(){return wrapingPromise.resolve.apply(wrapingPromise,arguments)}),self[newName].apply(self,args),wrapingPromise},toWrap[pointCut].forEach(function(args){args[0]=newName,self.pre.apply(self,args)})}),self},Document.prototype.$__handleReject=function(err){if(this.listeners("error").length)this.emit("error",err);else if(this.constructor.listeners&&this.constructor.listeners("error").length)this.constructor.emit("error",err);else if(this.listeners&&this.listeners("error").length)this.emit("error",err);else{if(!this.db)throw err;this.db.listeners("error").length||(err.stack="No listeners detected, throwing. Consider adding an error listener to your connection.\n"+err.stack),this.db.emit("error",err)}},Document.prototype.toObject=function(options){if(options&&options.depopulate&&this.$__.wasPopulated)return clone(this._id,options);var optionsParameter=options;(!options||"Object"!=utils.getFunctionName(options.constructor)||options&&options._useSchemaOptions)&&(options=this.schema.options.toObject?clone(this.schema.options.toObject):{}),"minimize"in options||(options.minimize=this.schema.options.minimize),optionsParameter||(options._useSchemaOptions=!0);var ret=clone(this._doc,options);if((options.virtuals||options.getters&&!1!==options.virtuals)&&applyGetters(this,ret,"virtuals",options),options.getters&&(applyGetters(this,ret,"paths",options),options.minimize&&(ret=minimize(ret)||{})),!0===options.transform||this.schema.options.toObject&&options.transform){var opts=options.json?this.schema.options.toJSON:this.schema.options.toObject;opts&&(options.transform=opts.transform)}if("function"==typeof options.transform){var xformed=options.transform(this,ret,options);"undefined"!=typeof xformed&&(ret=xformed)}return ret},Document.prototype.toJSON=function(options){return(!options||"Object"!=utils.getFunctionName(options.constructor)||(!options||options.json)&&this.schema.options.toJSON)&&(options=this.schema.options.toJSON?clone(this.schema.options.toJSON):{}),options.json=!0,this.toObject(options)},Document.prototype.inspect=function(options){var opts=options&&"Object"==utils.getFunctionName(options.constructor)?options:this.schema.options.toObject?clone(this.schema.options.toObject):{};return opts.minimize=!1,inspect(this.toObject(opts))},Document.prototype.toString=Document.prototype.inspect,Document.prototype.equals=function(doc){var tid=this.get("_id"),docid=doc.get("_id");return tid||docid?tid&&tid.equals?tid.equals(docid):tid===docid:deepEqual(this,doc)},Document.prototype.populate=function(){if(0===arguments.length)return this;var fn,pop=this.$__.populate||(this.$__.populate={}),args=utils.args(arguments);if("function"==typeof args[args.length-1]&&(fn=args.pop()),args.length)for(var res=utils.populate.apply(null,args),i=0;i<res.length;++i)pop[res[i].path]=res[i];if(fn){var paths=utils.object.vals(pop);this.$__.populate=void 0,this.constructor.populate(this,paths,fn)}return this},Document.prototype.populated=function(path,val,options){if(null==val){if(!this.$__.populated)return void 0;var v=this.$__.populated[path];return v?v.value:void 0}return!0===val?this.$__.populated?this.$__.populated[path]:void 0:(this.$__.populated||(this.$__.populated={}),this.$__.populated[path]={value:val,options:options},val)
},Document.prototype.$__fullPath=function(path){return path||""},Document.ValidationError=ValidationError,module.exports=exports=Document}).call(this,require("_process"))},{"./error":17,"./internal":26,"./promise":27,"./schema":28,"./schema/mixed":35,"./schematype":39,"./types/array":41,"./types/documentarray":43,"./types/embedded":44,"./types/objectid":46,"./utils":47,_process:8,events:6,hooks:49,util:10}],14:[function(require,module){"use strict";var Document=require("./document.js"),BrowserDocument=require("./browserDocument.js");module.exports=function(){return"undefined"!=typeof window&&"undefined"!=typeof document&&document===window.document?BrowserDocument:Document}},{"./browserDocument.js":11,"./document.js":13}],15:[function(require,module,exports){var Binary=require("mongodb/node_modules/bson").Binary;module.exports=exports=Binary},{"mongodb/node_modules/bson":53}],16:[function(require,module,exports){var ObjectId=require("mongodb/node_modules/bson").ObjectID;module.exports=exports=ObjectId},{"mongodb/node_modules/bson":53}],17:[function(require,module,exports){function MongooseError(msg){Error.call(this),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.message=msg,this.name="MongooseError"}MongooseError.prototype=Object.create(Error.prototype),MongooseError.prototype.constructor=Error,module.exports=exports=MongooseError,MongooseError.messages=require("./error/messages"),MongooseError.Messages=MongooseError.messages,MongooseError.CastError=require("./error/cast"),MongooseError.ValidationError=require("./error/validation"),MongooseError.ValidatorError=require("./error/validator"),MongooseError.VersionError=require("./error/version"),MongooseError.OverwriteModelError=require("./error/overwriteModel"),MongooseError.MissingSchemaError=require("./error/missingSchema"),MongooseError.DivergentArrayError=require("./error/divergentArray")},{"./error/cast":18,"./error/divergentArray":19,"./error/messages":20,"./error/missingSchema":21,"./error/overwriteModel":22,"./error/validation":23,"./error/validator":24,"./error/version":25}],18:[function(require,module){function CastError(type,value,path){MongooseError.call(this,"Cast to "+type+' failed for value "'+value+'" at path "'+path+'"'),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.name="CastError",this.kind=type,this.value=value,this.path=path}var MongooseError=require("../error.js");CastError.prototype=Object.create(MongooseError.prototype),CastError.prototype.constructor=MongooseError,module.exports=CastError},{"../error.js":17}],19:[function(require,module){function DivergentArrayError(paths){var msg="For your own good, using `document.save()` to update an array which was selected using an $elemMatch projection OR populated using skip, limit, query conditions, or exclusion of the _id field when the operation results in a $pop or $set of the entire array is not supported. The following path(s) would have been modified unsafely:\n  "+paths.join("\n  ")+"\nUse Model.update() to update these arrays instead.";MongooseError.call(this,msg),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.name="DivergentArrayError"}var MongooseError=require("../error.js");DivergentArrayError.prototype=Object.create(MongooseError.prototype),DivergentArrayError.prototype.constructor=MongooseError,module.exports=DivergentArrayError},{"../error.js":17}],20:[function(require,module,exports){var msg=module.exports=exports={};msg.general={},msg.general.default="Validator failed for path `{PATH}` with value `{VALUE}`",msg.general.required="Path `{PATH}` is required.",msg.Number={},msg.Number.min="Path `{PATH}` ({VALUE}) is less than minimum allowed value ({MIN}).",msg.Number.max="Path `{PATH}` ({VALUE}) is more than maximum allowed value ({MAX}).",msg.String={},msg.String.enum="`{VALUE}` is not a valid enum value for path `{PATH}`.",msg.String.match="Path `{PATH}` is invalid ({VALUE})."},{}],21:[function(require,module){function MissingSchemaError(name){var msg="Schema hasn't been registered for model \""+name+'".\nUse mongoose.model(name, schema)';MongooseError.call(this,msg),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.name="MissingSchemaError"}var MongooseError=require("../error.js");MissingSchemaError.prototype=Object.create(MongooseError.prototype),MissingSchemaError.prototype.constructor=MongooseError,module.exports=MissingSchemaError},{"../error.js":17}],22:[function(require,module){function OverwriteModelError(name){MongooseError.call(this,"Cannot overwrite `"+name+"` model once compiled."),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.name="OverwriteModelError"}var MongooseError=require("../error.js");OverwriteModelError.prototype=Object.create(MongooseError.prototype),OverwriteModelError.prototype.constructor=MongooseError,module.exports=OverwriteModelError},{"../error.js":17}],23:[function(require,module,exports){function ValidationError(instance){MongooseError.call(this,"Validation failed"),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.name="ValidationError",this.errors=instance.errors={}}var MongooseError=require("../error.js");ValidationError.prototype=Object.create(MongooseError.prototype),ValidationError.prototype.constructor=MongooseError,ValidationError.prototype.toString=function(){var ret=this.name+": ",msgs=[];return Object.keys(this.errors).forEach(function(key){this!=this.errors[key]&&msgs.push(String(this.errors[key]))},this),ret+msgs.join(", ")},module.exports=exports=ValidationError},{"../error.js":17}],24:[function(require,module){function ValidatorError(properties){var msg=properties.message;msg||(msg=errorMessages.general.default),this.properties=properties;var message=this.formatMessage(msg,properties);MongooseError.call(this,message),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.name="ValidatorError",this.kind=properties.type,this.path=properties.path,this.value=properties.value}var MongooseError=require("../error.js"),errorMessages=MongooseError.messages;ValidatorError.prototype=Object.create(MongooseError.prototype),ValidatorError.prototype.constructor=MongooseError,ValidatorError.prototype.formatMessage=function(msg,properties){for(var propertyNames=Object.keys(properties),i=0;i<propertyNames.length;++i){var propertyName=propertyNames[i];"message"!==propertyName&&(msg=msg.replace("{"+propertyName.toUpperCase()+"}",properties[propertyName]))}return msg},ValidatorError.prototype.toString=function(){return this.message},module.exports=ValidatorError},{"../error.js":17}],25:[function(require,module){function VersionError(){MongooseError.call(this,"No matching document found."),Error.captureStackTrace&&Error.captureStackTrace(this,arguments.callee),this.name="VersionError"}var MongooseError=require("../error.js");VersionError.prototype=Object.create(MongooseError.prototype),VersionError.prototype.constructor=MongooseError,module.exports=VersionError},{"../error.js":17}],26:[function(require,module,exports){function InternalCache(){this.strictMode=void 0,this.selected=void 0,this.shardval=void 0,this.saveError=void 0,this.validationError=void 0,this.adhocPaths=void 0,this.removing=void 0,this.inserting=void 0,this.version=void 0,this.getters={},this._id=void 0,this.populate=void 0,this.populated=void 0,this.wasPopulated=!1,this.scope=void 0,this.activePaths=new ActiveRoster,this.ownerDocument=void 0,this.fullPath=void 0}var StateMachine=require("./statemachine"),ActiveRoster=StateMachine.ctor("require","modify","init","default","ignore");module.exports=exports=InternalCache},{"./statemachine":40}],27:[function(require,module){function Promise(fn){MPromise.call(this,fn)}var MPromise=require("mpromise"),util=require("util");Promise.prototype=Object.create(MPromise.prototype,{constructor:{value:Promise,enumerable:!1,writable:!0,configurable:!0}}),Promise.SUCCESS="complete",Promise.FAILURE="err",Promise.prototype.error=function(err){return err instanceof Error||(err instanceof Object&&(err=util.inspect(err)),err=new Error(err)),this.reject(err)},Promise.prototype.resolve=function(err){return err?this.error(err):this.fulfill.apply(this,Array.prototype.slice.call(arguments,1))},Promise.prototype.addBack=Promise.prototype.onResolve,Promise.prototype.complete=MPromise.prototype.fulfill,Promise.prototype.addCallback=Promise.prototype.onFulfill,Promise.prototype.addErrback=Promise.prototype.onReject,module.exports=Promise},{mpromise:66,util:10}],28:[function(require,module,exports){function Schema(obj,options){if(!(this instanceof Schema))return new Schema(obj,options);this.paths={},this.subpaths={},this.virtuals={},this.nested={},this.inherits={},this.callQueue=[],this._indexes=[],this.methods={},this.statics={},this.tree={},this._requiredpaths=void 0,this.discriminatorMapping=void 0,this._indexedpaths=void 0,this.options=this.defaultOptions(options),obj&&this.add(obj);var auto_id=!this.paths._id&&!this.options.noId&&this.options._id;auto_id&&this.add({_id:{type:Schema.ObjectId,auto:!0}});var autoid=!this.paths.id&&!this.options.noVirtualId&&this.options.id;autoid&&this.virtual("id").get(idGetter);var timestamps=this.options.timestamps;if(timestamps){var createdAt=timestamps.createdAt||"createdAt",updatedAt=timestamps.updatedAt||"updatedAt",schemaAdditions={};schemaAdditions[updatedAt]=Date,this.paths[createdAt]||(schemaAdditions[createdAt]=Date),this.add(schemaAdditions),this.pre("save",function(next){var defaultTimestamp=new Date;this[createdAt]||(this[createdAt]=auto_id?this._id.getTimestamp():defaultTimestamp),this[updatedAt]=this.isNew?this[createdAt]:defaultTimestamp,next()})}}function idGetter(){return this.$__._id?this.$__._id:this.$__._id=null==this._id?null:String(this._id)}function getPositionalPath(self,path){var subpaths=path.split(/\.(\d+)\.|\.(\d+)$/).filter(Boolean);if(subpaths.length<2)return self.paths[subpaths[0]];var val=self.path(subpaths[0]);if(!val)return val;for(var subpath,last=subpaths.length-1,i=1;i<subpaths.length;++i){if(subpath=subpaths[i],i===last&&val&&!val.schema&&!/\D/.test(subpath)){val=val instanceof MongooseTypes.Array?val.caster:void 0;break}if(/\D/.test(subpath)){if(!val||!val.schema){val=void 0;break}val=val.schema.path(subpath)}}return self.subpaths[path]=val}var MongooseTypes,EventEmitter=require("events").EventEmitter,VirtualType=require("./virtualtype"),utils=require("./utils");Schema.prototype=Object.create(EventEmitter.prototype),Schema.prototype.constructor=Schema,Schema.prototype.paths,Schema.prototype.tree,Schema.prototype.defaultOptions=function(options){return options&&!1===options.safe&&(options.safe={w:0}),options&&options.safe&&0===options.safe.w&&(options.versionKey=!1),options=utils.options({strict:!0,bufferCommands:!0,capped:!1,versionKey:"__v",discriminatorKey:"__t",minimize:!0,autoIndex:!0,shardKey:null,read:null,validateBeforeSave:!0,noId:!1,_id:!0,noVirtualId:!1,id:!0},options),options.read&&(options.read=utils.readPref(options.read)),options},Schema.prototype.add=function(obj,prefix){prefix=prefix||"";for(var keys=Object.keys(obj),i=0;i<keys.length;++i){var key=keys[i];if(null==obj[key])throw new TypeError("Invalid value for schema path `"+prefix+key+"`");!utils.isObject(obj[key])||obj[key].constructor&&"Object"!=utils.getFunctionName(obj[key].constructor)||obj[key].type&&!obj[key].type.type?this.path(prefix+key,obj[key]):Object.keys(obj[key]).length?(this.nested[prefix+key]=!0,this.add(obj[key],prefix+key+".")):this.path(prefix+key,obj[key])}},Schema.reserved=Object.create(null);var reserved=Schema.reserved;reserved.on=reserved.db=reserved.set=reserved.get=reserved.init=reserved.isNew=reserved.errors=reserved.schema=reserved.options=reserved.modelName=reserved.collection=reserved.toObject=reserved.domain=reserved.emit=reserved._events=reserved._pres=reserved._posts=1,Schema.prototype.path=function(path,obj){if(void 0==obj)return this.paths[path]?this.paths[path]:this.subpaths[path]?this.subpaths[path]:/\.\d+\.?.*$/.test(path)?getPositionalPath(this,path):void 0;if(reserved[path])throw new Error("`"+path+"` may not be used as a schema pathname");var subpaths=path.split(/\./),last=subpaths.pop(),branch=this.tree;return subpaths.forEach(function(sub,i){if(branch[sub]||(branch[sub]={}),"object"!=typeof branch[sub]){var msg="Cannot set nested path `"+path+"`. Parent path `"+subpaths.slice(0,i).concat([sub]).join(".")+"` already set to type "+branch[sub].name+".";throw new Error(msg)}branch=branch[sub]}),branch[last]=utils.clone(obj),this.paths[path]=Schema.interpretAsType(path,obj),this},Schema.interpretAsType=function(path,obj){if(obj.constructor){var constructorName=utils.getFunctionName(obj.constructor);"Object"!=constructorName&&(obj={type:obj})}var type=obj.type&&!obj.type.type?obj.type:{};if("Object"==utils.getFunctionName(type.constructor)||"mixed"==type)return new MongooseTypes.Mixed(path,obj);if(Array.isArray(type)||Array==type||"array"==type){var cast=Array==type||"array"==type?obj.cast:type[0];if(cast instanceof Schema)return new MongooseTypes.DocumentArray(path,cast,obj);if("string"==typeof cast)cast=MongooseTypes[cast.charAt(0).toUpperCase()+cast.substring(1)];else if(cast&&(!cast.type||cast.type.type)&&"Object"==utils.getFunctionName(cast.constructor)&&Object.keys(cast).length)return new MongooseTypes.DocumentArray(path,new Schema(cast),obj);return new MongooseTypes.Array(path,cast||MongooseTypes.Mixed,obj)}var name="string"==typeof type?type:utils.getFunctionName(type);if(name&&(name=name.charAt(0).toUpperCase()+name.substring(1)),void 0==MongooseTypes[name])throw new TypeError("Undefined type at `"+path+"`\n  Did you try nesting Schemas? You can only nest using refs or arrays.");return new MongooseTypes[name](path,obj)},Schema.prototype.eachPath=function(fn){for(var keys=Object.keys(this.paths),len=keys.length,i=0;len>i;++i)fn(keys[i],this.paths[keys[i]]);return this},Schema.prototype.requiredPaths=function(){if(this._requiredpaths)return this._requiredpaths;for(var paths=Object.keys(this.paths),i=paths.length,ret=[];i--;){var path=paths[i];this.paths[path].isRequired&&ret.push(path)}return this._requiredpaths=ret},Schema.prototype.indexedPaths=function(){return this._indexedpaths?this._indexedpaths:this._indexedpaths=this.indexes()},Schema.prototype.pathType=function(path){return path in this.paths?"real":path in this.virtuals?"virtual":path in this.nested?"nested":path in this.subpaths?"real":/\.\d+\.|\.\d+$/.test(path)&&getPositionalPath(this,path)?"real":"adhocOrUndefined"},Schema.prototype.queue=function(name,args){return this.callQueue.push([name,args]),this},Schema.prototype.pre=function(){return this.queue("pre",arguments)},Schema.prototype.post=function(method,fn){return fn.length<2?this.queue("on",arguments):this.queue("post",[arguments[0],function(next){fn.call(this,this,next)}])},Schema.prototype.plugin=function(fn,opts){return fn(this,opts),this},Schema.prototype.method=function(name,fn){if("string"!=typeof name)for(var i in name)this.methods[i]=name[i];else this.methods[name]=fn;return this},Schema.prototype.static=function(name,fn){if("string"!=typeof name)for(var i in name)this.statics[i]=name[i];else this.statics[name]=fn;return this},Schema.prototype.index=function(fields,options){return options||(options={}),options.expires&&utils.expires(options),this._indexes.push([fields,options]),this},Schema.prototype.set=function(key,value,_tags){if(1===arguments.length)return this.options[key];switch(key){case"read":this.options[key]=utils.readPref(value,_tags);break;case"safe":this.options[key]=!1===value?{w:0}:value;break;default:this.options[key]=value}return this},Schema.prototype.get=function(key){return this.options[key]};var indexTypes="2d 2dsphere hashed text".split(" ");Object.defineProperty(Schema,"indexTypes",{get:function(){return indexTypes},set:function(){throw new Error("Cannot overwrite Schema.indexTypes")}}),Schema.prototype.indexes=function(){"use strict";function collectIndexes(schema,prefix){if(!~seenSchemas.indexOf(schema)){seenSchemas.push(schema),prefix=prefix||"";for(var key,path,index,field,isObject,options,type,keys=Object.keys(schema.paths),i=0;i<keys.length;++i)key=keys[i],path=schema.paths[key],path instanceof MongooseTypes.DocumentArray?collectIndexes(path.schema,key+"."):(index=path._index,!1!==index&&null!=index&&(field={},isObject=utils.isObject(index),options=isObject?index:{},type="string"==typeof index?index:isObject?index.type:!1,field[prefix+key]=type&&~Schema.indexTypes.indexOf(type)?type:1,delete options.type,"background"in options||(options.background=!0),indexes.push([field,options])));prefix?fixSubIndexPaths(schema,prefix):(schema._indexes.forEach(function(index){"background"in index[1]||(index[1].background=!0)}),indexes=indexes.concat(schema._indexes))}}function fixSubIndexPaths(schema,prefix){var indexObj,newindex,klen,keys,key,j,subindexes=schema._indexes,len=subindexes.length,i=0;for(i=0;len>i;++i){for(indexObj=subindexes[i][0],keys=Object.keys(indexObj),klen=keys.length,newindex={},j=0;klen>j;++j)key=keys[j],newindex[prefix+key]=indexObj[key];indexes.push([newindex,subindexes[i][1]])}}var indexes=[],seenSchemas=[];return collectIndexes(this),indexes},Schema.prototype.virtual=function(name,options){var virtuals=this.virtuals,parts=name.split(".");return virtuals[name]=parts.reduce(function(mem,part,i){return mem[part]||(mem[part]=i===parts.length-1?new VirtualType(options,name):{}),mem[part]},this.tree)},Schema.prototype.virtualpath=function(name){return this.virtuals[name]},module.exports=exports=Schema,Schema.Types=MongooseTypes=require("./schema/index");exports.ObjectId=MongooseTypes.ObjectId},{"./schema/index":34,"./utils":47,"./virtualtype":48,events:6}],29:[function(require,module){function SchemaArray(key,cast,options){if(cast){var castOptions={};"Object"===utils.getFunctionName(cast.constructor)&&(cast.type?(castOptions=utils.clone(cast),delete castOptions.type,cast=cast.type):cast=Mixed);var name="string"==typeof cast?cast:utils.getFunctionName(cast),caster=name in Types?Types[name]:cast;this.casterConstructor=caster,this.caster=new caster(null,castOptions),this.caster instanceof EmbeddedDoc||(this.caster.path=key)}SchemaType.call(this,key,options);var defaultArr,fn,self=this;this.defaultValue&&(defaultArr=this.defaultValue,fn="function"==typeof defaultArr),this.default(function(){var arr=fn?defaultArr():defaultArr||[];return new MongooseArray(arr,self.path,this)})}function castToNumber(val){return Types.Number.prototype.cast.call(this,val)}function castArraysOfNumbers(arr,self){self||(self=this),arr.forEach(function(v,i){Array.isArray(v)?castArraysOfNumbers(v,self):arr[i]=castToNumber.call(self,v)})}function cast$near(val){return Array.isArray(val)?(castArraysOfNumbers(val,this),val):val&&val.$geometry?cast$geometry(val,this):SchemaArray.prototype.castForQuery.call(this,val)}function cast$geometry(val,self){switch(val.$geometry.type){case"Polygon":case"LineString":case"Point":castArraysOfNumbers(val.$geometry.coordinates,self)}return val.$maxDistance&&(val.$maxDistance=castToNumber.call(self,val.$maxDistance)),val}function cast$within(val){var self=this;if(val.$maxDistance&&(val.$maxDistance=castToNumber.call(self,val.$maxDistance)),val.$box||val.$polygon){var type=val.$box?"$box":"$polygon";val[type].forEach(function(arr){if(!Array.isArray(arr)){var msg="Invalid $within $box argument. Expected an array, received "+arr;throw new TypeError(msg)}arr.forEach(function(v,i){arr[i]=castToNumber.call(this,v)})})}else if(val.$center||val.$centerSphere){var type=val.$center?"$center":"$centerSphere";val[type].forEach(function(item,i){Array.isArray(item)?item.forEach(function(v,j){item[j]=castToNumber.call(this,v)}):val[type][i]=castToNumber.call(this,item)})}else val.$geometry&&cast$geometry(val,this);return val}function cast$all(val){return Array.isArray(val)||(val=[val]),val=val.map(function(v){if(utils.isObject(v)){var o={};return o[this.path]=v,cast(this.casterConstructor.schema,o)[this.path]}return v},this),this.castForQuery(val)}function cast$elemMatch(val){return val.$in?(val.$in=this.castForQuery("$in",val.$in),val):cast(this.casterConstructor.schema,val)}function cast$geoIntersects(val){var geo=val.$geometry;if(geo)return cast$geometry(val,this),val}var SchemaType=require("../schematype"),CastError=SchemaType.CastError,Types=(require("./number"),{Boolean:require("./boolean"),Date:require("./date"),Number:require("./number"),String:require("./string"),ObjectId:require("./objectid"),Buffer:require("./buffer")}),MongooseArray=require("../types").Array,EmbeddedDoc=require("../types").Embedded,Mixed=require("./mixed"),cast=require("../cast"),utils=require("../utils"),isMongooseObject=utils.isMongooseObject;SchemaArray.prototype=Object.create(SchemaType.prototype),SchemaArray.prototype.constructor=SchemaArray,SchemaArray.prototype.checkRequired=function(value){return!(!value||!value.length)},SchemaArray.prototype.applyGetters=function(value,scope){return this.caster.options&&this.caster.options.ref?value:SchemaType.prototype.applyGetters.call(this,value,scope)},SchemaArray.prototype.cast=function(value,doc,init){if(Array.isArray(value)){if(!value.length&&doc)for(var indexes=doc.schema.indexedPaths(),i=0,l=indexes.length;l>i;++i){var pathIndex=indexes[i][0][this.path];if("2dsphere"===pathIndex||"2d"===pathIndex)return}if(value&&value.isMongooseArray||(value=new MongooseArray(value,this.path,doc)),this.caster)try{for(var i=0,l=value.length;l>i;i++)value[i]=this.caster.cast(value[i],doc,init)}catch(e){throw new CastError(e.type,value,this.path)}return value}return this.cast([value],doc,init)},SchemaArray.prototype.castForQuery=function($conditional,value){var handler,val;if(2===arguments.length){if(handler=this.$conditionalHandlers[$conditional],!handler)throw new Error("Can't use "+$conditional+" with Array.");val=handler.call(this,value)}else{val=$conditional;var proto=this.casterConstructor.prototype,method=proto.castForQuery||proto.cast,caster=this.caster;Array.isArray(val)?val=val.map(function(v){return method&&(v=method.call(caster,v)),isMongooseObject(v)?v.toObject():v}):method&&(val=method.call(caster,val))}return val&&isMongooseObject(val)?val.toObject():val};var handle=SchemaArray.prototype.$conditionalHandlers={};handle.$all=cast$all,handle.$options=String,handle.$elemMatch=cast$elemMatch,handle.$geoIntersects=cast$geoIntersects,handle.$or=handle.$and=function(val){if(!Array.isArray(val))throw new TypeError("conditional $or/$and require array");for(var ret=[],i=0;i<val.length;++i)ret.push(cast(this.casterConstructor.schema,val[i]));return ret},handle.$near=handle.$nearSphere=cast$near,handle.$within=handle.$geoWithin=cast$within,handle.$size=handle.$maxDistance=castToNumber,handle.$regex=handle.$ne=handle.$in=handle.$nin=handle.$gt=handle.$gte=handle.$lt=handle.$lte=SchemaArray.prototype.castForQuery,module.exports=SchemaArray},{"../cast":12,"../schematype":39,"../types":45,"../utils":47,"./boolean":30,"./buffer":31,"./date":32,"./mixed":35,"./number":36,"./objectid":37,"./string":38}],30:[function(require,module){function SchemaBoolean(path,options){SchemaType.call(this,path,options)}function handleArray(val){var self=this;return val.map(function(m){return self.cast(m)})}{var SchemaType=require("../schematype");require("../utils")}SchemaBoolean.prototype=Object.create(SchemaType.prototype),SchemaBoolean.prototype.constructor=SchemaBoolean,SchemaBoolean.prototype.checkRequired=function(value){return value===!0||value===!1},SchemaBoolean.prototype.cast=function(value){return null===value?value:"0"===value?!1:"true"===value?!0:"false"===value?!1:!!value},SchemaBoolean.$conditionalHandlers={$in:handleArray},SchemaBoolean.prototype.castForQuery=function($conditional,val){var handler;return 2===arguments.length?(handler=SchemaBoolean.$conditionalHandlers[$conditional],handler?handler.call(this,val):this.cast(val)):this.cast($conditional)},module.exports=SchemaBoolean},{"../schematype":39,"../utils":47}],31:[function(require,module){(function(Buffer){function SchemaBuffer(key,options){SchemaType.call(this,key,options,"Buffer")}function handleSingle(val){return this.castForQuery(val)}function handleArray(val){var self=this;return val.map(function(m){return self.castForQuery(m)})}var Document,SchemaType=require("../schematype"),CastError=SchemaType.CastError,MongooseBuffer=require("../types").Buffer,Binary=MongooseBuffer.Binary,utils=require("../utils");SchemaBuffer.prototype=Object.create(SchemaType.prototype),SchemaBuffer.prototype.constructor=SchemaBuffer,SchemaBuffer.prototype.checkRequired=function(value,doc){return SchemaType._isRef(this,value,doc,!0)?null!=value:!(!value||!value.length)},SchemaBuffer.prototype.cast=function(value,doc,init){if(SchemaType._isRef(this,value,doc,init)){if(null==value)return value;if(Document||(Document=require("./../document")),value instanceof Document)return value.$__.wasPopulated=!0,value;if(Buffer.isBuffer(value))return value;if(!utils.isObject(value))throw new CastError("buffer",value,this.path);var path=doc.$__fullPath(this.path),owner=doc.ownerDocument?doc.ownerDocument():doc,pop=owner.populated(path,!0),ret=new pop.options.model(value);return ret.$__.wasPopulated=!0,ret}if(value&&value._id&&(value=value._id),Buffer.isBuffer(value))return value&&value.isMongooseBuffer||(value=new MongooseBuffer(value,[this.path,doc])),value;if(value instanceof Binary){var ret=new MongooseBuffer(value.value(!0),[this.path,doc]);return ret.subtype(value.sub_type),ret}if(null===value)return value;var type=typeof value;if("string"==type||"number"==type||Array.isArray(value)){var ret=new MongooseBuffer(value,[this.path,doc]);return ret}throw new CastError("buffer",value,this.path)},SchemaBuffer.prototype.$conditionalHandlers={$ne:handleSingle,$in:handleArray,$nin:handleArray,$gt:handleSingle,$lt:handleSingle,$gte:handleSingle,$lte:handleSingle},SchemaBuffer.prototype.castForQuery=function($conditional,val){var handler;if(2===arguments.length){if(handler=this.$conditionalHandlers[$conditional],!handler)throw new Error("Can't use "+$conditional+" with Buffer.");return handler.call(this,val)}return val=$conditional,this.cast(val).toObject()},module.exports=SchemaBuffer}).call(this,require("buffer").Buffer)},{"../schematype":39,"../types":45,"../utils":47,"./../document":13,buffer:2}],32:[function(require,module){function SchemaDate(key,options){SchemaType.call(this,key,options)}function handleSingle(val){return this.cast(val)}function handleArray(val){var self=this;return val.map(function(m){return self.cast(m)})}var SchemaType=require("../schematype"),CastError=SchemaType.CastError,utils=require("../utils");SchemaDate.prototype=Object.create(SchemaType.prototype),SchemaDate.prototype.constructor=SchemaDate,SchemaDate.prototype.expires=function(when){return this._index&&"Object"===this._index.constructor.name||(this._index={}),this._index.expires=when,utils.expires(this._index),this},SchemaDate.prototype.checkRequired=function(value){return value instanceof Date},SchemaDate.prototype.cast=function(value){if(null===value||""===value)return null;if(value instanceof Date)return value;var date;if(value instanceof Number||"number"==typeof value||String(value)==Number(value)?date=new Date(Number(value)):value.toString&&(date=new Date(value.toString())),"Invalid Date"!=date.toString())return date;throw new CastError("date",value,this.path)},SchemaDate.prototype.$conditionalHandlers={$lt:handleSingle,$lte:handleSingle,$gt:handleSingle,$gte:handleSingle,$ne:handleSingle,$in:handleArray,$nin:handleArray,$all:handleArray},SchemaDate.prototype.castForQuery=function($conditional,val){var handler;if(2!==arguments.length)return this.cast($conditional);if(handler=this.$conditionalHandlers[$conditional],!handler)throw new Error("Can't use "+$conditional+" with Date.");return handler.call(this,val)},module.exports=SchemaDate},{"../schematype":39,"../utils":47}],33:[function(require,module){function DocumentArray(key,schema,options){function EmbeddedDocument(){this.$__setSchema(schema);for(var i in schema.methods)this[i]=schema.methods[i];Subdocument.apply(this,arguments)}EmbeddedDocument.prototype=Subdocument.prototype,EmbeddedDocument.schema=schema;for(var i in schema.statics)EmbeddedDocument[i]=schema.statics[i];EmbeddedDocument.options=options,this.schema=schema,ArrayType.call(this,key,EmbeddedDocument,options),this.schema=schema;var path=this.path,fn=this.defaultValue;this.default(function(){var arr=fn.call(this);return Array.isArray(arr)||(arr=[arr]),new MongooseDocumentArray(arr,path,this)})}function scopePaths(array,fields,init){if(!init||!fields)return void 0;for(var hasKeys,key,path=array.path+".",keys=Object.keys(fields),i=keys.length,selected={};i--;)key=keys[i],0===key.indexOf(path)&&(hasKeys||(hasKeys=!0),selected[key.substring(path.length)]=fields[key]);return hasKeys&&selected||void 0}{var SchemaType=require("../schematype"),ArrayType=require("./array"),MongooseDocumentArray=require("../types/documentarray"),Subdocument=require("../types/embedded");require("../document"),require("../utils.js")}DocumentArray.prototype=Object.create(ArrayType.prototype),DocumentArray.prototype.constructor=DocumentArray,DocumentArray.prototype.doValidate=function(array,fn,scope){var self=this;SchemaType.prototype.doValidate.call(this,array,function(err){if(err)return fn(err);var error,count=array&&array.length;if(!count)return fn();for(var i=0,len=count;len>i;++i){var doc=array[i];doc?!function(i){doc.validate(function(err){return err&&!error?(err.key=self.key+"."+i+"."+err.key,fn(error=err)):void(--count||fn())})}(i):--count||fn()}},scope)},DocumentArray.prototype.cast=function(value,doc,init,prev){var selected,subdoc,i;if(!Array.isArray(value))return this.cast([value],doc,init,prev);if((!value||!value.isMongooseDocumentArray)&&(value=new MongooseDocumentArray(value,this.path,doc),prev&&prev._handlers))for(var key in prev._handlers)doc.removeListener(key,prev._handlers[key]);for(i=value.length;i--;)if(!(value[i]instanceof Subdocument)&&value[i])if(init)selected||(selected=scopePaths(this,doc.$__.selected,init)),subdoc=new this.casterConstructor(null,value,!0,selected),value[i]=subdoc.init(value[i]);else{try{subdoc=prev.id(value[i]._id)}catch(e){}prev&&subdoc?subdoc.set(value[i]):subdoc=new this.casterConstructor(value[i],value),value[i]=subdoc}return value},module.exports=DocumentArray},{"../document":13,"../schematype":39,"../types/documentarray":43,"../types/embedded":44,"../utils.js":47,"./array":29}],34:[function(require,module,exports){exports.String=require("./string"),exports.Number=require("./number"),exports.Boolean=require("./boolean"),exports.DocumentArray=require("./documentarray"),exports.Array=require("./array"),exports.Buffer=require("./buffer"),exports.Date=require("./date"),exports.ObjectId=require("./objectid"),exports.Mixed=require("./mixed"),exports.Oid=exports.ObjectId,exports.Object=exports.Mixed,exports.Bool=exports.Boolean},{"./array":29,"./boolean":30,"./buffer":31,"./date":32,"./documentarray":33,"./mixed":35,"./number":36,"./objectid":37,"./string":38}],35:[function(require,module){function Mixed(path,options){if(options&&options.default){var def=options.default;Array.isArray(def)&&0===def.length?options.default=Array:!options.shared&&utils.isObject(def)&&0===Object.keys(def).length&&(options.default=function(){return{}})}SchemaType.call(this,path,options)}var SchemaType=require("../schematype"),utils=require("../utils");Mixed.prototype=Object.create(SchemaType.prototype),Mixed.prototype.constructor=Mixed,Mixed.prototype.checkRequired=function(val){return void 0!==val&&null!==val},Mixed.prototype.cast=function(val){return val},Mixed.prototype.castForQuery=function($cond,val){return 2===arguments.length?val:$cond},module.exports=Mixed},{"../schematype":39,"../utils":47}],36:[function(require,module){(function(Buffer){function SchemaNumber(key,options){SchemaType.call(this,key,options,"Number")
}function handleSingle(val){return this.cast(val)}function handleArray(val){var self=this;return val.map(function(m){return self.cast(m)})}var Document,SchemaType=require("../schematype"),CastError=SchemaType.CastError,errorMessages=require("../error").messages,utils=require("../utils");SchemaNumber.prototype=Object.create(SchemaType.prototype),SchemaNumber.prototype.constructor=SchemaNumber,SchemaNumber.prototype.checkRequired=function(value,doc){return SchemaType._isRef(this,value,doc,!0)?null!=value:"number"==typeof value||value instanceof Number},SchemaNumber.prototype.min=function(value,message){if(this.minValidator&&(this.validators=this.validators.filter(function(v){return v.validator!=this.minValidator},this)),null!=value){var msg=message||errorMessages.Number.min;msg=msg.replace(/{MIN}/,value),this.validators.push({validator:this.minValidator=function(v){return null===v||v>=value},message:msg,type:"min"})}return this},SchemaNumber.prototype.max=function(value,message){if(this.maxValidator&&(this.validators=this.validators.filter(function(v){return v.validator!=this.maxValidator},this)),null!=value){var msg=message||errorMessages.Number.max;msg=msg.replace(/{MAX}/,value),this.validators.push({validator:this.maxValidator=function(v){return null===v||value>=v},message:msg,type:"max"})}return this},SchemaNumber.prototype.cast=function(value,doc,init){if(SchemaType._isRef(this,value,doc,init)){if(null==value)return value;if(Document||(Document=require("./../document")),value instanceof Document)return value.$__.wasPopulated=!0,value;if("number"==typeof value)return value;if(Buffer.isBuffer(value)||!utils.isObject(value))throw new CastError("number",value,this.path);var path=doc.$__fullPath(this.path),owner=doc.ownerDocument?doc.ownerDocument():doc,pop=owner.populated(path,!0),ret=new pop.options.model(value);return ret.$__.wasPopulated=!0,ret}var val=value&&value._id?value._id:value;if(!isNaN(val)){if(null===val)return val;if(""===val)return null;if("string"==typeof val&&(val=Number(val)),val instanceof Number)return val;if("number"==typeof val)return val;if(val.toString&&!Array.isArray(val)&&val.toString()==Number(val))return new Number(val)}throw new CastError("number",value,this.path)},SchemaNumber.prototype.$conditionalHandlers={$lt:handleSingle,$lte:handleSingle,$gt:handleSingle,$gte:handleSingle,$ne:handleSingle,$in:handleArray,$nin:handleArray,$mod:handleArray,$all:handleArray},SchemaNumber.prototype.castForQuery=function($conditional,val){var handler;if(2===arguments.length){if(handler=this.$conditionalHandlers[$conditional],!handler)throw new Error("Can't use "+$conditional+" with Number.");return handler.call(this,val)}return val=this.cast($conditional),null==val?val:val},module.exports=SchemaNumber}).call(this,require("buffer").Buffer)},{"../error":17,"../schematype":39,"../utils":47,"./../document":13,buffer:2}],37:[function(require,module){(function(Buffer){function ObjectId(key,options){SchemaType.call(this,key,options,"ObjectID")}function handleSingle(val){return this.cast(val)}function handleArray(val){var self=this;return val.map(function(m){return self.cast(m)})}function defaultId(){return new oid}function resetId(v){return this.$__._id=null,v}var Document,SchemaType=require("../schematype"),CastError=SchemaType.CastError,oid=require("../types/objectid"),utils=require("../utils");ObjectId.prototype=Object.create(SchemaType.prototype),ObjectId.prototype.constructor=ObjectId,ObjectId.prototype.auto=function(turnOn){return turnOn&&(this.default(defaultId),this.set(resetId)),this},ObjectId.prototype.checkRequired=function(value,doc){return SchemaType._isRef(this,value,doc,!0)?null!=value:value instanceof oid},ObjectId.prototype.cast=function(value,doc,init){if(SchemaType._isRef(this,value,doc,init)){if(null==value)return value;if(Document||(Document=require("./../document")),value instanceof Document)return value.$__.wasPopulated=!0,value;if(value instanceof oid)return value;if(Buffer.isBuffer(value)||!utils.isObject(value))throw new CastError("ObjectId",value,this.path);var path=doc.$__fullPath(this.path),owner=doc.ownerDocument?doc.ownerDocument():doc,pop=owner.populated(path,!0),ret=new pop.options.model(value);return ret.$__.wasPopulated=!0,ret}if(null===value)return value;if(value instanceof oid)return value;if(value._id&&value._id instanceof oid)return value._id;if(value.toString)try{return oid.createFromHexString(value.toString())}catch(err){throw new CastError("ObjectId",value,this.path)}throw new CastError("ObjectId",value,this.path)},ObjectId.prototype.$conditionalHandlers={$ne:handleSingle,$in:handleArray,$nin:handleArray,$gt:handleSingle,$lt:handleSingle,$gte:handleSingle,$lte:handleSingle,$all:handleArray},ObjectId.prototype.castForQuery=function($conditional,val){var handler;if(2===arguments.length){if(handler=this.$conditionalHandlers[$conditional],!handler)throw new Error("Can't use "+$conditional+" with ObjectId.");return handler.call(this,val)}return this.cast($conditional)},module.exports=ObjectId}).call(this,require("buffer").Buffer)},{"../schematype":39,"../types/objectid":46,"../utils":47,"./../document":13,buffer:2}],38:[function(require,module){(function(Buffer){function SchemaString(key,options){this.enumValues=[],this.regExp=null,SchemaType.call(this,key,options,"String")}function handleSingle(val){return this.castForQuery(val)}function handleArray(val){var self=this;return val.map(function(m){return self.castForQuery(m)})}var Document,SchemaType=require("../schematype"),CastError=SchemaType.CastError,errorMessages=require("../error").messages,utils=require("../utils");SchemaString.prototype=Object.create(SchemaType.prototype),SchemaString.prototype.constructor=SchemaString,SchemaString.prototype.enum=function(){if(this.enumValidator&&(this.validators=this.validators.filter(function(v){return v.validator!=this.enumValidator},this),this.enumValidator=!1),void 0===arguments[0]||!1===arguments[0])return this;var values,errorMessage;utils.isObject(arguments[0])?(values=arguments[0].values,errorMessage=arguments[0].message):(values=arguments,errorMessage=errorMessages.String.enum);for(var i=0;i<values.length;i++)void 0!==values[i]&&this.enumValues.push(this.cast(values[i]));var vals=this.enumValues;return this.enumValidator=function(v){return void 0===v||~vals.indexOf(v)},this.validators.push({validator:this.enumValidator,message:errorMessage,type:"enum"}),this},SchemaString.prototype.lowercase=function(){return this.set(function(v,self){return"string"!=typeof v&&(v=self.cast(v)),v?v.toLowerCase():v})},SchemaString.prototype.uppercase=function(){return this.set(function(v,self){return"string"!=typeof v&&(v=self.cast(v)),v?v.toUpperCase():v})},SchemaString.prototype.trim=function(){return this.set(function(v,self){return"string"!=typeof v&&(v=self.cast(v)),v?v.trim():v})},SchemaString.prototype.match=function(regExp,message){function matchValidator(v){return null!=v&&""!==v?regExp.test(v):!0}var msg=message||errorMessages.String.match;return this.validators.push({validator:matchValidator,message:msg,type:"regexp"}),this},SchemaString.prototype.checkRequired=function(value,doc){return SchemaType._isRef(this,value,doc,!0)?null!=value:(value instanceof String||"string"==typeof value)&&value.length},SchemaString.prototype.cast=function(value,doc,init){if(SchemaType._isRef(this,value,doc,init)){if(null==value)return value;if(Document||(Document=require("./../document")),value instanceof Document)return value.$__.wasPopulated=!0,value;if("string"==typeof value)return value;if(Buffer.isBuffer(value)||!utils.isObject(value))throw new CastError("string",value,this.path);var path=doc.$__fullPath(this.path),owner=doc.ownerDocument?doc.ownerDocument():doc,pop=owner.populated(path,!0),ret=new pop.options.model(value);return ret.$__.wasPopulated=!0,ret}if(null===value)return value;if("undefined"!=typeof value){if(value._id&&"string"==typeof value._id)return value._id;if(value.toString)return value.toString()}throw new CastError("string",value,this.path)},SchemaString.prototype.$conditionalHandlers={$ne:handleSingle,$in:handleArray,$nin:handleArray,$gt:handleSingle,$lt:handleSingle,$gte:handleSingle,$lte:handleSingle,$all:handleArray,$regex:handleSingle,$options:handleSingle},SchemaString.prototype.castForQuery=function($conditional,val){var handler;if(2===arguments.length){if(handler=this.$conditionalHandlers[$conditional],!handler)throw new Error("Can't use "+$conditional+" with String.");return handler.call(this,val)}return val=$conditional,val instanceof RegExp?val:this.cast(val)},module.exports=SchemaString}).call(this,require("buffer").Buffer)},{"../error":17,"../schematype":39,"../utils":47,"./../document":13,buffer:2}],39:[function(require,module,exports){(function(Buffer){function SchemaType(path,options,instance){this.path=path,this.instance=instance,this.validators=[],this.setters=[],this.getters=[],this.options=options,this._index=null,this.selected;for(var i in options)if(this[i]&&"function"==typeof this[i]){if("index"==i&&this._index)continue;var opts=Array.isArray(options[i])?options[i]:[options[i]];this[i].apply(this,opts)}}var utils=require("./utils"),error=require("./error"),errorMessages=error.messages,CastError=error.CastError,ValidatorError=error.ValidatorError;SchemaType.prototype.default=function(val){return 1===arguments.length?(this.defaultValue="function"==typeof val?val:this.cast(val),this):(arguments.length>1&&(this.defaultValue=utils.args(arguments)),this.defaultValue)},SchemaType.prototype.index=function(options){return this._index=options,utils.expires(this._index),this},SchemaType.prototype.unique=function(bool){return null==this._index||"boolean"==typeof this._index?this._index={}:"string"==typeof this._index&&(this._index={type:this._index}),this._index.unique=bool,this},SchemaType.prototype.sparse=function(bool){return null==this._index||"boolean"==typeof this._index?this._index={}:"string"==typeof this._index&&(this._index={type:this._index}),this._index.sparse=bool,this},SchemaType.prototype.set=function(fn){if("function"!=typeof fn)throw new TypeError("A setter must be a function.");return this.setters.push(fn),this},SchemaType.prototype.get=function(fn){if("function"!=typeof fn)throw new TypeError("A getter must be a function.");return this.getters.push(fn),this},SchemaType.prototype.validate=function(obj,message,type){if("function"==typeof obj||obj&&"RegExp"===utils.getFunctionName(obj.constructor)){var properties;return message instanceof Object&&!type?(properties=utils.clone(message),properties.message||(properties.message=properties.msg),properties.validator=obj):(message||(message=errorMessages.general.default),type||(type="user defined"),properties={message:message,type:type,validator:obj}),this.validators.push(properties),this}var i,length,arg;for(i=0,length=arguments.length;length>i;i++){if(arg=arguments[i],!arg||"Object"!==utils.getFunctionName(arg.constructor)){var msg="Invalid validator. Received ("+typeof arg+") "+arg+". See http://mongoosejs.com/docs/api.html#schematype_SchemaType-validate";throw new Error(msg)}this.validate(arg.validator,arg)}return this},SchemaType.prototype.required=function(required,message){if(!1===required)return this.validators=this.validators.filter(function(v){return v.validator!=this.requiredValidator},this),this.isRequired=!1,this;var self=this;this.isRequired=!0,this.requiredValidator=function(v){return"isSelected"in this&&!this.isSelected(self.path)&&!this.isModified(self.path)?!0:"function"==typeof required&&!required.apply(this)||self.checkRequired(v,this)},"string"==typeof required&&(message=required,required=void 0);var msg=message||errorMessages.general.required;return this.validators.push({validator:this.requiredValidator,message:msg,type:"required"}),this},SchemaType.prototype.getDefault=function(scope,init){var ret="function"==typeof this.defaultValue?this.defaultValue.call(scope):this.defaultValue;return null!==ret&&void 0!==ret?this.cast(ret,scope,init):ret},SchemaType.prototype.applySetters=function(value,scope,init,priorVal){if(SchemaType._isRef(this,value,scope,init))return init?value:this.cast(value,scope,init,priorVal);var v=value,setters=this.setters,len=setters.length,caster=this.caster;if(Array.isArray(v)&&caster&&caster.setters)for(var i=0;i<v.length;i++)v[i]=caster.applySetters(v[i],scope,init,priorVal);if(!len)return null===v||void 0===v?v:this.cast(v,scope,init,priorVal);for(;len--;)v=setters[len].call(scope,v,this);return null===v||void 0===v?v:v=this.cast(v,scope,init,priorVal)},SchemaType.prototype.applyGetters=function(value,scope){if(SchemaType._isRef(this,value,scope,!0))return value;var v=value,getters=this.getters,len=getters.length;if(!len)return v;for(;len--;)v=getters[len].call(scope,v,this);return v},SchemaType.prototype.select=function(val){return this.selected=!!val,this},SchemaType.prototype.doValidate=function(value,fn,scope){var err=!1,path=this.path,count=this.validators.length;if(!count)return fn(null);var validate=function(ok,validatorProperties){err||(void 0===ok||ok?--count||fn(null):(err=new ValidatorError(validatorProperties),fn(err)))};this.validators.forEach(function(v){var validator=v.validator,validatorProperties=(v.message,v.type,utils.clone(v));validatorProperties.path=path,validatorProperties.value=value,validator instanceof RegExp?validate(validator.test(value),validatorProperties):"function"==typeof validator&&(2===validator.length?validator.call(scope,value,function(ok){validate(ok,validatorProperties)}):validate(validator.call(scope,value),validatorProperties))})},SchemaType._isRef=function(self,value,doc,init){var ref=init&&self.options&&self.options.ref;if(!ref&&doc&&doc.$__fullPath){var path=doc.$__fullPath(self.path),owner=doc.ownerDocument?doc.ownerDocument():doc;ref=owner.populated(path)}if(ref){if(null==value)return!0;if(!Buffer.isBuffer(value)&&"Binary"!=value._bsontype&&utils.isObject(value))return!0}return!1},module.exports=exports=SchemaType,exports.CastError=CastError,exports.ValidatorError=ValidatorError}).call(this,require("buffer").Buffer)},{"./error":17,"./utils":47,buffer:2}],40:[function(require,module,exports){var utils=require("./utils"),StateMachine=module.exports=exports=function(){this.paths={},this.states={}};StateMachine.ctor=function(){var states=utils.args(arguments),ctor=function(){StateMachine.apply(this,arguments),this.stateNames=states;for(var state,i=states.length;i--;)state=states[i],this.states[state]={}};return ctor.prototype=new StateMachine,states.forEach(function(state){ctor.prototype[state]=function(path){this._changeState(path,state)}}),ctor},StateMachine.prototype._changeState=function(path,nextState){var prevBucket=this.states[this.paths[path]];prevBucket&&delete prevBucket[path],this.paths[path]=nextState,this.states[nextState][path]=!0},StateMachine.prototype.clear=function(state){for(var path,keys=Object.keys(this.states[state]),i=keys.length;i--;)path=keys[i],delete this.states[state][path],delete this.paths[path]},StateMachine.prototype.some=function(){var self=this,what=arguments.length?arguments:this.stateNames;return Array.prototype.some.call(what,function(state){return Object.keys(self.states[state]).length})},StateMachine.prototype._iter=function(iterMethod){return function(){var numArgs=arguments.length,states=utils.args(arguments,0,numArgs-1),callback=arguments[numArgs-1];states.length||(states=this.stateNames);var self=this,paths=states.reduce(function(paths,state){return paths.concat(Object.keys(self.states[state]))},[]);return paths[iterMethod](function(path,i,paths){return callback(path,i,paths)})}},StateMachine.prototype.forEach=function(){return this.forEach=this._iter("forEach"),this.forEach.apply(this,arguments)},StateMachine.prototype.map=function(){return this.map=this._iter("map"),this.map.apply(this,arguments)}},{"./utils":47}],41:[function(require,module,exports){(function(Buffer){function MongooseArray(values,path,doc){var arr=[];return arr.push.apply(arr,values),utils.decorate(arr,MongooseArray.mixin),arr.isMongooseArray=!0,arr._atomics={},arr.validators=[],arr._path=path,doc&&(arr._parent=doc,arr._schema=doc.schema.path(path)),arr}var EmbeddedDocument=require("./embedded"),Document=require("../document"),ObjectId=require("./objectid"),utils=require("../utils"),isMongooseObject=utils.isMongooseObject;MongooseArray.mixin={_atomics:void 0,_parent:void 0,_cast:function(value){var Model,owner=this._owner,populated=!1;return this._parent&&(owner||(owner=this._owner=this._parent.ownerDocument?this._parent.ownerDocument():this._parent),populated=owner.populated(this._path,!0)),populated&&null!=value?(Model=populated.options.model,(Buffer.isBuffer(value)||value instanceof ObjectId||!utils.isObject(value))&&(value={_id:value}),value=new Model(value),this._schema.caster.cast(value,this._parent,!0)):this._schema.caster.cast(value,this._parent,!1)},_markModified:function(elem,embeddedPath){var dirtyPath,parent=this._parent;return parent&&(dirtyPath=this._path,arguments.length&&(dirtyPath=null!=embeddedPath?dirtyPath+"."+this.indexOf(elem)+"."+embeddedPath:dirtyPath+"."+elem),parent.markModified(dirtyPath)),this},_registerAtomic:function(op,val){if("$set"==op)return this._atomics={$set:val},this;var atomics=this._atomics;if("$pop"==op&&!("$pop"in atomics)){var self=this;this._parent.once("save",function(){self._popped=self._shifted=null})}if(this._atomics.$set||Object.keys(atomics).length&&!(op in atomics))return this._atomics={$set:this},this;if("$pullAll"===op||"$pushAll"===op||"$addToSet"===op)atomics[op]||(atomics[op]=[]),atomics[op]=atomics[op].concat(val);else if("$pullDocs"===op){var pullOp=atomics.$pull||(atomics.$pull={}),selector=pullOp._id||(pullOp._id={$in:[]});selector.$in=selector.$in.concat(val)}else atomics[op]=val;return this},$__getAtomics:function(){var ret=[],keys=Object.keys(this._atomics),i=keys.length;if(0===i)return ret[0]=["$set",this.toObject({depopulate:1})],ret;for(;i--;){var op=keys[i],val=this._atomics[op];isMongooseObject(val)?val=val.toObject({depopulate:1}):Array.isArray(val)?val=this.toObject.call(val,{depopulate:1}):val.valueOf&&(val=val.valueOf()),"$addToSet"==op&&(val={$each:val}),ret.push([op,val])}return ret},hasAtomics:function(){return this._atomics&&"Object"===this._atomics.constructor.name?Object.keys(this._atomics).length:0},push:function(){var values=[].map.call(arguments,this._cast,this),ret=[].push.apply(this,values);return this._registerAtomic("$pushAll",values),this._markModified(),ret},nonAtomicPush:function(){var values=[].map.call(arguments,this._cast,this),ret=[].push.apply(this,values);return this._registerAtomic("$set",this),this._markModified(),ret},$pop:function(){return this._registerAtomic("$pop",1),this._markModified(),this._popped?void 0:(this._popped=!0,[].pop.call(this))},pop:function(){var ret=[].pop.call(this);return this._registerAtomic("$set",this),this._markModified(),ret},$shift:function(){return this._registerAtomic("$pop",-1),this._markModified(),this._shifted?void 0:(this._shifted=!0,[].shift.call(this))},shift:function(){var ret=[].shift.call(this);return this._registerAtomic("$set",this),this._markModified(),ret},pull:function(){for(var mem,values=[].map.call(arguments,this._cast,this),cur=this._parent.get(this._path),i=cur.length;i--;)mem=cur[i],mem instanceof EmbeddedDocument?values.some(function(v){return v.equals(mem)})&&[].splice.call(cur,i,1):~cur.indexOf.call(values,mem)&&[].splice.call(cur,i,1);return values[0]instanceof EmbeddedDocument?this._registerAtomic("$pullDocs",values.map(function(v){return v._id})):this._registerAtomic("$pullAll",values),this._markModified(),this},splice:function(){var ret,vals,i;if(arguments.length){for(vals=[],i=0;i<arguments.length;++i)vals[i]=2>i?arguments[i]:this._cast(arguments[i]);ret=[].splice.apply(this,vals),this._registerAtomic("$set",this),this._markModified()}return ret},unshift:function(){var values=[].map.call(arguments,this._cast,this);return[].unshift.apply(this,values),this._registerAtomic("$set",this),this._markModified(),this.length},sort:function(){var ret=[].sort.apply(this,arguments);return this._registerAtomic("$set",this),this._markModified(),ret},addToSet:function(){var values=[].map.call(arguments,this._cast,this),added=[],type=values[0]instanceof EmbeddedDocument?"doc":values[0]instanceof Date?"date":"";return values.forEach(function(v){var found;switch(type){case"doc":found=this.some(function(doc){return doc.equals(v)});break;case"date":var val=+v;found=this.some(function(d){return+d===val});break;default:found=~this.indexOf(v)}found||([].push.call(this,v),this._registerAtomic("$addToSet",v),this._markModified(),[].push.call(added,v))},this),added},set:function(i,val){return this[i]=this._cast(val),this._markModified(i),this},toObject:function(options){return options&&options.depopulate?this.map(function(doc){return doc instanceof Document?doc.toObject(options):doc}):this.slice()},inspect:function(){return JSON.stringify(this)},indexOf:function(obj){obj instanceof ObjectId&&(obj=obj.toString());for(var i=0,len=this.length;len>i;++i)if(obj==this[i])return i;return-1}},MongooseArray.mixin.remove=MongooseArray.mixin.pull,module.exports=exports=MongooseArray}).call(this,require("buffer").Buffer)},{"../document":13,"../utils":47,"./embedded":44,"./objectid":46,buffer:2}],42:[function(require,module){(function(global,Buffer){function MongooseBuffer(value,encode,offset){var val,length=arguments.length;val=0===length||null===arguments[0]||void 0===arguments[0]?0:value;var encoding,path,doc;Array.isArray(encode)?(path=encode[0],doc=encode[1]):encoding=encode;var buf=new Buffer(val,encoding,offset);return utils.decorate(buf,MongooseBuffer.mixin),buf.isMongooseBuffer=!0,Object.defineProperties(buf,{validators:{value:[]},_path:{value:path},_parent:{value:doc}}),doc&&"string"==typeof path&&Object.defineProperty(buf,"_schema",{value:doc.schema.path(path)}),buf._subtype=0,buf}var Binary=(global.MONGOOSE_DRIVER_PATH||"../drivers/node-mongodb-native",require("../drivers/node-mongodb-native/binary")),utils=require("../utils");MongooseBuffer.mixin={_parent:void 0,_subtype:void 0,_markModified:function(){var parent=this._parent;return parent&&parent.markModified(this._path),this},write:function(){var written=Buffer.prototype.write.apply(this,arguments);return written>0&&this._markModified(),written},copy:function(target){var ret=Buffer.prototype.copy.apply(this,arguments);return target&&target.isMongooseBuffer&&target._markModified(),ret}},"writeUInt8 writeUInt16 writeUInt32 writeInt8 writeInt16 writeInt32 writeFloat writeDouble fill utf8Write binaryWrite asciiWrite set writeUInt16LE writeUInt16BE writeUInt32LE writeUInt32BE writeInt16LE writeInt16BE writeInt32LE writeInt32BE writeFloatLE writeFloatBE writeDoubleLE writeDoubleBE".split(" ").forEach(function(method){Buffer.prototype[method]&&(MongooseBuffer.mixin[method]=new Function("var ret = Buffer.prototype."+method+".apply(this, arguments);this._markModified();return ret;"))}),MongooseBuffer.mixin.toObject=function(options){var subtype="number"==typeof options?options:this._subtype||0;return new Binary(this,subtype)},MongooseBuffer.mixin.equals=function(other){if(!Buffer.isBuffer(other))return!1;if(this.length!==other.length)return!1;for(var i=0;i<this.length;++i)if(this[i]!==other[i])return!1;return!0},MongooseBuffer.mixin.subtype=function(subtype){if("number"!=typeof subtype)throw new TypeError("Invalid subtype. Expected a number");this._subtype!=subtype&&this._markModified(),this._subtype=subtype},MongooseBuffer.Binary=Binary,module.exports=MongooseBuffer}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},require("buffer").Buffer)},{"../drivers/node-mongodb-native/binary":15,"../utils":47,buffer:2}],43:[function(require,module){(function(Buffer){function MongooseDocumentArray(values,path,doc){var arr=[];return arr.push.apply(arr,values),utils.decorate(arr,MongooseDocumentArray.mixin),arr.isMongooseArray=!0,arr.isMongooseDocumentArray=!0,arr._atomics={},arr.validators=[],arr._path=path,doc&&(arr._parent=doc,arr._schema=doc.schema.path(path),arr._handlers={isNew:arr.notify("isNew"),save:arr.notify("save")},doc.on("save",arr._handlers.save),doc.on("isNew",arr._handlers.isNew)),arr}var MongooseArray=require("./array"),ObjectId=require("../drivers/node-mongodb-native/objectid"),ObjectIdSchema=require("../schema/objectid"),utils=require("../utils"),util=require("util"),Document=require("../document");MongooseDocumentArray.mixin=Object.create(MongooseArray.mixin),MongooseDocumentArray.mixin._cast=function(value){return value instanceof this._schema.casterConstructor?(value.__parent&&value.__parentArray||(value.__parent=this._parent,value.__parentArray=this),value):((Buffer.isBuffer(value)||value instanceof ObjectId||!utils.isObject(value))&&(value={_id:value}),new this._schema.casterConstructor(value,this))},MongooseDocumentArray.mixin.id=function(id){var casted,sid,_id;try{var casted_=ObjectIdSchema.prototype.cast.call({},id);casted_&&(casted=String(casted_))}catch(e){casted=null}for(var i=0,l=this.length;l>i;i++)if(_id=this[i].get("_id"),_id instanceof Document){if(sid||(sid=String(id)),sid==_id._id)return this[i]}else if(_id instanceof ObjectId){if(casted==_id)return this[i]}else if(sid||(sid=String(id)),sid==_id)return this[i];return null},MongooseDocumentArray.mixin.toObject=function(options){return this.map(function(doc){return doc&&doc.toObject(options)||null})},MongooseDocumentArray.mixin.inspect=function(){return"["+this.map(function(doc){return doc?doc.inspect?doc.inspect():util.inspect(doc):"null"}).join("\n")+"]"},MongooseDocumentArray.mixin.create=function(obj){return new this._schema.casterConstructor(obj)},MongooseDocumentArray.mixin.notify=function(event){var self=this;return function(val){for(var i=self.length;i--;)if(self[i]){switch(event){case"save":val=self[i]}self[i].emit(event,val)}}},module.exports=MongooseDocumentArray}).call(this,require("buffer").Buffer)},{"../document":13,"../drivers/node-mongodb-native/objectid":16,"../schema/objectid":37,"../utils":47,"./array":41,buffer:2,util:10}],44:[function(require,module){function EmbeddedDocument(obj,parentArr,skipId,fields){parentArr?(this.__parentArray=parentArr,this.__parent=parentArr._parent):(this.__parentArray=void 0,this.__parent=void 0),Document.call(this,obj,fields,skipId);var self=this;this.on("isNew",function(val){self.isNew=val})}function registerRemoveListener(sub){function emitRemove(){owner.removeListener("save",emitRemove),owner.removeListener("remove",emitRemove),sub.emit("remove",sub),owner=sub=emitRemove=null}var owner=sub.ownerDocument();owner.on("save",emitRemove),owner.on("remove",emitRemove)}var Document=require("../document_provider")(),inspect=require("util").inspect,Promise=require("../promise");EmbeddedDocument.prototype=Object.create(Document.prototype),EmbeddedDocument.prototype.constructor=EmbeddedDocument,EmbeddedDocument.prototype.markModified=function(path){this.__parentArray&&(this.$__.activePaths.modify(path),this.isNew?this.__parentArray._markModified():this.__parentArray._markModified(this,path))},EmbeddedDocument.prototype.save=function(fn){var promise=new Promise(fn);return promise.fulfill(),promise},EmbeddedDocument.prototype.remove=function(fn){if(!this.__parentArray)return this;var _id;if(!this.willRemove){if(_id=this._doc._id,!_id)throw new Error("For your own good, Mongoose does not know how to remove an EmbeddedDocument that has no _id");this.__parentArray.pull({_id:_id}),this.willRemove=!0,registerRemoveListener(this)}return fn&&fn(null),this},EmbeddedDocument.prototype.update=function(){throw new Error("The #update method is not available on EmbeddedDocuments")},EmbeddedDocument.prototype.inspect=function(){return inspect(this.toObject())},EmbeddedDocument.prototype.invalidate=function(path,err,val,first){if(!this.__parent){var msg="Unable to invalidate a subdocument that has not been added to an array.";throw new Error(msg)}var index=this.__parentArray.indexOf(this),parentPath=this.__parentArray._path,fullPath=[parentPath,index,path].join(".");return 2<arguments.length?this.__parent.invalidate(fullPath,err,val):this.__parent.invalidate(fullPath,err),first&&(this.$__.validationError=this.ownerDocument().$__.validationError),!0},EmbeddedDocument.prototype.ownerDocument=function(){if(this.$__.ownerDocument)return this.$__.ownerDocument;var parent=this.__parent;if(!parent)return this;for(;parent.__parent;)parent=parent.__parent;return this.$__.ownerDocument=parent},EmbeddedDocument.prototype.$__fullPath=function(path){if(!this.$__.fullPath){var parent=this;if(!parent.__parent)return path;for(var paths=[];parent.__parent;)paths.unshift(parent.__parentArray._path),parent=parent.__parent;this.$__.fullPath=paths.join("."),this.$__.ownerDocument||(this.$__.ownerDocument=parent)}return path?this.$__.fullPath+"."+path:this.$__.fullPath},EmbeddedDocument.prototype.parent=function(){return this.__parent},EmbeddedDocument.prototype.parentArray=function(){return this.__parentArray},module.exports=EmbeddedDocument},{"../document_provider":14,"../promise":27,util:10}],45:[function(require,module,exports){exports.Array=require("./array"),exports.Buffer=require("./buffer"),exports.Document=exports.Embedded=require("./embedded"),exports.DocumentArray=require("./documentarray"),exports.ObjectId=require("./objectid")},{"./array":41,"./buffer":42,"./documentarray":43,"./embedded":44,"./objectid":46}],46:[function(require,module){(function(global){var ObjectId=(global.MONGOOSE_DRIVER_PATH||"../drivers/node-mongodb-native",require("../drivers/node-mongodb-native/objectid"));module.exports=ObjectId}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../drivers/node-mongodb-native/objectid":16}],47:[function(require,module,exports){(function(process,Buffer){function pluralize(str){var found;return!~uncountables.indexOf(str.toLowerCase())&&(found=rules.filter(function(rule){return str.match(rule[0])}),found[0])?str.replace(found[0][0],found[0][1]):str}function cloneObject(obj,options){var hasKeys,keys,val,k,i,retainKeyOrder=options&&options.retainKeyOrder,minimize=options&&options.minimize,ret={};if(retainKeyOrder)for(k in obj)val=clone(obj[k],options),minimize&&"undefined"==typeof val||(hasKeys||(hasKeys=!0),ret[k]=val);else for(keys=Object.keys(obj),i=keys.length;i--;)k=keys[i],val=clone(obj[k],options),minimize&&"undefined"==typeof val||(hasKeys||(hasKeys=!0),ret[k]=val);return minimize?hasKeys&&ret:ret}function cloneArray(arr,options){for(var ret=[],i=0,l=arr.length;l>i;i++)ret.push(clone(arr[i],options));return ret}function PopulateOptions(path,select,match,options,model){this.path=path,this.match=match,this.select=select,this.options=options,this.model=model,this._docs={}}var MongooseBuffer,MongooseArray,Document,ReadPref=require("mongodb/lib/mongodb/connection/read_preference").ReadPreference,ObjectId=require("./types/objectid"),cloneRegExp=require("regexp-clone"),sliced=require("sliced"),mpath=require("mpath"),ms=require("ms");exports.toCollectionName=function(name,options){return options=options||{},"system.profile"===name?name:"system.indexes"===name?name:options.pluralization===!1?name:pluralize(name.toLowerCase())},exports.pluralization=[[/(m)an$/gi,"$1en"],[/(pe)rson$/gi,"$1ople"],[/(child)$/gi,"$1ren"],[/^(ox)$/gi,"$1en"],[/(ax|test)is$/gi,"$1es"],[/(octop|vir)us$/gi,"$1i"],[/(alias|status)$/gi,"$1es"],[/(bu)s$/gi,"$1ses"],[/(buffal|tomat|potat)o$/gi,"$1oes"],[/([ti])um$/gi,"$1a"],[/sis$/gi,"ses"],[/(?:([^f])fe|([lr])f)$/gi,"$1$2ves"],[/(hive)$/gi,"$1s"],[/([^aeiouy]|qu)y$/gi,"$1ies"],[/(x|ch|ss|sh)$/gi,"$1es"],[/(matr|vert|ind)ix|ex$/gi,"$1ices"],[/([m|l])ouse$/gi,"$1ice"],[/(kn|w|l)ife$/gi,"$1ives"],[/(quiz)$/gi,"$1zes"],[/s$/gi,"s"],[/([^a-z])$/,"$1"],[/$/gi,"s"]];var rules=exports.pluralization;exports.uncountables=["advice","energy","excretion","digestion","cooperation","health","justice","labour","machinery","equipment","information","pollution","sewage","paper","money","species","series","rain","rice","fish","sheep","moose","deer","news","expertise","status","media"];
var uncountables=exports.uncountables;exports.deepEqual=function deepEqual(a,b){if(a===b)return!0;if(a instanceof Date&&b instanceof Date)return a.getTime()===b.getTime();if(a instanceof ObjectId&&b instanceof ObjectId)return a.toString()===b.toString();if(a instanceof RegExp&&b instanceof RegExp)return a.source==b.source&&a.ignoreCase==b.ignoreCase&&a.multiline==b.multiline&&a.global==b.global;if("object"!=typeof a&&"object"!=typeof b)return a==b;if(null===a||null===b||void 0===a||void 0===b)return!1;if(a.prototype!==b.prototype)return!1;if(a instanceof Number&&b instanceof Number)return a.valueOf()===b.valueOf();if(Buffer.isBuffer(a))return exports.buffer.areEqual(a,b);isMongooseObject(a)&&(a=a.toObject()),isMongooseObject(b)&&(b=b.toObject());try{var key,i,ka=Object.keys(a),kb=Object.keys(b)}catch(e){return!1}if(ka.length!=kb.length)return!1;for(ka.sort(),kb.sort(),i=ka.length-1;i>=0;i--)if(ka[i]!=kb[i])return!1;for(i=ka.length-1;i>=0;i--)if(key=ka[i],!deepEqual(a[key],b[key]))return!1;return!0},exports.clone=function(obj,options){if(void 0===obj||null===obj)return obj;if(Array.isArray(obj))return cloneArray(obj,options);if(isMongooseObject(obj))return options&&options.json&&"function"==typeof obj.toJSON?obj.toJSON(options):obj.toObject(options);if(obj.constructor)switch(exports.getFunctionName(obj.constructor)){case"Object":return cloneObject(obj,options);case"Date":return new obj.constructor(+obj);case"RegExp":return cloneRegExp(obj)}return obj instanceof ObjectId?new ObjectId(obj.id):!obj.constructor&&exports.isObject(obj)?cloneObject(obj,options):obj.valueOf?obj.valueOf():void 0};var clone=exports.clone;exports.options=function(defaults,options){var k,keys=Object.keys(defaults),i=keys.length;for(options=options||{};i--;)k=keys[i],k in options||(options[k]=defaults[k]);return options},exports.random=function(){return Math.random().toString().substr(3)},exports.merge=function merge(to,from){for(var key,keys=Object.keys(from),i=keys.length;i--;)key=keys[i],"undefined"==typeof to[key]?to[key]=from[key]:exports.isObject(from[key])&&merge(to[key],from[key])};var toString=Object.prototype.toString;exports.isObject=function(arg){return"[object Object]"==toString.call(arg)},exports.args=sliced,exports.tick=function(callback){return"function"==typeof callback?function(){try{callback.apply(this,arguments)}catch(err){process.nextTick(function(){throw err})}}:void 0},exports.isMongooseObject=function(v){return Document||(Document=require("./document")),MongooseArray||(MongooseArray=require("./types").Array),MongooseBuffer||(MongooseBuffer=require("./types").Buffer),v instanceof Document||v&&v.isMongooseArray||v&&v.isMongooseBuffer};var isMongooseObject=exports.isMongooseObject;exports.expires=function(object){if(object&&"Object"==object.constructor.name&&"expires"in object){var when;when="string"!=typeof object.expires?object.expires:Math.round(ms(object.expires)/1e3),object.expireAfterSeconds=when,delete object.expires}},exports.readPref=function(pref,tags){switch(Array.isArray(pref)&&(tags=pref[1],pref=pref[0]),pref){case"p":pref="primary";break;case"pp":pref="primaryPreferred";break;case"s":pref="secondary";break;case"sp":pref="secondaryPreferred";break;case"n":pref="nearest"}return new ReadPref(pref,tags)},PopulateOptions.prototype.constructor=Object,exports.PopulateOptions=PopulateOptions,exports.populate=function(path,select,model,match,options){if(1===arguments.length){if(path instanceof PopulateOptions)return[path];if(Array.isArray(path))return path.map(function(o){return exports.populate(o)[0]});exports.isObject(path)&&(match=path.match,options=path.options,select=path.select,model=path.model,path=path.path)}else"string"!=typeof model&&"function"!=typeof model&&(options=match,match=model,model=void 0);if("string"!=typeof path)throw new TypeError("utils.populate: invalid path. Expected string. Got typeof `"+typeof path+"`");for(var ret=[],paths=path.split(" "),i=0;i<paths.length;++i)ret.push(new PopulateOptions(paths[i],select,match,options,model));return ret},exports.getValue=function(path,obj,map){return mpath.get(path,obj,"_doc",map)},exports.setValue=function(path,val,obj,map){mpath.set(path,val,obj,"_doc",map)},exports.object={},exports.object.vals=function(o){for(var keys=Object.keys(o),i=keys.length,ret=[];i--;)ret.push(o[keys[i]]);return ret},exports.object.shallowCopy=exports.options;var hop=Object.prototype.hasOwnProperty;exports.object.hasOwnProperty=function(obj,prop){return hop.call(obj,prop)},exports.isNullOrUndefined=function(val){return null==val},exports.array={},exports.array.flatten=function flatten(arr,filter,ret){return ret||(ret=[]),arr.forEach(function(item){Array.isArray(item)?flatten(item,filter,ret):(!filter||filter(item))&&ret.push(item)}),ret},exports.buffer={},exports.buffer.areEqual=function(a,b){if(!Buffer.isBuffer(a))return!1;if(!Buffer.isBuffer(b))return!1;if(a.length!==b.length)return!1;for(var i=0,len=a.length;len>i;++i)if(a[i]!==b[i])return!1;return!0},exports.getFunctionName=function(fn){return fn.name?fn.name:(fn.toString().trim().match(/^function\s*([^\s(]+)/)||[])[1]},exports.decorate=function(destination,source){for(var key in source)destination[key]=source[key]}}).call(this,require("_process"),require("buffer").Buffer)},{"./document":13,"./types":45,"./types/objectid":46,_process:8,buffer:2,"mongodb/lib/mongodb/connection/read_preference":50,mpath:64,ms:68,"regexp-clone":69,sliced:70}],48:[function(require,module){function VirtualType(options,name){this.path=name,this.getters=[],this.setters=[],this.options=options||{}}VirtualType.prototype.get=function(fn){return this.getters.push(fn),this},VirtualType.prototype.set=function(fn){return this.setters.push(fn),this},VirtualType.prototype.applyGetters=function(value,scope){for(var v=value,l=this.getters.length-1;l>=0;l--)v=this.getters[l].call(scope,v,this);return v},VirtualType.prototype.applySetters=function(value,scope){for(var v=value,l=this.setters.length-1;l>=0;l--)v=this.setters[l].call(scope,v,this);return v},module.exports=VirtualType},{}],49:[function(require,module){function once(fn,scope){return function fnWrapper(){return fnWrapper.hookCalled?void 0:(fnWrapper.hookCalled=!0,fn.apply(scope,arguments))}}module.exports={hook:function(name,fn,errorCb){if(1!==arguments.length||"object"!=typeof name){var proto=this.prototype||this,pres=proto._pres=proto._pres||{},posts=proto._posts=proto._posts||{};return pres[name]=pres[name]||[],posts[name]=posts[name]||[],proto[name]=function(){function _asyncsDone(err){return err&&err instanceof Error?handleError(err):void(--_asyncsLeft||_done.apply(self,hookArgs))}function handleError(err){if("function"==typeof lastArg)return lastArg(err);if(errorCb)return errorCb.call(self,err);throw err}var hookArgs,self=this,lastArg=arguments[arguments.length-1],pres=this._pres[name],posts=this._posts[name],_total=pres.length,_current=-1,_asyncsLeft=proto[name].numAsyncPres,_next=function(){if(arguments[0]instanceof Error)return handleError(arguments[0]);var currPre,preArgs,_args=Array.prototype.slice.call(arguments);if(!_args.length||null==arguments[0]&&"function"==typeof lastArg||(hookArgs=_args),++_current<_total){if(currPre=pres[_current],currPre.isAsync&&currPre.length<2)throw new Error("Your pre must have next and done arguments -- e.g., function (next, done, ...)");if(currPre.length<1)throw new Error("Your pre must have a next argument -- e.g., function (next, ...)");return preArgs=(currPre.isAsync?[once(_next),once(_asyncsDone)]:[once(_next)]).concat(hookArgs),currPre.apply(self,preArgs)}return proto[name].numAsyncPres?void 0:_done.apply(self,hookArgs)},_done=function(){var ret,total_,current_,next_,args_=Array.prototype.slice.call(arguments);return _current===_total?(next_=function(){if(arguments[0]instanceof Error)return handleError(arguments[0]);var currPost,postArgs,args_=Array.prototype.slice.call(arguments,1);if(args_.length&&(hookArgs=args_),++current_<total_){if(currPost=posts[current_],currPost.length<1)throw new Error("Your post must have a next argument -- e.g., function (next, ...)");return postArgs=[once(next_)].concat(hookArgs),currPost.apply(self,postArgs)}return"function"==typeof lastArg?lastArg.apply(self,arguments):void 0},"function"==typeof lastArg&&(args_[args_.length-1]=once(next_)),total_=posts.length,current_=-1,ret=fn.apply(self,args_),total_&&"function"!=typeof lastArg?next_():ret):void 0};return _next.apply(this,arguments)},proto[name].numAsyncPres=0,this}for(var k in name)this.hook(k,name[k])},pre:function(name,isAsync,fn,errorCb){"boolean"!=typeof arguments[1]&&(errorCb=fn,fn=isAsync,isAsync=!1);var proto=this.prototype||this,pres=proto._pres=proto._pres||{};return this._lazySetupHooks(proto,name,errorCb),(fn.isAsync=isAsync)&&proto[name].numAsyncPres++,(pres[name]=pres[name]||[]).push(fn),this},post:function(name,isAsync,fn){2===arguments.length&&(fn=isAsync,isAsync=!1);var proto=this.prototype||this,posts=proto._posts=proto._posts||{};return this._lazySetupHooks(proto,name),(posts[name]=posts[name]||[]).push(fn),this},removePre:function(name,fnToRemove){var proto=this.prototype||this,pres=proto._pres||proto._pres||{};return pres[name]?(1===arguments.length?pres[name].length=0:pres[name]=pres[name].filter(function(currFn){return currFn!==fnToRemove}),this):this},_lazySetupHooks:function(proto,methodName,errorCb){"undefined"==typeof proto[methodName].numAsyncPres&&this.hook(methodName,proto[methodName],errorCb)}}},{}],50:[function(require,module,exports){var ReadPreference=function(mode,tags){return this instanceof ReadPreference?(this._type="ReadPreference",this.mode=mode,void(this.tags=tags)):new ReadPreference(mode,tags)};ReadPreference.isValid=function(_mode){return _mode==ReadPreference.PRIMARY||_mode==ReadPreference.PRIMARY_PREFERRED||_mode==ReadPreference.SECONDARY||_mode==ReadPreference.SECONDARY_PREFERRED||_mode==ReadPreference.NEAREST||1==_mode||0==_mode||null==_mode},ReadPreference.prototype.isValid=function(mode){var _mode="string"==typeof mode?mode:this.mode;return ReadPreference.isValid(_mode)},ReadPreference.prototype.toObject=function(){var object={mode:this.mode};return null!=this.tags&&(object.tags=this.tags),object},ReadPreference.PRIMARY="primary",ReadPreference.PRIMARY_PREFERRED="primaryPreferred",ReadPreference.SECONDARY="secondary",ReadPreference.SECONDARY_PREFERRED="secondaryPreferred",ReadPreference.NEAREST="nearest",exports.ReadPreference=ReadPreference},{}],51:[function(require,module,exports){function Binary(buffer,subType){if(!(this instanceof Binary))return new Binary(buffer,subType);if(this._bsontype="Binary",buffer instanceof Number?(this.sub_type=buffer,this.position=0):(this.sub_type=null==subType?BSON_BINARY_SUBTYPE_DEFAULT:subType,this.position=0),null==buffer||buffer instanceof Number)this.buffer="undefined"!=typeof Buffer?new Buffer(Binary.BUFFER_SIZE):"undefined"!=typeof Uint8Array?new Uint8Array(new ArrayBuffer(Binary.BUFFER_SIZE)):new Array(Binary.BUFFER_SIZE),this.position=0;else{if("string"==typeof buffer)if("undefined"!=typeof Buffer)this.buffer=new Buffer(buffer);else{if("undefined"==typeof Uint8Array&&"[object Array]"!=Object.prototype.toString.call(buffer))throw new Error("only String, Buffer, Uint8Array or Array accepted");this.buffer=writeStringToArray(buffer)}else this.buffer=buffer;this.position=buffer.length}}if("undefined"==typeof window)var Buffer=require("buffer").Buffer;var BSON_BINARY_SUBTYPE_DEFAULT=0,writeStringToArray=function(data){for(var buffer="undefined"!=typeof Uint8Array?new Uint8Array(new ArrayBuffer(data.length)):new Array(data.length),i=0;i<data.length;i++)buffer[i]=data.charCodeAt(i);return buffer},convertArraytoUtf8BinaryString=function(byteArray,startIndex,endIndex){for(var result="",i=startIndex;endIndex>i;i++)result+=String.fromCharCode(byteArray[i]);return result};Binary.prototype.put=function(byte_value){if(null!=byte_value.length&&"number"!=typeof byte_value&&1!=byte_value.length)throw new Error("only accepts single character String, Uint8Array or Array");if("number"!=typeof byte_value&&0>byte_value||byte_value>255)throw new Error("only accepts number in a valid unsigned byte range 0-255");var decoded_byte=null;if(decoded_byte="string"==typeof byte_value?byte_value.charCodeAt(0):null!=byte_value.length?byte_value[0]:byte_value,this.buffer.length>this.position)this.buffer[this.position++]=decoded_byte;else if("undefined"!=typeof Buffer&&Buffer.isBuffer(this.buffer)){var buffer=new Buffer(Binary.BUFFER_SIZE+this.buffer.length);this.buffer.copy(buffer,0,0,this.buffer.length),this.buffer=buffer,this.buffer[this.position++]=decoded_byte}else{var buffer=null;buffer="[object Uint8Array]"==Object.prototype.toString.call(this.buffer)?new Uint8Array(new ArrayBuffer(Binary.BUFFER_SIZE+this.buffer.length)):new Array(Binary.BUFFER_SIZE+this.buffer.length);for(var i=0;i<this.buffer.length;i++)buffer[i]=this.buffer[i];this.buffer=buffer,this.buffer[this.position++]=decoded_byte}},Binary.prototype.write=function(string,offset){if(offset="number"==typeof offset?offset:this.position,this.buffer.length<offset+string.length){var buffer=null;if("undefined"!=typeof Buffer&&Buffer.isBuffer(this.buffer))buffer=new Buffer(this.buffer.length+string.length),this.buffer.copy(buffer,0,0,this.buffer.length);else if("[object Uint8Array]"==Object.prototype.toString.call(this.buffer)){buffer=new Uint8Array(new ArrayBuffer(this.buffer.length+string.length));for(var i=0;i<this.position;i++)buffer[i]=this.buffer[i]}this.buffer=buffer}if("undefined"!=typeof Buffer&&Buffer.isBuffer(string)&&Buffer.isBuffer(this.buffer))string.copy(this.buffer,offset,0,string.length),this.position=offset+string.length>this.position?offset+string.length:this.position;else if("undefined"!=typeof Buffer&&"string"==typeof string&&Buffer.isBuffer(this.buffer))this.buffer.write(string,"binary",offset),this.position=offset+string.length>this.position?offset+string.length:this.position;else if("[object Uint8Array]"==Object.prototype.toString.call(string)||"[object Array]"==Object.prototype.toString.call(string)&&"string"!=typeof string){for(var i=0;i<string.length;i++)this.buffer[offset++]=string[i];this.position=offset>this.position?offset:this.position}else if("string"==typeof string){for(var i=0;i<string.length;i++)this.buffer[offset++]=string.charCodeAt(i);this.position=offset>this.position?offset:this.position}},Binary.prototype.read=function(position,length){if(length=length&&length>0?length:this.position,this.buffer.slice)return this.buffer.slice(position,position+length);for(var buffer="undefined"!=typeof Uint8Array?new Uint8Array(new ArrayBuffer(length)):new Array(length),i=0;length>i;i++)buffer[i]=this.buffer[position++];return buffer},Binary.prototype.value=function(asRaw){if(asRaw=null==asRaw?!1:asRaw,asRaw&&"undefined"!=typeof Buffer&&Buffer.isBuffer(this.buffer)&&this.buffer.length==this.position)return this.buffer;if("undefined"!=typeof Buffer&&Buffer.isBuffer(this.buffer))return asRaw?this.buffer.slice(0,this.position):this.buffer.toString("binary",0,this.position);if(asRaw){if(null!=this.buffer.slice)return this.buffer.slice(0,this.position);for(var newBuffer="[object Uint8Array]"==Object.prototype.toString.call(this.buffer)?new Uint8Array(new ArrayBuffer(this.position)):new Array(this.position),i=0;i<this.position;i++)newBuffer[i]=this.buffer[i];return newBuffer}return convertArraytoUtf8BinaryString(this.buffer,0,this.position)},Binary.prototype.length=function(){return this.position},Binary.prototype.toJSON=function(){return null!=this.buffer?this.buffer.toString("base64"):""},Binary.prototype.toString=function(format){return null!=this.buffer?this.buffer.slice(0,this.position).toString(format):""},Binary.BUFFER_SIZE=256,Binary.SUBTYPE_DEFAULT=0,Binary.SUBTYPE_FUNCTION=1,Binary.SUBTYPE_BYTE_ARRAY=2,Binary.SUBTYPE_UUID_OLD=3,Binary.SUBTYPE_UUID=4,Binary.SUBTYPE_MD5=5,Binary.SUBTYPE_USER_DEFINED=128,exports.Binary=Binary},{buffer:2}],52:[function(require,module,exports){(function(process){function BinaryParser(bigEndian,allowExceptions){return this instanceof BinaryParser?(this.bigEndian=bigEndian,void(this.allowExceptions=allowExceptions)):new BinaryParser(bigEndian,allowExceptions)}function BinaryParserBuffer(bigEndian,buffer){this.bigEndian=bigEndian||0,this.buffer=[],this.setBuffer(buffer)}for(var chr=String.fromCharCode,maxBits=[],i=0;64>i;i++)maxBits[i]=Math.pow(2,i);BinaryParser.warn=function(msg){if(this.allowExceptions)throw new Error(msg);return 1},BinaryParser.decodeFloat=function(data,precisionBits,exponentBits){var b=new this.Buffer(this.bigEndian,data);b.checkBuffer(precisionBits+exponentBits+1);var bias=maxBits[exponentBits-1]-1,signal=b.readBits(precisionBits+exponentBits,1),exponent=b.readBits(precisionBits,exponentBits),significand=0,divisor=2,curByte=b.buffer.length+(-precisionBits>>3)-1;do for(var byteValue=b.buffer[++curByte],startBit=precisionBits%8||8,mask=1<<startBit;mask>>=1;byteValue&mask&&(significand+=1/divisor),divisor*=2);while(precisionBits-=startBit);return exponent==(bias<<1)+1?significand?0/0:signal?-1/0:+1/0:(1+-2*signal)*(exponent||significand?exponent?Math.pow(2,exponent-bias)*(1+significand):Math.pow(2,-bias+1)*significand:0)},BinaryParser.decodeInt=function(data,bits,signed,forceBigEndian){var b=new this.Buffer(this.bigEndian||forceBigEndian,data),x=b.readBits(0,bits),max=maxBits[bits];return signed&&x>=max/2?x-max:x},BinaryParser.encodeFloat=function(data,precisionBits,exponentBits){var lastBit,rounded,result,i,j,bias=maxBits[exponentBits-1]-1,minExp=-bias+1,maxExp=bias,minUnnormExp=minExp-precisionBits,n=parseFloat(data),status=isNaN(n)||n==-1/0||n==+1/0?n:0,exp=0,len=2*bias+1+precisionBits+3,bin=new Array(len),signal=(n=0!==status?0:n)<0,intPart=Math.floor(n=Math.abs(n)),floatPart=n-intPart;for(i=len;i;bin[--i]=0);for(i=bias+2;intPart&&i;bin[--i]=intPart%2,intPart=Math.floor(intPart/2));for(i=bias+1;floatPart>0&&i;(bin[++i]=((floatPart*=2)>=1)-0)&&--floatPart);for(i=-1;++i<len&&!bin[i];);if(bin[(lastBit=precisionBits-1+(i=(exp=bias+1-i)>=minExp&&maxExp>=exp?i+1:bias+1-(exp=minExp-1)))+1]){if(!(rounded=bin[lastBit]))for(j=lastBit+2;!rounded&&len>j;rounded=bin[j++]);for(j=lastBit+1;rounded&&--j>=0;(bin[j]=!bin[j]-0)&&(rounded=0));}for(i=0>i-2?-1:i-3;++i<len&&!bin[i];);for((exp=bias+1-i)>=minExp&&maxExp>=exp?++i:minExp>exp&&(exp!=bias+1-len&&minUnnormExp>exp&&this.warn("encodeFloat::float underflow"),i=bias+1-(exp=minExp-1)),(intPart||0!==status)&&(this.warn(intPart?"encodeFloat::float overflow":"encodeFloat::"+status),exp=maxExp+1,i=bias+2,status==-1/0?signal=1:isNaN(status)&&(bin[i]=1)),n=Math.abs(exp+bias),j=exponentBits+1,result="";--j;result=n%2+result,n=n>>=1);for(n=0,j=0,i=(result=(signal?"1":"0")+result+bin.slice(i,i+precisionBits).join("")).length,r=[];i;j=(j+1)%8)n+=(1<<j)*result.charAt(--i),7==j&&(r[r.length]=String.fromCharCode(n),n=0);return r[r.length]=n?String.fromCharCode(n):"",(this.bigEndian?r.reverse():r).join("")},BinaryParser.encodeInt=function(data,bits,signed,forceBigEndian){var max=maxBits[bits];(data>=max||-(max/2)>data)&&(this.warn("encodeInt::overflow"),data=0),0>data&&(data+=max);for(var r=[];data;r[r.length]=String.fromCharCode(data%256),data=Math.floor(data/256));for(bits=-(-bits>>3)-r.length;bits--;r[r.length]="\x00");return(this.bigEndian||forceBigEndian?r.reverse():r).join("")},BinaryParser.toSmall=function(data){return this.decodeInt(data,8,!0)},BinaryParser.fromSmall=function(data){return this.encodeInt(data,8,!0)},BinaryParser.toByte=function(data){return this.decodeInt(data,8,!1)},BinaryParser.fromByte=function(data){return this.encodeInt(data,8,!1)},BinaryParser.toShort=function(data){return this.decodeInt(data,16,!0)},BinaryParser.fromShort=function(data){return this.encodeInt(data,16,!0)},BinaryParser.toWord=function(data){return this.decodeInt(data,16,!1)},BinaryParser.fromWord=function(data){return this.encodeInt(data,16,!1)},BinaryParser.toInt=function(data){return this.decodeInt(data,32,!0)},BinaryParser.fromInt=function(data){return this.encodeInt(data,32,!0)},BinaryParser.toLong=function(data){return this.decodeInt(data,64,!0)},BinaryParser.fromLong=function(data){return this.encodeInt(data,64,!0)},BinaryParser.toDWord=function(data){return this.decodeInt(data,32,!1)},BinaryParser.fromDWord=function(data){return this.encodeInt(data,32,!1)},BinaryParser.toQWord=function(data){return this.decodeInt(data,64,!0)},BinaryParser.fromQWord=function(data){return this.encodeInt(data,64,!0)},BinaryParser.toFloat=function(data){return this.decodeFloat(data,23,8)},BinaryParser.fromFloat=function(data){return this.encodeFloat(data,23,8)},BinaryParser.toDouble=function(data){return this.decodeFloat(data,52,11)},BinaryParser.fromDouble=function(data){return this.encodeFloat(data,52,11)},BinaryParser.encode_int32=function(number,asArray){var a,b,c,d,unsigned;return unsigned=0>number?number+4294967296:number,a=Math.floor(unsigned/16777215),unsigned&=16777215,b=Math.floor(unsigned/65535),unsigned&=65535,c=Math.floor(unsigned/255),unsigned&=255,d=Math.floor(unsigned),asArray?[chr(a),chr(b),chr(c),chr(d)]:chr(a)+chr(b)+chr(c)+chr(d)},BinaryParser.encode_int64=function(number){var a,b,c,d,e,f,g,h,unsigned;return unsigned=0>number?number+0x10000000000000000:number,a=Math.floor(unsigned/72057594037927940),unsigned&=72057594037927940,b=Math.floor(unsigned/0xffffffffffff),unsigned&=0xffffffffffff,c=Math.floor(unsigned/0xffffffffff),unsigned&=0xffffffffff,d=Math.floor(unsigned/4294967295),unsigned&=4294967295,e=Math.floor(unsigned/16777215),unsigned&=16777215,f=Math.floor(unsigned/65535),unsigned&=65535,g=Math.floor(unsigned/255),unsigned&=255,h=Math.floor(unsigned),chr(a)+chr(b)+chr(c)+chr(d)+chr(e)+chr(f)+chr(g)+chr(h)},BinaryParser.decode_utf8=function(binaryStr){for(var c3,len=binaryStr.length,decoded="",i=0,c=0,c2=0;len>i;)c=binaryStr.charCodeAt(i),128>c?(decoded+=String.fromCharCode(c),i++):c>191&&224>c?(c2=binaryStr.charCodeAt(i+1),decoded+=String.fromCharCode((31&c)<<6|63&c2),i+=2):(c2=binaryStr.charCodeAt(i+1),c3=binaryStr.charCodeAt(i+2),decoded+=String.fromCharCode((15&c)<<12|(63&c2)<<6|63&c3),i+=3);return decoded},BinaryParser.encode_cstring=function(s){return unescape(encodeURIComponent(s))+BinaryParser.fromByte(0)},BinaryParser.encode_utf8=function(s){for(var c,a="",n=0,len=s.length;len>n;n++)c=s.charCodeAt(n),128>c?a+=String.fromCharCode(c):c>127&&2048>c?(a+=String.fromCharCode(c>>6|192),a+=String.fromCharCode(63&c|128)):(a+=String.fromCharCode(c>>12|224),a+=String.fromCharCode(c>>6&63|128),a+=String.fromCharCode(63&c|128));return a},BinaryParser.hprint=function(s){for(var number,i=0,len=s.length;len>i;i++)s.charCodeAt(i)<32?(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16),process.stdout.write(number+" ")):(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16),process.stdout.write(number+" "));process.stdout.write("\n\n")},BinaryParser.ilprint=function(s){for(var number,i=0,len=s.length;len>i;i++)s.charCodeAt(i)<32?(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(10):s.charCodeAt(i).toString(10),require("util").debug(number+" : ")):(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(10):s.charCodeAt(i).toString(10),require("util").debug(number+" : "+s.charAt(i)))},BinaryParser.hlprint=function(s){for(var number,i=0,len=s.length;len>i;i++)s.charCodeAt(i)<32?(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16),require("util").debug(number+" : ")):(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16),require("util").debug(number+" : "+s.charAt(i)))},BinaryParserBuffer.prototype.setBuffer=function(data){var l,i,b;if(data){for(i=l=data.length,b=this.buffer=new Array(l);i;b[l-i]=data.charCodeAt(--i));this.bigEndian&&b.reverse()}},BinaryParserBuffer.prototype.hasNeededBits=function(neededBits){return this.buffer.length>=-(-neededBits>>3)},BinaryParserBuffer.prototype.checkBuffer=function(neededBits){if(!this.hasNeededBits(neededBits))throw new Error("checkBuffer::missing bytes")},BinaryParserBuffer.prototype.readBits=function(start,length){function shl(a,b){for(;b--;a=1073741824==(1073741824&(a%=2147483648))?2*a:2*(a-1073741824)+2147483647+1);return a}if(0>start||0>=length)return 0;this.checkBuffer(start+length);for(var offsetLeft,offsetRight=start%8,curByte=this.buffer.length-(start>>3)-1,lastByte=this.buffer.length+(-(start+length)>>3),diff=curByte-lastByte,sum=(this.buffer[curByte]>>offsetRight&(1<<(diff?8-offsetRight:length))-1)+(diff&&(offsetLeft=(start+length)%8)?(this.buffer[lastByte++]&(1<<offsetLeft)-1)<<(diff--<<3)-offsetRight:0);diff;sum+=shl(this.buffer[lastByte++],(diff--<<3)-offsetRight));return sum},BinaryParser.Buffer=BinaryParserBuffer,exports.BinaryParser=BinaryParser}).call(this,require("_process"))},{_process:8,util:10}],53:[function(require,module,exports){(function(Buffer){function BSON(){}function calculateElement(name,value,serializeFunctions){var isBuffer="undefined"!=typeof Buffer;switch(value&&value.toBSON&&(value=value.toBSON()),typeof value){case"string":return 1+(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1+4+(isBuffer?Buffer.byteLength(value,"utf8"):numberOfBytes(value))+1;case"number":return Math.floor(value)===value&&value>=BSON.JS_INT_MIN&&value<=BSON.JS_INT_MAX&&value>=BSON.BSON_INT32_MIN&&value<=BSON.BSON_INT32_MAX?(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+5:(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+9;case"undefined":return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1;case"boolean":return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+2;case"object":if(null==value||value instanceof MinKey||value instanceof MaxKey||"MinKey"==value._bsontype||"MaxKey"==value._bsontype)return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1;if(value instanceof ObjectID||"ObjectID"==value._bsontype)return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+13;if(value instanceof Date||isDate(value))return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+9;if("undefined"!=typeof Buffer&&Buffer.isBuffer(value))return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+6+value.length;if(value instanceof Long||value instanceof Double||value instanceof Timestamp||"Long"==value._bsontype||"Double"==value._bsontype||"Timestamp"==value._bsontype)return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+9;if(value instanceof Code||"Code"==value._bsontype)return null!=value.scope&&Object.keys(value.scope).length>0?(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1+4+4+(isBuffer?Buffer.byteLength(value.code.toString(),"utf8"):numberOfBytes(value.code.toString()))+1+BSON.calculateObjectSize(value.scope,serializeFunctions):(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1+4+(isBuffer?Buffer.byteLength(value.code.toString(),"utf8"):numberOfBytes(value.code.toString()))+1;if(value instanceof Binary||"Binary"==value._bsontype)return value.sub_type==Binary.SUBTYPE_BYTE_ARRAY?(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+(value.position+1+4+1+4):(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+(value.position+1+4+1);if(value instanceof Symbol||"Symbol"==value._bsontype)return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+((isBuffer?Buffer.byteLength(value.value,"utf8"):numberOfBytes(value.value))+4+1+1);if(value instanceof DBRef||"DBRef"==value._bsontype){var ordered_values={$ref:value.namespace,$id:value.oid};return null!=value.db&&(ordered_values.$db=value.db),(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1+BSON.calculateObjectSize(ordered_values,serializeFunctions)}return value instanceof RegExp||"[object RegExp]"===Object.prototype.toString.call(value)?(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1+(isBuffer?Buffer.byteLength(value.source,"utf8"):numberOfBytes(value.source))+1+(value.global?1:0)+(value.ignoreCase?1:0)+(value.multiline?1:0)+1:(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+BSON.calculateObjectSize(value,serializeFunctions)+1;case"function":if(value instanceof RegExp||"[object RegExp]"===Object.prototype.toString.call(value)||"[object RegExp]"==String.call(value))return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1+(isBuffer?Buffer.byteLength(value.source,"utf8"):numberOfBytes(value.source))+1+(value.global?1:0)+(value.ignoreCase?1:0)+(value.multiline?1:0)+1;if(serializeFunctions&&null!=value.scope&&Object.keys(value.scope).length>0)return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1+4+4+(isBuffer?Buffer.byteLength(value.toString(),"utf8"):numberOfBytes(value.toString()))+1+BSON.calculateObjectSize(value.scope,serializeFunctions);if(serializeFunctions)return(null!=name?(isBuffer?Buffer.byteLength(name,"utf8"):numberOfBytes(name))+1:0)+1+4+(isBuffer?Buffer.byteLength(value.toString(),"utf8"):numberOfBytes(value.toString()))+1}return 0}var Long=require("./long").Long,Double=require("./double").Double,Timestamp=require("./timestamp").Timestamp,ObjectID=require("./objectid").ObjectID,Symbol=require("./symbol").Symbol,Code=require("./code").Code,MinKey=require("./min_key").MinKey,MaxKey=require("./max_key").MaxKey,DBRef=require("./db_ref").DBRef,Binary=require("./binary").Binary,BinaryParser=require("./binary_parser").BinaryParser,writeIEEE754=require("./float_parser").writeIEEE754,readIEEE754=require("./float_parser").readIEEE754,isDate=function(d){return"object"==typeof d&&"[object Date]"===Object.prototype.toString.call(d)};BSON.BSON_INT32_MAX=2147483647,BSON.BSON_INT32_MIN=-2147483648,BSON.BSON_INT64_MAX=Math.pow(2,63)-1,BSON.BSON_INT64_MIN=-Math.pow(2,63),BSON.JS_INT_MAX=9007199254740992,BSON.JS_INT_MIN=-9007199254740992;var JS_INT_MAX_LONG=Long.fromNumber(9007199254740992),JS_INT_MIN_LONG=Long.fromNumber(-9007199254740992);BSON.BSON_DATA_NUMBER=1,BSON.BSON_DATA_STRING=2,BSON.BSON_DATA_OBJECT=3,BSON.BSON_DATA_ARRAY=4,BSON.BSON_DATA_BINARY=5,BSON.BSON_DATA_OID=7,BSON.BSON_DATA_BOOLEAN=8,BSON.BSON_DATA_DATE=9,BSON.BSON_DATA_NULL=10,BSON.BSON_DATA_REGEXP=11,BSON.BSON_DATA_CODE=13,BSON.BSON_DATA_SYMBOL=14,BSON.BSON_DATA_CODE_W_SCOPE=15,BSON.BSON_DATA_INT=16,BSON.BSON_DATA_TIMESTAMP=17,BSON.BSON_DATA_LONG=18,BSON.BSON_DATA_MIN_KEY=255,BSON.BSON_DATA_MAX_KEY=127,BSON.BSON_BINARY_SUBTYPE_DEFAULT=0,BSON.BSON_BINARY_SUBTYPE_FUNCTION=1,BSON.BSON_BINARY_SUBTYPE_BYTE_ARRAY=2,BSON.BSON_BINARY_SUBTYPE_UUID=3,BSON.BSON_BINARY_SUBTYPE_MD5=4,BSON.BSON_BINARY_SUBTYPE_USER_DEFINED=128,BSON.calculateObjectSize=function(object,serializeFunctions){var totalLength=5;if(Array.isArray(object))for(var i=0;i<object.length;i++)totalLength+=calculateElement(i.toString(),object[i],serializeFunctions);else{object.toBSON&&(object=object.toBSON());for(var key in object)totalLength+=calculateElement(key,object[key],serializeFunctions)}return totalLength},BSON.serializeWithBufferAndIndex=function(object,checkKeys,buffer,index,serializeFunctions){serializeFunctions=null==serializeFunctions?!1:serializeFunctions;var size=buffer.length;return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,serializeObject(object,checkKeys,buffer,index,serializeFunctions)-1};var serializeObject=function(object,checkKeys,buffer,index,serializeFunctions){if(object.toBSON){if("function"!=typeof object.toBSON)throw new Error("toBSON is not a function");if(object=object.toBSON(),null!=object&&"object"!=typeof object)throw new Error("toBSON function did not return an object")}if(Array.isArray(object))for(var i=0;i<object.length;i++)index=packElement(i.toString(),object[i],checkKeys,buffer,index,serializeFunctions);
else{object.toBSON&&(object=object.toBSON());for(var key in object)"$db"!=key&&"$ref"!=key&&"$id"!=key&&BSON.checkKey(key,!checkKeys),index=packElement(key,object[key],checkKeys,buffer,index,serializeFunctions)}return buffer[index++]=0,index},stringToBytes=function(str){for(var ch,st,re=[],i=0;i<str.length;i++){ch=str.charCodeAt(i),st=[];do st.push(255&ch),ch>>=8;while(ch);re=re.concat(st.reverse())}return re},numberOfBytes=function(str){for(var ch,st,re=0,i=0;i<str.length;i++){ch=str.charCodeAt(i),st=[];do st.push(255&ch),ch>>=8;while(ch);re+=st.length}return re},writeToTypedArray=function(buffer,string,index){for(var bytes=stringToBytes(string),i=0;i<bytes.length;i++)buffer[index+i]=bytes[i];return bytes.length},supportsBuffer="undefined"!=typeof Buffer,packElement=function(name,value,checkKeys,buffer,index,serializeFunctions){value&&value.toBSON&&(value=value.toBSON());switch(typeof value){case"string":buffer[index++]=BSON.BSON_DATA_STRING;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var size=supportsBuffer?Buffer.byteLength(value)+1:numberOfBytes(value)+1;return buffer[index+3]=size>>24&255,buffer[index+2]=size>>16&255,buffer[index+1]=size>>8&255,buffer[index]=255&size,index+=4,supportsBuffer?buffer.write(value,index,"utf8"):writeToTypedArray(buffer,value,index),index=index+size-1,buffer[index++]=0,index;case"number":if(Math.floor(value)===value&&value>=BSON.JS_INT_MIN&&value<=BSON.JS_INT_MAX)if(value>=BSON.BSON_INT32_MIN&&value<=BSON.BSON_INT32_MAX){buffer[index++]=BSON.BSON_DATA_INT;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0,buffer[index++]=255&value,buffer[index++]=value>>8&255,buffer[index++]=value>>16&255,buffer[index++]=value>>24&255}else if(value>=BSON.JS_INT_MIN&&value<=BSON.JS_INT_MAX){buffer[index++]=BSON.BSON_DATA_NUMBER;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0,writeIEEE754(buffer,value,index,"little",52,8),index+=8}else{buffer[index++]=BSON.BSON_DATA_LONG;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var longVal=Long.fromNumber(value),lowBits=longVal.getLowBits(),highBits=longVal.getHighBits();buffer[index++]=255&lowBits,buffer[index++]=lowBits>>8&255,buffer[index++]=lowBits>>16&255,buffer[index++]=lowBits>>24&255,buffer[index++]=255&highBits,buffer[index++]=highBits>>8&255,buffer[index++]=highBits>>16&255,buffer[index++]=highBits>>24&255}else{buffer[index++]=BSON.BSON_DATA_NUMBER;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0,writeIEEE754(buffer,value,index,"little",52,8),index+=8}return index;case"undefined":buffer[index++]=BSON.BSON_DATA_NULL;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);return index=index+numberOfWrittenBytes+1,buffer[index-1]=0,index;case"boolean":buffer[index++]=BSON.BSON_DATA_BOOLEAN;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);return index=index+numberOfWrittenBytes+1,buffer[index-1]=0,buffer[index++]=value?1:0,index;case"object":if(null===value||value instanceof MinKey||value instanceof MaxKey||"MinKey"==value._bsontype||"MaxKey"==value._bsontype){buffer[index++]=null===value?BSON.BSON_DATA_NULL:value instanceof MinKey?BSON.BSON_DATA_MIN_KEY:BSON.BSON_DATA_MAX_KEY;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);return index=index+numberOfWrittenBytes+1,buffer[index-1]=0,index}if(value instanceof ObjectID||"ObjectID"==value._bsontype){buffer[index++]=BSON.BSON_DATA_OID;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);return index=index+numberOfWrittenBytes+1,buffer[index-1]=0,supportsBuffer?buffer.write(value.id,index,"binary"):writeToTypedArray(buffer,value.id,index),index+=12}if(value instanceof Date||isDate(value)){buffer[index++]=BSON.BSON_DATA_DATE;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var dateInMilis=Long.fromNumber(value.getTime()),lowBits=dateInMilis.getLowBits(),highBits=dateInMilis.getHighBits();return buffer[index++]=255&lowBits,buffer[index++]=lowBits>>8&255,buffer[index++]=lowBits>>16&255,buffer[index++]=lowBits>>24&255,buffer[index++]=255&highBits,buffer[index++]=highBits>>8&255,buffer[index++]=highBits>>16&255,buffer[index++]=highBits>>24&255,index}if("undefined"!=typeof Buffer&&Buffer.isBuffer(value)){buffer[index++]=BSON.BSON_DATA_BINARY;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var size=value.length;return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,buffer[index++]=BSON.BSON_BINARY_SUBTYPE_DEFAULT,value.copy(buffer,index,0,size),index+=size}if(value instanceof Long||value instanceof Timestamp||"Long"==value._bsontype||"Timestamp"==value._bsontype){buffer[index++]=value instanceof Long||"Long"==value._bsontype?BSON.BSON_DATA_LONG:BSON.BSON_DATA_TIMESTAMP;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var lowBits=value.getLowBits(),highBits=value.getHighBits();return buffer[index++]=255&lowBits,buffer[index++]=lowBits>>8&255,buffer[index++]=lowBits>>16&255,buffer[index++]=lowBits>>24&255,buffer[index++]=255&highBits,buffer[index++]=highBits>>8&255,buffer[index++]=highBits>>16&255,buffer[index++]=highBits>>24&255,index}if(value instanceof Double||"Double"==value._bsontype){buffer[index++]=BSON.BSON_DATA_NUMBER;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);return index=index+numberOfWrittenBytes+1,buffer[index-1]=0,writeIEEE754(buffer,value,index,"little",52,8),index+=8}if(value instanceof Code||"Code"==value._bsontype){if(null!=value.scope&&Object.keys(value.scope).length>0){buffer[index++]=BSON.BSON_DATA_CODE_W_SCOPE;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var scopeSize=BSON.calculateObjectSize(value.scope,serializeFunctions),functionString=value.code.toString(),codeSize=supportsBuffer?Buffer.byteLength(functionString)+1:numberOfBytes(functionString)+1,totalSize=4+codeSize+scopeSize+4;buffer[index++]=255&totalSize,buffer[index++]=totalSize>>8&255,buffer[index++]=totalSize>>16&255,buffer[index++]=totalSize>>24&255,buffer[index++]=255&codeSize,buffer[index++]=codeSize>>8&255,buffer[index++]=codeSize>>16&255,buffer[index++]=codeSize>>24&255,supportsBuffer?buffer.write(functionString,index,"utf8"):writeToTypedArray(buffer,functionString,index),index=index+codeSize-1,buffer[index++]=0;var scopeObjectBuffer=supportsBuffer?new Buffer(scopeSize):new Uint8Array(new ArrayBuffer(scopeSize));serializeObject(value.scope,checkKeys,scopeObjectBuffer,0,serializeFunctions);var scopeDocSize=scopeSize;return buffer[index++]=255&scopeDocSize,buffer[index++]=scopeDocSize>>8&255,buffer[index++]=scopeDocSize>>16&255,buffer[index++]=scopeDocSize>>24&255,supportsBuffer?scopeObjectBuffer.copy(buffer,index,0,scopeSize):buffer.set(scopeObjectBuffer,index),index=index+scopeDocSize-5,buffer[index++]=0,index}buffer[index++]=BSON.BSON_DATA_CODE;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var functionString=value.code.toString(),size=supportsBuffer?Buffer.byteLength(functionString)+1:numberOfBytes(functionString)+1;return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,supportsBuffer?buffer.write(functionString,index,"utf8"):writeToTypedArray(buffer,functionString,index),index=index+size-1,buffer[index++]=0,index}if(value instanceof Binary||"Binary"==value._bsontype){buffer[index++]=BSON.BSON_DATA_BINARY;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var data=value.value(!0),size=value.position;return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,buffer[index++]=value.sub_type,value.sub_type==Binary.SUBTYPE_BYTE_ARRAY&&(buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255),supportsBuffer?data.copy(buffer,index,0,value.position):buffer.set(data,index),index+=value.position}if(value instanceof Symbol||"Symbol"==value._bsontype){buffer[index++]=BSON.BSON_DATA_SYMBOL;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var size=supportsBuffer?Buffer.byteLength(value.value)+1:numberOfBytes(value.value)+1;return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,buffer.write(value.value,index,"utf8"),index=index+size-1,buffer[index++]=0,index}if(value instanceof DBRef||"DBRef"==value._bsontype){buffer[index++]=BSON.BSON_DATA_OBJECT;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var ordered_values={$ref:value.namespace,$id:value.oid};null!=value.db&&(ordered_values.$db=value.db);var size=BSON.calculateObjectSize(ordered_values,serializeFunctions),endIndex=BSON.serializeWithBufferAndIndex(ordered_values,checkKeys,buffer,index,serializeFunctions);return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,buffer[endIndex++]=0,endIndex}if(value instanceof RegExp||"[object RegExp]"===Object.prototype.toString.call(value)){buffer[index++]=BSON.BSON_DATA_REGEXP;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);return index=index+numberOfWrittenBytes+1,buffer[index-1]=0,supportsBuffer?buffer.write(value.source,index,"utf8"):writeToTypedArray(buffer,value.source,index),index+=supportsBuffer?Buffer.byteLength(value.source):numberOfBytes(value.source),buffer[index++]=0,value.global&&(buffer[index++]=115),value.ignoreCase&&(buffer[index++]=105),value.multiline&&(buffer[index++]=109),buffer[index++]=0,index}buffer[index++]=Array.isArray(value)?BSON.BSON_DATA_ARRAY:BSON.BSON_DATA_OBJECT;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var endIndex=serializeObject(value,checkKeys,buffer,index+4,serializeFunctions),size=endIndex-index;return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,endIndex;case"function":if(value instanceof RegExp||"[object RegExp]"===Object.prototype.toString.call(value)||"[object RegExp]"==String.call(value)){buffer[index++]=BSON.BSON_DATA_REGEXP;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);return index=index+numberOfWrittenBytes+1,buffer[index-1]=0,buffer.write(value.source,index,"utf8"),index+=supportsBuffer?Buffer.byteLength(value.source):numberOfBytes(value.source),buffer[index++]=0,value.global&&(buffer[index++]=115),value.ignoreCase&&(buffer[index++]=105),value.multiline&&(buffer[index++]=109),buffer[index++]=0,index}if(serializeFunctions&&null!=value.scope&&Object.keys(value.scope).length>0){buffer[index++]=BSON.BSON_DATA_CODE_W_SCOPE;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var scopeSize=BSON.calculateObjectSize(value.scope,serializeFunctions),functionString=value.toString(),codeSize=supportsBuffer?Buffer.byteLength(functionString)+1:numberOfBytes(functionString)+1,totalSize=4+codeSize+scopeSize;buffer[index++]=255&totalSize,buffer[index++]=totalSize>>8&255,buffer[index++]=totalSize>>16&255,buffer[index++]=totalSize>>24&255,buffer[index++]=255&codeSize,buffer[index++]=codeSize>>8&255,buffer[index++]=codeSize>>16&255,buffer[index++]=codeSize>>24&255,supportsBuffer?buffer.write(functionString,index,"utf8"):writeToTypedArray(buffer,functionString,index),index=index+codeSize-1,buffer[index++]=0;var scopeObjectBuffer=new Buffer(scopeSize);serializeObject(value.scope,checkKeys,scopeObjectBuffer,0,serializeFunctions);var scopeDocSize=scopeSize-4;return buffer[index++]=255&scopeDocSize,buffer[index++]=scopeDocSize>>8&255,buffer[index++]=scopeDocSize>>16&255,buffer[index++]=scopeDocSize>>24&255,scopeObjectBuffer.copy(buffer,index,0,scopeSize),index=index+scopeDocSize-5,buffer[index++]=0,index}if(serializeFunctions){buffer[index++]=BSON.BSON_DATA_CODE;var numberOfWrittenBytes=supportsBuffer?buffer.write(name,index,"utf8"):writeToTypedArray(buffer,name,index);index=index+numberOfWrittenBytes+1,buffer[index-1]=0;var functionString=value.toString(),size=supportsBuffer?Buffer.byteLength(functionString)+1:numberOfBytes(functionString)+1;return buffer[index++]=255&size,buffer[index++]=size>>8&255,buffer[index++]=size>>16&255,buffer[index++]=size>>24&255,supportsBuffer?buffer.write(functionString,index,"utf8"):writeToTypedArray(buffer,functionString,index),index=index+size-1,buffer[index++]=0,index}}return index};BSON.serialize=function(object,checkKeys,asBuffer,serializeFunctions){if(null==object||"object"!=typeof object||Array.isArray(object))throw new Error("Only javascript objects supported");var buffer=null,size=BSON.calculateObjectSize(object,serializeFunctions);return(buffer="undefined"!=typeof Buffer)?(buffer=new Buffer(size),asBuffer=!0):buffer="undefined"!=typeof Uint8Array?new Uint8Array(new ArrayBuffer(size)):new Array(size),BSON.serializeWithBufferAndIndex(object,checkKeys,buffer,0,serializeFunctions),buffer};var functionCache=BSON.functionCache={},table=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],crc32=function(string,start,end){var crc=0,x=0,y=0;crc=-1^crc;for(var i=start,iTop=end;iTop>i;i++)y=255&(crc^string[i]),x=table[y],crc=crc>>>8^x;return-1^crc};BSON.deserializeStream=function(data,startIndex,numberOfDocuments,documents,docStartIndex,options){options=null!=options?options:{};for(var index=startIndex,i=0;numberOfDocuments>i;i++){var size=data[index]|data[index+1]<<8|data[index+2]<<16|data[index+3]<<24;options.index=index,documents[docStartIndex+i]=BSON.deserialize(data,options),index+=size}return index};var isolateEvalWithHash=function(functionCache,hash,functionString,object){var value=null;return null==functionCache[hash]&&(eval("value = "+functionString),functionCache[hash]=value),functionCache[hash].bind(object)},isolateEval=function(functionString){var value=null;return eval("value = "+functionString),value},convertUint8ArrayToUtf8String=function(byteArray,startIndex,endIndex){return BinaryParser.decode_utf8(convertArraytoUtf8BinaryString(byteArray,startIndex,endIndex))},convertArraytoUtf8BinaryString=function(byteArray,startIndex,endIndex){for(var result="",i=startIndex;endIndex>i;i++)result+=String.fromCharCode(byteArray[i]);return result};BSON.deserialize=function(buffer,options,isArray){options=null==options?{}:options;var evalFunctions=null==options.evalFunctions?!1:options.evalFunctions,cacheFunctions=null==options.cacheFunctions?!1:options.cacheFunctions,cacheFunctionsCrc32=null==options.cacheFunctionsCrc32?!1:options.cacheFunctionsCrc32,promoteLongs=null==options.promoteLongs?!0:options.promoteLongs;if(buffer.length<5)throw new Error("corrupt bson message < 5 bytes long");var index="number"==typeof options.index?options.index:0,readCStyleString=function(){for(var i=index;0!==buffer[i]&&i<buffer.length;)i++;if(i>=buffer.length)throw new Error("Bad BSON Document: illegal CString");var string=supportsBuffer&&Buffer.isBuffer(buffer)?buffer.toString("utf8",index,i):convertUint8ArrayToUtf8String(buffer,index,i);return index=i+1,string},object=isArray?[]:{},size=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24;if(5>size||size>buffer.length)throw new Error("corrupt bson message");for(;;){var elementType=buffer[index++];if(0==elementType)break;var name=readCStyleString();switch(elementType){case BSON.BSON_DATA_OID:var string=supportsBuffer&&Buffer.isBuffer(buffer)?buffer.toString("binary",index,index+12):convertArraytoUtf8BinaryString(buffer,index,index+12);object[name]=new ObjectID(string),index+=12;break;case BSON.BSON_DATA_STRING:var stringSize=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24;object[name]=supportsBuffer&&Buffer.isBuffer(buffer)?buffer.toString("utf8",index,index+stringSize-1):convertUint8ArrayToUtf8String(buffer,index,index+stringSize-1),index+=stringSize;break;case BSON.BSON_DATA_INT:object[name]=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24;break;case BSON.BSON_DATA_NUMBER:object[name]=readIEEE754(buffer,index,"little",52,8),index+=8;break;case BSON.BSON_DATA_DATE:var lowBits=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24,highBits=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24;object[name]=new Date(new Long(lowBits,highBits).toNumber());break;case BSON.BSON_DATA_BOOLEAN:object[name]=1==buffer[index++];break;case BSON.BSON_DATA_NULL:object[name]=null;break;case BSON.BSON_DATA_BINARY:var binarySize=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24,subType=buffer[index++];if(null!=buffer.slice)subType==Binary.SUBTYPE_BYTE_ARRAY&&(binarySize=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24),object[name]=new Binary(buffer.slice(index,index+binarySize),subType);else{var _buffer="undefined"!=typeof Uint8Array?new Uint8Array(new ArrayBuffer(binarySize)):new Array(binarySize);subType==Binary.SUBTYPE_BYTE_ARRAY&&(binarySize=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24);for(var i=0;binarySize>i;i++)_buffer[i]=buffer[index+i];object[name]=new Binary(_buffer,subType)}index+=binarySize;break;case BSON.BSON_DATA_ARRAY:options.index=index;var objectSize=buffer[index]|buffer[index+1]<<8|buffer[index+2]<<16|buffer[index+3]<<24;object[name]=BSON.deserialize(buffer,options,!0),index+=objectSize;break;case BSON.BSON_DATA_OBJECT:options.index=index;var objectSize=buffer[index]|buffer[index+1]<<8|buffer[index+2]<<16|buffer[index+3]<<24;object[name]=BSON.deserialize(buffer,options,!1),index+=objectSize;break;case BSON.BSON_DATA_REGEXP:for(var source=readCStyleString(),regExpOptions=readCStyleString(),optionsArray=new Array(regExpOptions.length),i=0;i<regExpOptions.length;i++)switch(regExpOptions[i]){case"m":optionsArray[i]="m";break;case"s":optionsArray[i]="g";break;case"i":optionsArray[i]="i"}object[name]=new RegExp(source,optionsArray.join(""));break;case BSON.BSON_DATA_LONG:var lowBits=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24,highBits=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24,long=new Long(lowBits,highBits);object[name]=promoteLongs&&long.lessThanOrEqual(JS_INT_MAX_LONG)&&long.greaterThanOrEqual(JS_INT_MIN_LONG)?long.toNumber():long;break;case BSON.BSON_DATA_SYMBOL:var stringSize=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24;object[name]=new Symbol(buffer.toString("utf8",index,index+stringSize-1)),index+=stringSize;break;case BSON.BSON_DATA_TIMESTAMP:var lowBits=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24,highBits=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24;object[name]=new Timestamp(lowBits,highBits);break;case BSON.BSON_DATA_MIN_KEY:object[name]=new MinKey;break;case BSON.BSON_DATA_MAX_KEY:object[name]=new MaxKey;break;case BSON.BSON_DATA_CODE:var stringSize=buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24,functionString=supportsBuffer&&Buffer.isBuffer(buffer)?buffer.toString("utf8",index,index+stringSize-1):convertUint8ArrayToUtf8String(buffer,index,index+stringSize-1);if(evalFunctions){if(cacheFunctions){var hash=cacheFunctionsCrc32?crc32(functionString):functionString;object[name]=isolateEvalWithHash(functionCache,hash,functionString,object)}else object[name]=isolateEval(functionString)}else object[name]=new Code(functionString,{});index+=stringSize;break;case BSON.BSON_DATA_CODE_W_SCOPE:var stringSize=(buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24,buffer[index++]|buffer[index++]<<8|buffer[index++]<<16|buffer[index++]<<24),functionString=supportsBuffer&&Buffer.isBuffer(buffer)?buffer.toString("utf8",index,index+stringSize-1):convertUint8ArrayToUtf8String(buffer,index,index+stringSize-1);index+=stringSize,options.index=index;var objectSize=buffer[index]|buffer[index+1]<<8|buffer[index+2]<<16|buffer[index+3]<<24,scopeObject=BSON.deserialize(buffer,options,!1);if(index+=objectSize,evalFunctions){if(cacheFunctions){var hash=cacheFunctionsCrc32?crc32(functionString):functionString;object[name]=isolateEvalWithHash(functionCache,hash,functionString,object)}else object[name]=isolateEval(functionString);object[name].scope=scopeObject}else object[name]=new Code(functionString,scopeObject)}}return null!=object.$id&&(object=new DBRef(object.$ref,object.$id,object.$db)),object},BSON.checkKey=function(key,dollarsAndDotsOk){if(key.length){if(~key.indexOf("\x00"))throw Error("key "+key+" must not contain null bytes");if(!dollarsAndDotsOk){if("$"==key[0])throw Error("key "+key+" must not start with '$'");if(~key.indexOf("."))throw Error("key "+key+" must not contain '.'")}}},BSON.prototype.deserialize=function(data,options){return BSON.deserialize(data,options)},BSON.prototype.deserializeStream=function(data,startIndex,numberOfDocuments,documents,docStartIndex,options){return BSON.deserializeStream(data,startIndex,numberOfDocuments,documents,docStartIndex,options)},BSON.prototype.serialize=function(object,checkKeys,asBuffer,serializeFunctions){return BSON.serialize(object,checkKeys,asBuffer,serializeFunctions)},BSON.prototype.calculateObjectSize=function(object,serializeFunctions){return BSON.calculateObjectSize(object,serializeFunctions)},BSON.prototype.serializeWithBufferAndIndex=function(object,checkKeys,buffer,startIndex,serializeFunctions){return BSON.serializeWithBufferAndIndex(object,checkKeys,buffer,startIndex,serializeFunctions)},exports.Code=Code,exports.Symbol=Symbol,exports.BSON=BSON,exports.DBRef=DBRef,exports.Binary=Binary,exports.ObjectID=ObjectID,exports.Long=Long,exports.Timestamp=Timestamp,exports.Double=Double,exports.MinKey=MinKey,exports.MaxKey=MaxKey}).call(this,require("buffer").Buffer)},{"./binary":51,"./binary_parser":52,"./code":54,"./db_ref":55,"./double":56,"./float_parser":57,"./long":58,"./max_key":59,"./min_key":60,"./objectid":61,"./symbol":62,"./timestamp":63,buffer:2}],54:[function(require,module,exports){var Code=function Code(code,scope){return this instanceof Code?(this._bsontype="Code",this.code=code,void(this.scope=null==scope?{}:scope)):new Code(code,scope)};Code.prototype.toJSON=function(){return{scope:this.scope,code:this.code}},exports.Code=Code},{}],55:[function(require,module,exports){function DBRef(namespace,oid,db){return this instanceof DBRef?(this._bsontype="DBRef",this.namespace=namespace,this.oid=oid,void(this.db=db)):new DBRef(namespace,oid,db)}DBRef.prototype.toJSON=function(){return{$ref:this.namespace,$id:this.oid,$db:null==this.db?"":this.db}},exports.DBRef=DBRef},{}],56:[function(require,module,exports){function Double(value){return this instanceof Double?(this._bsontype="Double",void(this.value=value)):new Double(value)}Double.prototype.valueOf=function(){return this.value},Double.prototype.toJSON=function(){return this.value},exports.Double=Double},{}],57:[function(require,module,exports){var readIEEE754=function(buffer,offset,endian,mLen,nBytes){var e,m,bBE="big"===endian,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=bBE?0:nBytes-1,d=bBE?1:-1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?0/0:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},writeIEEE754=function(buffer,value,offset,endian,mLen,nBytes){var e,m,c,bBE="big"===endian,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=bBE?nBytes-1:0,d=bBE?-1:1,s=0>value||0===value&&0>1/value?1:0;for(value=Math.abs(value),isNaN(value)||1/0===value?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s};exports.readIEEE754=readIEEE754,exports.writeIEEE754=writeIEEE754},{}],58:[function(require,module,exports){function Long(low,high){return this instanceof Long?(this._bsontype="Long",this.low_=0|low,void(this.high_=0|high)):new Long(low,high)}Long.prototype.toInt=function(){return this.low_},Long.prototype.toNumber=function(){return this.high_*Long.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},Long.prototype.toJSON=function(){return this.toString()},Long.prototype.toString=function(opt_radix){var radix=opt_radix||10;if(2>radix||radix>36)throw Error("radix out of range: "+radix);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(Long.MIN_VALUE)){var radixLong=Long.fromNumber(radix),div=this.div(radixLong),rem=div.multiply(radixLong).subtract(this);return div.toString(radix)+rem.toInt().toString(radix)}return"-"+this.negate().toString(radix)}for(var radixToPower=Long.fromNumber(Math.pow(radix,6)),rem=this,result="";;){var remDiv=rem.div(radixToPower),intval=rem.subtract(remDiv.multiply(radixToPower)).toInt(),digits=intval.toString(radix);if(rem=remDiv,rem.isZero())return digits+result;for(;digits.length<6;)digits="0"+digits;result=""+digits+result}},Long.prototype.getHighBits=function(){return this.high_},Long.prototype.getLowBits=function(){return this.low_},Long.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:Long.TWO_PWR_32_DBL_+this.low_},Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var val=0!=this.high_?this.high_:this.low_,bit=31;bit>0&&0==(val&1<<bit);bit--);return 0!=this.high_?bit+33:bit+1},Long.prototype.isZero=function(){return 0==this.high_&&0==this.low_},Long.prototype.isNegative=function(){return this.high_<0},Long.prototype.isOdd=function(){return 1==(1&this.low_)},Long.prototype.equals=function(other){return this.high_==other.high_&&this.low_==other.low_},Long.prototype.notEquals=function(other){return this.high_!=other.high_||this.low_!=other.low_},Long.prototype.lessThan=function(other){return this.compare(other)<0},Long.prototype.lessThanOrEqual=function(other){return this.compare(other)<=0},Long.prototype.greaterThan=function(other){return this.compare(other)>0},Long.prototype.greaterThanOrEqual=function(other){return this.compare(other)>=0},Long.prototype.compare=function(other){if(this.equals(other))return 0;var thisNeg=this.isNegative(),otherNeg=other.isNegative();return thisNeg&&!otherNeg?-1:!thisNeg&&otherNeg?1:this.subtract(other).isNegative()?-1:1},Long.prototype.negate=function(){return this.equals(Long.MIN_VALUE)?Long.MIN_VALUE:this.not().add(Long.ONE)},Long.prototype.add=function(other){var a48=this.high_>>>16,a32=65535&this.high_,a16=this.low_>>>16,a00=65535&this.low_,b48=other.high_>>>16,b32=65535&other.high_,b16=other.low_>>>16,b00=65535&other.low_,c48=0,c32=0,c16=0,c00=0;return c00+=a00+b00,c16+=c00>>>16,c00&=65535,c16+=a16+b16,c32+=c16>>>16,c16&=65535,c32+=a32+b32,c48+=c32>>>16,c32&=65535,c48+=a48+b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32)},Long.prototype.subtract=function(other){return this.add(other.negate())},Long.prototype.multiply=function(other){if(this.isZero())return Long.ZERO;if(other.isZero())return Long.ZERO;if(this.equals(Long.MIN_VALUE))return other.isOdd()?Long.MIN_VALUE:Long.ZERO;if(other.equals(Long.MIN_VALUE))return this.isOdd()?Long.MIN_VALUE:Long.ZERO;if(this.isNegative())return other.isNegative()?this.negate().multiply(other.negate()):this.negate().multiply(other).negate();
if(other.isNegative())return this.multiply(other.negate()).negate();if(this.lessThan(Long.TWO_PWR_24_)&&other.lessThan(Long.TWO_PWR_24_))return Long.fromNumber(this.toNumber()*other.toNumber());var a48=this.high_>>>16,a32=65535&this.high_,a16=this.low_>>>16,a00=65535&this.low_,b48=other.high_>>>16,b32=65535&other.high_,b16=other.low_>>>16,b00=65535&other.low_,c48=0,c32=0,c16=0,c00=0;return c00+=a00*b00,c16+=c00>>>16,c00&=65535,c16+=a16*b00,c32+=c16>>>16,c16&=65535,c16+=a00*b16,c32+=c16>>>16,c16&=65535,c32+=a32*b00,c48+=c32>>>16,c32&=65535,c32+=a16*b16,c48+=c32>>>16,c32&=65535,c32+=a00*b32,c48+=c32>>>16,c32&=65535,c48+=a48*b00+a32*b16+a16*b32+a00*b48,c48&=65535,Long.fromBits(c16<<16|c00,c48<<16|c32)},Long.prototype.div=function(other){if(other.isZero())throw Error("division by zero");if(this.isZero())return Long.ZERO;if(this.equals(Long.MIN_VALUE)){if(other.equals(Long.ONE)||other.equals(Long.NEG_ONE))return Long.MIN_VALUE;if(other.equals(Long.MIN_VALUE))return Long.ONE;var halfThis=this.shiftRight(1),approx=halfThis.div(other).shiftLeft(1);if(approx.equals(Long.ZERO))return other.isNegative()?Long.ONE:Long.NEG_ONE;var rem=this.subtract(other.multiply(approx)),result=approx.add(rem.div(other));return result}if(other.equals(Long.MIN_VALUE))return Long.ZERO;if(this.isNegative())return other.isNegative()?this.negate().div(other.negate()):this.negate().div(other).negate();if(other.isNegative())return this.div(other.negate()).negate();for(var res=Long.ZERO,rem=this;rem.greaterThanOrEqual(other);){for(var approx=Math.max(1,Math.floor(rem.toNumber()/other.toNumber())),log2=Math.ceil(Math.log(approx)/Math.LN2),delta=48>=log2?1:Math.pow(2,log2-48),approxRes=Long.fromNumber(approx),approxRem=approxRes.multiply(other);approxRem.isNegative()||approxRem.greaterThan(rem);)approx-=delta,approxRes=Long.fromNumber(approx),approxRem=approxRes.multiply(other);approxRes.isZero()&&(approxRes=Long.ONE),res=res.add(approxRes),rem=rem.subtract(approxRem)}return res},Long.prototype.modulo=function(other){return this.subtract(this.div(other).multiply(other))},Long.prototype.not=function(){return Long.fromBits(~this.low_,~this.high_)},Long.prototype.and=function(other){return Long.fromBits(this.low_&other.low_,this.high_&other.high_)},Long.prototype.or=function(other){return Long.fromBits(this.low_|other.low_,this.high_|other.high_)},Long.prototype.xor=function(other){return Long.fromBits(this.low_^other.low_,this.high_^other.high_)},Long.prototype.shiftLeft=function(numBits){if(numBits&=63,0==numBits)return this;var low=this.low_;if(32>numBits){var high=this.high_;return Long.fromBits(low<<numBits,high<<numBits|low>>>32-numBits)}return Long.fromBits(0,low<<numBits-32)},Long.prototype.shiftRight=function(numBits){if(numBits&=63,0==numBits)return this;var high=this.high_;if(32>numBits){var low=this.low_;return Long.fromBits(low>>>numBits|high<<32-numBits,high>>numBits)}return Long.fromBits(high>>numBits-32,high>=0?0:-1)},Long.prototype.shiftRightUnsigned=function(numBits){if(numBits&=63,0==numBits)return this;var high=this.high_;if(32>numBits){var low=this.low_;return Long.fromBits(low>>>numBits|high<<32-numBits,high>>>numBits)}return 32==numBits?Long.fromBits(high,0):Long.fromBits(high>>>numBits-32,0)},Long.fromInt=function(value){if(value>=-128&&128>value){var cachedObj=Long.INT_CACHE_[value];if(cachedObj)return cachedObj}var obj=new Long(0|value,0>value?-1:0);return value>=-128&&128>value&&(Long.INT_CACHE_[value]=obj),obj},Long.fromNumber=function(value){return isNaN(value)||!isFinite(value)?Long.ZERO:value<=-Long.TWO_PWR_63_DBL_?Long.MIN_VALUE:value+1>=Long.TWO_PWR_63_DBL_?Long.MAX_VALUE:0>value?Long.fromNumber(-value).negate():new Long(value%Long.TWO_PWR_32_DBL_|0,value/Long.TWO_PWR_32_DBL_|0)},Long.fromBits=function(lowBits,highBits){return new Long(lowBits,highBits)},Long.fromString=function(str,opt_radix){if(0==str.length)throw Error("number format error: empty string");var radix=opt_radix||10;if(2>radix||radix>36)throw Error("radix out of range: "+radix);if("-"==str.charAt(0))return Long.fromString(str.substring(1),radix).negate();if(str.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+str);for(var radixToPower=Long.fromNumber(Math.pow(radix,8)),result=Long.ZERO,i=0;i<str.length;i+=8){var size=Math.min(8,str.length-i),value=parseInt(str.substring(i,i+size),radix);if(8>size){var power=Long.fromNumber(Math.pow(radix,size));result=result.multiply(power).add(Long.fromNumber(value))}else result=result.multiply(radixToPower),result=result.add(Long.fromNumber(value))}return result},Long.INT_CACHE_={},Long.TWO_PWR_16_DBL_=65536,Long.TWO_PWR_24_DBL_=1<<24,Long.TWO_PWR_32_DBL_=Long.TWO_PWR_16_DBL_*Long.TWO_PWR_16_DBL_,Long.TWO_PWR_31_DBL_=Long.TWO_PWR_32_DBL_/2,Long.TWO_PWR_48_DBL_=Long.TWO_PWR_32_DBL_*Long.TWO_PWR_16_DBL_,Long.TWO_PWR_64_DBL_=Long.TWO_PWR_32_DBL_*Long.TWO_PWR_32_DBL_,Long.TWO_PWR_63_DBL_=Long.TWO_PWR_64_DBL_/2,Long.ZERO=Long.fromInt(0),Long.ONE=Long.fromInt(1),Long.NEG_ONE=Long.fromInt(-1),Long.MAX_VALUE=Long.fromBits(-1,2147483647),Long.MIN_VALUE=Long.fromBits(0,-2147483648),Long.TWO_PWR_24_=Long.fromInt(1<<24),exports.Long=Long},{}],59:[function(require,module,exports){function MaxKey(){return this instanceof MaxKey?void(this._bsontype="MaxKey"):new MaxKey}exports.MaxKey=MaxKey},{}],60:[function(require,module,exports){function MinKey(){return this instanceof MinKey?void(this._bsontype="MinKey"):new MinKey}exports.MinKey=MinKey},{}],61:[function(require,module,exports){(function(process){for(var BinaryParser=require("./binary_parser").BinaryParser,MACHINE_ID=parseInt(16777215*Math.random(),10),checkForHexRegExp=new RegExp("^[0-9a-fA-F]{24}$"),ObjectID=function ObjectID(id){if(!(this instanceof ObjectID))return new ObjectID(id);if(id instanceof ObjectID)return id;this._bsontype="ObjectID";var valid=ObjectID.isValid(id);if(!valid&&null!=id)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");return valid&&"string"==typeof id&&24==id.length?ObjectID.createFromHexString(id):(null==id||"number"==typeof id?this.id=this.generate(id):null!=id&&12===id.length&&(this.id=id),void(ObjectID.cacheHexString&&(this.__id=this.toHexString())))},hexTable=[],i=0;256>i;i++)hexTable[i]=(15>=i?"0":"")+i.toString(16);ObjectID.prototype.toHexString=function(){if(ObjectID.cacheHexString&&this.__id)return this.__id;for(var hexString="",i=0;i<this.id.length;i++)hexString+=hexTable[this.id.charCodeAt(i)];return ObjectID.cacheHexString&&(this.__id=hexString),hexString},ObjectID.prototype.get_inc=function(){return ObjectID.index=(ObjectID.index+1)%16777215},ObjectID.prototype.getInc=function(){return this.get_inc()},ObjectID.prototype.generate=function(time){"number"!=typeof time&&(time=parseInt(Date.now()/1e3,10));var time4Bytes=BinaryParser.encodeInt(time,32,!0,!0),machine3Bytes=BinaryParser.encodeInt(MACHINE_ID,24,!1),pid2Bytes=BinaryParser.fromShort("undefined"==typeof process?Math.floor(1e5*Math.random()):process.pid),index3Bytes=BinaryParser.encodeInt(this.get_inc(),24,!1,!0);return time4Bytes+machine3Bytes+pid2Bytes+index3Bytes},ObjectID.prototype.toString=function(){return this.toHexString()},ObjectID.prototype.inspect=ObjectID.prototype.toString,ObjectID.prototype.toJSON=function(){return this.toHexString()},ObjectID.prototype.equals=function(otherID){if(null==otherID)return!1;var id=otherID instanceof ObjectID||otherID.toHexString?otherID.id:ObjectID.createFromHexString(otherID).id;return this.id===id},ObjectID.prototype.getTimestamp=function(){var timestamp=new Date;return timestamp.setTime(1e3*Math.floor(BinaryParser.decodeInt(this.id.substring(0,4),32,!0,!0))),timestamp},ObjectID.index=parseInt(16777215*Math.random(),10),ObjectID.createPk=function(){return new ObjectID},ObjectID.createFromTime=function(time){var id=BinaryParser.encodeInt(time,32,!0,!0)+BinaryParser.encodeInt(0,64,!0,!0);return new ObjectID(id)},ObjectID.createFromHexString=function(hexString){if("undefined"==typeof hexString||null!=hexString&&24!=hexString.length)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");var len=hexString.length;if(len>24)throw new Error("Id cannot be longer than 12 bytes");for(var string,number,result="",index=0;len>index;index+=2)string=hexString.substr(index,2),number=parseInt(string,16),result+=BinaryParser.fromByte(number);return new ObjectID(result,hexString)},ObjectID.isValid=function(id){return null==id?!1:null!=id&&"number"!=typeof id&&12!=id.length&&24!=id.length?!1:"string"==typeof id&&24==id.length?checkForHexRegExp.test(id):!0},Object.defineProperty(ObjectID.prototype,"generationTime",{enumerable:!0,get:function(){return Math.floor(BinaryParser.decodeInt(this.id.substring(0,4),32,!0,!0))},set:function(value){var value=BinaryParser.encodeInt(value,32,!0,!0);this.id=value+this.id.substr(4),this.toHexString()}}),exports.ObjectID=ObjectID,exports.ObjectId=ObjectID}).call(this,require("_process"))},{"./binary_parser":52,_process:8}],62:[function(require,module,exports){function Symbol(value){return this instanceof Symbol?(this._bsontype="Symbol",void(this.value=value)):new Symbol(value)}Symbol.prototype.valueOf=function(){return this.value},Symbol.prototype.toString=function(){return this.value},Symbol.prototype.inspect=function(){return this.value},Symbol.prototype.toJSON=function(){return this.value},exports.Symbol=Symbol},{}],63:[function(require,module,exports){function Timestamp(low,high){return this instanceof Timestamp?(this._bsontype="Timestamp",this.low_=0|low,void(this.high_=0|high)):new Timestamp(low,high)}Timestamp.prototype.toInt=function(){return this.low_},Timestamp.prototype.toNumber=function(){return this.high_*Timestamp.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},Timestamp.prototype.toJSON=function(){return this.toString()},Timestamp.prototype.toString=function(opt_radix){var radix=opt_radix||10;if(2>radix||radix>36)throw Error("radix out of range: "+radix);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(Timestamp.MIN_VALUE)){var radixTimestamp=Timestamp.fromNumber(radix),div=this.div(radixTimestamp),rem=div.multiply(radixTimestamp).subtract(this);return div.toString(radix)+rem.toInt().toString(radix)}return"-"+this.negate().toString(radix)}for(var radixToPower=Timestamp.fromNumber(Math.pow(radix,6)),rem=this,result="";;){var remDiv=rem.div(radixToPower),intval=rem.subtract(remDiv.multiply(radixToPower)).toInt(),digits=intval.toString(radix);if(rem=remDiv,rem.isZero())return digits+result;for(;digits.length<6;)digits="0"+digits;result=""+digits+result}},Timestamp.prototype.getHighBits=function(){return this.high_},Timestamp.prototype.getLowBits=function(){return this.low_},Timestamp.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:Timestamp.TWO_PWR_32_DBL_+this.low_},Timestamp.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(Timestamp.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var val=0!=this.high_?this.high_:this.low_,bit=31;bit>0&&0==(val&1<<bit);bit--);return 0!=this.high_?bit+33:bit+1},Timestamp.prototype.isZero=function(){return 0==this.high_&&0==this.low_},Timestamp.prototype.isNegative=function(){return this.high_<0},Timestamp.prototype.isOdd=function(){return 1==(1&this.low_)},Timestamp.prototype.equals=function(other){return this.high_==other.high_&&this.low_==other.low_},Timestamp.prototype.notEquals=function(other){return this.high_!=other.high_||this.low_!=other.low_},Timestamp.prototype.lessThan=function(other){return this.compare(other)<0},Timestamp.prototype.lessThanOrEqual=function(other){return this.compare(other)<=0},Timestamp.prototype.greaterThan=function(other){return this.compare(other)>0},Timestamp.prototype.greaterThanOrEqual=function(other){return this.compare(other)>=0},Timestamp.prototype.compare=function(other){if(this.equals(other))return 0;var thisNeg=this.isNegative(),otherNeg=other.isNegative();return thisNeg&&!otherNeg?-1:!thisNeg&&otherNeg?1:this.subtract(other).isNegative()?-1:1},Timestamp.prototype.negate=function(){return this.equals(Timestamp.MIN_VALUE)?Timestamp.MIN_VALUE:this.not().add(Timestamp.ONE)},Timestamp.prototype.add=function(other){var a48=this.high_>>>16,a32=65535&this.high_,a16=this.low_>>>16,a00=65535&this.low_,b48=other.high_>>>16,b32=65535&other.high_,b16=other.low_>>>16,b00=65535&other.low_,c48=0,c32=0,c16=0,c00=0;return c00+=a00+b00,c16+=c00>>>16,c00&=65535,c16+=a16+b16,c32+=c16>>>16,c16&=65535,c32+=a32+b32,c48+=c32>>>16,c32&=65535,c48+=a48+b48,c48&=65535,Timestamp.fromBits(c16<<16|c00,c48<<16|c32)},Timestamp.prototype.subtract=function(other){return this.add(other.negate())},Timestamp.prototype.multiply=function(other){if(this.isZero())return Timestamp.ZERO;if(other.isZero())return Timestamp.ZERO;if(this.equals(Timestamp.MIN_VALUE))return other.isOdd()?Timestamp.MIN_VALUE:Timestamp.ZERO;if(other.equals(Timestamp.MIN_VALUE))return this.isOdd()?Timestamp.MIN_VALUE:Timestamp.ZERO;if(this.isNegative())return other.isNegative()?this.negate().multiply(other.negate()):this.negate().multiply(other).negate();if(other.isNegative())return this.multiply(other.negate()).negate();if(this.lessThan(Timestamp.TWO_PWR_24_)&&other.lessThan(Timestamp.TWO_PWR_24_))return Timestamp.fromNumber(this.toNumber()*other.toNumber());var a48=this.high_>>>16,a32=65535&this.high_,a16=this.low_>>>16,a00=65535&this.low_,b48=other.high_>>>16,b32=65535&other.high_,b16=other.low_>>>16,b00=65535&other.low_,c48=0,c32=0,c16=0,c00=0;return c00+=a00*b00,c16+=c00>>>16,c00&=65535,c16+=a16*b00,c32+=c16>>>16,c16&=65535,c16+=a00*b16,c32+=c16>>>16,c16&=65535,c32+=a32*b00,c48+=c32>>>16,c32&=65535,c32+=a16*b16,c48+=c32>>>16,c32&=65535,c32+=a00*b32,c48+=c32>>>16,c32&=65535,c48+=a48*b00+a32*b16+a16*b32+a00*b48,c48&=65535,Timestamp.fromBits(c16<<16|c00,c48<<16|c32)},Timestamp.prototype.div=function(other){if(other.isZero())throw Error("division by zero");if(this.isZero())return Timestamp.ZERO;if(this.equals(Timestamp.MIN_VALUE)){if(other.equals(Timestamp.ONE)||other.equals(Timestamp.NEG_ONE))return Timestamp.MIN_VALUE;if(other.equals(Timestamp.MIN_VALUE))return Timestamp.ONE;var halfThis=this.shiftRight(1),approx=halfThis.div(other).shiftLeft(1);if(approx.equals(Timestamp.ZERO))return other.isNegative()?Timestamp.ONE:Timestamp.NEG_ONE;var rem=this.subtract(other.multiply(approx)),result=approx.add(rem.div(other));return result}if(other.equals(Timestamp.MIN_VALUE))return Timestamp.ZERO;if(this.isNegative())return other.isNegative()?this.negate().div(other.negate()):this.negate().div(other).negate();if(other.isNegative())return this.div(other.negate()).negate();for(var res=Timestamp.ZERO,rem=this;rem.greaterThanOrEqual(other);){for(var approx=Math.max(1,Math.floor(rem.toNumber()/other.toNumber())),log2=Math.ceil(Math.log(approx)/Math.LN2),delta=48>=log2?1:Math.pow(2,log2-48),approxRes=Timestamp.fromNumber(approx),approxRem=approxRes.multiply(other);approxRem.isNegative()||approxRem.greaterThan(rem);)approx-=delta,approxRes=Timestamp.fromNumber(approx),approxRem=approxRes.multiply(other);approxRes.isZero()&&(approxRes=Timestamp.ONE),res=res.add(approxRes),rem=rem.subtract(approxRem)}return res},Timestamp.prototype.modulo=function(other){return this.subtract(this.div(other).multiply(other))},Timestamp.prototype.not=function(){return Timestamp.fromBits(~this.low_,~this.high_)},Timestamp.prototype.and=function(other){return Timestamp.fromBits(this.low_&other.low_,this.high_&other.high_)},Timestamp.prototype.or=function(other){return Timestamp.fromBits(this.low_|other.low_,this.high_|other.high_)},Timestamp.prototype.xor=function(other){return Timestamp.fromBits(this.low_^other.low_,this.high_^other.high_)},Timestamp.prototype.shiftLeft=function(numBits){if(numBits&=63,0==numBits)return this;var low=this.low_;if(32>numBits){var high=this.high_;return Timestamp.fromBits(low<<numBits,high<<numBits|low>>>32-numBits)}return Timestamp.fromBits(0,low<<numBits-32)},Timestamp.prototype.shiftRight=function(numBits){if(numBits&=63,0==numBits)return this;var high=this.high_;if(32>numBits){var low=this.low_;return Timestamp.fromBits(low>>>numBits|high<<32-numBits,high>>numBits)}return Timestamp.fromBits(high>>numBits-32,high>=0?0:-1)},Timestamp.prototype.shiftRightUnsigned=function(numBits){if(numBits&=63,0==numBits)return this;var high=this.high_;if(32>numBits){var low=this.low_;return Timestamp.fromBits(low>>>numBits|high<<32-numBits,high>>>numBits)}return 32==numBits?Timestamp.fromBits(high,0):Timestamp.fromBits(high>>>numBits-32,0)},Timestamp.fromInt=function(value){if(value>=-128&&128>value){var cachedObj=Timestamp.INT_CACHE_[value];if(cachedObj)return cachedObj}var obj=new Timestamp(0|value,0>value?-1:0);return value>=-128&&128>value&&(Timestamp.INT_CACHE_[value]=obj),obj},Timestamp.fromNumber=function(value){return isNaN(value)||!isFinite(value)?Timestamp.ZERO:value<=-Timestamp.TWO_PWR_63_DBL_?Timestamp.MIN_VALUE:value+1>=Timestamp.TWO_PWR_63_DBL_?Timestamp.MAX_VALUE:0>value?Timestamp.fromNumber(-value).negate():new Timestamp(value%Timestamp.TWO_PWR_32_DBL_|0,value/Timestamp.TWO_PWR_32_DBL_|0)},Timestamp.fromBits=function(lowBits,highBits){return new Timestamp(lowBits,highBits)},Timestamp.fromString=function(str,opt_radix){if(0==str.length)throw Error("number format error: empty string");var radix=opt_radix||10;if(2>radix||radix>36)throw Error("radix out of range: "+radix);if("-"==str.charAt(0))return Timestamp.fromString(str.substring(1),radix).negate();if(str.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+str);for(var radixToPower=Timestamp.fromNumber(Math.pow(radix,8)),result=Timestamp.ZERO,i=0;i<str.length;i+=8){var size=Math.min(8,str.length-i),value=parseInt(str.substring(i,i+size),radix);if(8>size){var power=Timestamp.fromNumber(Math.pow(radix,size));result=result.multiply(power).add(Timestamp.fromNumber(value))}else result=result.multiply(radixToPower),result=result.add(Timestamp.fromNumber(value))}return result},Timestamp.INT_CACHE_={},Timestamp.TWO_PWR_16_DBL_=65536,Timestamp.TWO_PWR_24_DBL_=1<<24,Timestamp.TWO_PWR_32_DBL_=Timestamp.TWO_PWR_16_DBL_*Timestamp.TWO_PWR_16_DBL_,Timestamp.TWO_PWR_31_DBL_=Timestamp.TWO_PWR_32_DBL_/2,Timestamp.TWO_PWR_48_DBL_=Timestamp.TWO_PWR_32_DBL_*Timestamp.TWO_PWR_16_DBL_,Timestamp.TWO_PWR_64_DBL_=Timestamp.TWO_PWR_32_DBL_*Timestamp.TWO_PWR_32_DBL_,Timestamp.TWO_PWR_63_DBL_=Timestamp.TWO_PWR_64_DBL_/2,Timestamp.ZERO=Timestamp.fromInt(0),Timestamp.ONE=Timestamp.fromInt(1),Timestamp.NEG_ONE=Timestamp.fromInt(-1),Timestamp.MAX_VALUE=Timestamp.fromBits(-1,2147483647),Timestamp.MIN_VALUE=Timestamp.fromBits(0,-2147483648),Timestamp.TWO_PWR_24_=Timestamp.fromInt(1<<24),exports.Timestamp=Timestamp},{}],64:[function(require,module,exports){module.exports=exports=require("./lib")},{"./lib":65}],65:[function(require,module,exports){function K(v){return v}exports.get=function(path,o,special,map){"function"==typeof special&&(map=special,special=void 0),map||(map=K);var parts="string"==typeof path?path.split("."):path;if(!Array.isArray(parts))throw new TypeError("Invalid `path`. Must be either string or array");for(var part,obj=o,i=0;i<parts.length;++i){if(part=parts[i],Array.isArray(obj)&&!/^\d+$/.test(part)){var paths=parts.slice(i);return obj.map(function(item){return item?exports.get(paths,item,special,map):map(void 0)})}if(obj=special&&obj[special]?obj[special][part]:obj[part],!obj)return map(obj)}return map(obj)},exports.set=function(path,val,o,special,map,_copying){"function"==typeof special&&(map=special,special=void 0),map||(map=K);var parts="string"==typeof path?path.split("."):path;if(!Array.isArray(parts))throw new TypeError("Invalid `path`. Must be either string or array");if(null!=o){for(var part,copy=_copying||/\$/.test(path),obj=o,i=0,len=parts.length-1;len>i;++i)if(part=parts[i],"$"!=part){if(Array.isArray(obj)&&!/^\d+$/.test(part)){var paths=parts.slice(i);if(!copy&&Array.isArray(val))for(var j=0;j<obj.length&&j<val.length;++j)exports.set(paths,val[j],obj[j],special,map,copy);else for(var j=0;j<obj.length;++j)exports.set(paths,val,obj[j],special,map,copy);return}if(obj=special&&obj[special]?obj[special][part]:obj[part],!obj)return}else if(i==len-1)break;if(part=parts[len],special&&obj[special]&&(obj=obj[special]),Array.isArray(obj)&&!/^\d+$/.test(part))if(!copy&&Array.isArray(val))for(var item,j=0;j<obj.length&&j<val.length;++j)item=obj[j],item&&(item[special]&&(item=item[special]),item[part]=map(val[j]));else for(var j=0;j<obj.length;++j)item=obj[j],item&&(item[special]&&(item=item[special]),item[part]=map(val));else obj[part]=map(val)}}},{}],66:[function(require,module,exports){module.exports=exports=require("./lib/promise")},{"./lib/promise":67}],67:[function(require,module){(function(process){"use strict";function Promise(back){EventEmitter.call(this),this.emitted={},this.ended=!1,"function"==typeof back&&this.onResolve(back)}function handler(retPromise,fn){return function(){var args=arguments;process.nextTick(function(){retPromise.domain&&retPromise.domain!==process.domain&&retPromise.domain.enter();var x;try{x=fn.apply(void 0,args)}catch(err){if(retPromise.ended&&!retPromise.hasRejectListeners())throw err;return retPromise.reject(err)}resolve(retPromise,x)})}}function resolve(promise,x){var then,type,done,reject_,resolve_;if(type=typeof x,"undefined"==type)return promise.fulfill(x);if(promise===x)return promise.reject(new TypeError("promise and x are the same"));if(null!=x&&("object"==type||"function"==type)){try{then=x.then}catch(err){if(promise.ended&&!promise.hasRejectListeners())throw err;return promise.reject(err)}if("function"==typeof then)try{return resolve_=function(){var args=slice(arguments);resolve.apply(this,[promise].concat(args))},reject_=promise.reject.bind(promise),done=!1,then.call(x,function(){return done?void 0:(done=!0,resolve_.apply(this,arguments))},function(){return done?void 0:(done=!0,reject_.apply(this,arguments))})}catch(err){if(done)return;if(done=!0,promise.ended)throw err;return promise.reject(err)}}promise.fulfill(x)}var slice=function(arr,start,end){return Array.prototype.slice.call(arr,start,end)},EventEmitter=require("events").EventEmitter;Promise.SUCCESS="fulfill",Promise.FAILURE="reject",Promise.prototype.__proto__=EventEmitter.prototype,Promise.prototype.on=function(event,callback){return this.emitted[event]?callback.apply(this,this.emitted[event]):EventEmitter.prototype.on.call(this,event,callback),this},Promise.prototype.emit=function(event){var success=this.constructor.SUCCESS,failure=this.constructor.FAILURE;if(event==success||event==failure){if(this.emitted[success]||this.emitted[failure])return this;this.emitted[event]=slice(arguments,1)}return EventEmitter.prototype.emit.apply(this,arguments)},Promise.prototype.fulfill=function(){var args=slice(arguments);return this.emit.apply(this,[this.constructor.SUCCESS].concat(args))},Promise.prototype.reject=function(reason){return this.emit(this.constructor.FAILURE,reason)},Promise.prototype.resolve=function(err,val){return err?this.reject(err):this.fulfill(val)},Promise.prototype.onFulfill=function(fn){if(!fn)return this;if("function"!=typeof fn)throw new TypeError("fn should be a function");return this.on(this.constructor.SUCCESS,fn)},Promise.prototype.hasRejectListeners=function(){return this.listeners(this.constructor.FAILURE).length>0},Promise.prototype.onReject=function(fn){if(!fn)return this;if("function"!=typeof fn)throw new TypeError("fn should be a function");return this.on(this.constructor.FAILURE,fn)},Promise.prototype.onResolve=function(fn){if(!fn)return this;if("function"!=typeof fn)throw new TypeError("fn should be a function");return this.on(this.constructor.FAILURE,function(err){fn.apply(this,[err])}),this.on(this.constructor.SUCCESS,function(){var args=slice(arguments);fn.apply(this,[null].concat(args))}),this},Promise.prototype.then=function(onFulfill,onReject){var self=this,retPromise=new Promise;return self.onReject("function"==typeof onReject?handler(retPromise,onReject):retPromise.reject.bind(retPromise)),self.onFulfill("function"==typeof onFulfill?handler(retPromise,onFulfill):retPromise.fulfill.bind(retPromise)),retPromise},Promise.prototype.end=function(onReject){return this.onReject(onReject),this.ended=!0,this},Promise.trace=function(p,name){p.then(function(){console.log("%s fulfill %j",name,slice(arguments))},function(){console.log("%s reject %j",name,slice(arguments))})},Promise.prototype.chain=function(p2){var p1=this;return p1.onFulfill(p2.fulfill.bind(p2)),p1.onReject(p2.reject.bind(p2)),p2},Promise.deferred=function(){var p=new Promise;return{promise:p,reject:p.reject.bind(p),fulfill:p.fulfill.bind(p),callback:p.resolve.bind(p)}},Promise.prototype.all=function(promiseOfArr){var pRet=new Promise;return this.then(promiseOfArr).then(function(promiseArr){var errSentinel,count=0,ret=[];return promiseArr.length||pRet.resolve(),promiseArr.forEach(function(promise,index){errSentinel||(count++,promise.then(function(val){errSentinel||(ret[index]=val,--count,0==count&&pRet.fulfill(ret))},function(err){errSentinel||(errSentinel=err,pRet.reject(err))}))}),pRet},pRet.reject.bind(pRet)),pRet},Promise.hook=function(arr){var p1=new Promise,pFinal=new Promise,signalP=function(){return--count,0==count&&pFinal.fulfill(),pFinal},count=1,ps=p1;return arr.forEach(function(hook){ps=ps.then(function(){var p=new Promise;return count++,hook(p.resolve.bind(p),signalP),p})}),ps=ps.then(signalP),p1.resolve(),ps},module.exports=Promise}).call(this,require("_process"))},{_process:8,events:6}],68:[function(require,module){!function(g){function ms(s){return s==Number(s)?Number(s):(r.exec(s.toLowerCase()),RegExp.$1*_[RegExp.$2])}var r=/(\d*.?\d+)([mshd]+)/,_={};_.ms=1,_.s=1e3,_.m=60*_.s,_.h=60*_.m,_.d=24*_.h,g.top?g.ms=ms:module.exports=ms}(this)},{}],69:[function(require,module,exports){function isRegExp(o){return"object"==typeof o&&"[object RegExp]"==toString.call(o)}var toString=Object.prototype.toString;module.exports=exports=function(regexp){if(!isRegExp(regexp))throw new TypeError("Not a RegExp");var flags=[];return regexp.global&&flags.push("g"),regexp.multiline&&flags.push("m"),regexp.ignoreCase&&flags.push("i"),new RegExp(regexp.source,flags.join(""))}},{}],70:[function(require,module,exports){module.exports=exports=require("./lib/sliced")},{"./lib/sliced":71}],71:[function(require,module){module.exports=function(args,slice,sliceEnd){var ret=[],len=args.length;if(0===len)return ret;var start=0>slice?Math.max(0,slice+len):slice||0;for(void 0!==sliceEnd&&(len=0>sliceEnd?sliceEnd+len:sliceEnd);len-->start;)ret[len-start]=args[len];return ret}},{}]},{},[1]);